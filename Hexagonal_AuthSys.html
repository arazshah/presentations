<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آموزش کامل معماری هگزاگونال در پایتون</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .nav {
            background: #34495e;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 4rem;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            border-right: 5px solid #3498db;
            padding-right: 1rem;
            position: relative;
        }

        .section h3 {
            color: #34495e;
            font-size: 1.5rem;
            margin: 2rem 0 1rem 0;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }

        .section h4 {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin: 1.5rem 0 1rem 0;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
            border: 1px solid #34495e;
        }

        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 0.5rem;
            left: 1rem;
            background: #3498db;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .code-block pre {
            margin-top: 2rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-right: 5px solid #3498db;
        }

        .architecture-diagram {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            text-align: center;
            border: 2px dashed #3498db;
        }

        .layer {
            background: white;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .layer:hover {
            transform: translateY(-5px);
        }

        .layer-adapters { border-right: 5px solid #e74c3c; }
        .layer-ports { border-right: 5px solid #f39c12; }
        .layer-domain { border-right: 5px solid #27ae60; }

        .file-tree {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 1rem 0;
            border: 1px solid #dee2e6;
        }

        .benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .benefit-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .benefit-card:hover {
            transform: translateY(-10px);
        }

        .benefit-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-right: 5px solid #f39c12;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-right: 5px solid #27ae60;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-right: 5px solid #e74c3c;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        .toc {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin: 0.5rem 0;
        }

        .toc a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #2980b9;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .nav ul {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .benefits {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🏗️ آموزش کامل معماری هگزاگونال</h1>
            <p>پیاده‌سازی سیستم احراز هویت با Hexagonal Architecture در پایتون</p>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <ul>
                <li><a href="#introduction">🎯 مقدمه</a></li>
                <li><a href="#principles">⚖️ اصول</a></li>
                <li><a href="#design">🎨 طراحی</a></li>
                <li><a href="#implementation">💻 پیاده‌سازی</a></li>
                <li><a href="#testing">🧪 تست</a></li>
                <li><a href="#best-practices">✨ بهترین روش‌ها</a></li>
            </ul>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Table of Contents -->
            <section class="toc">
                <h2>📚 فهرست مطالب</h2>
                <ul>
                    <li><a href="#introduction">1. مقدمه و مفاهیم پایه</a></li>
                    <li><a href="#principles">2. اصول معماری هگزاگونال</a></li>
                    <li><a href="#design">3. طراحی سیستم</a></li>
                    <li><a href="#implementation">4. پیاده‌سازی گام به گام</a></li>
                    <li><a href="#testing">5. تست‌نویسی</a></li>
                    <li><a href="#best-practices">6. بهترین روش‌ها</a></li>
                </ul>
            </section>

            <!-- Introduction -->
            <section id="introduction" class="section">
                <h2>🎯 مقدمه و مفاهیم پایه</h2>
                
                <h3>معماری هگزاگونال چیست؟</h3>
                <p>معماری هگزاگونال (که به آن <strong>Ports and Adapters</strong> هم می‌گویند) یک الگوی معماری است که توسط Alistair Cockburn معرفی شد. این معماری به ما کمک می‌کند تا:</p>

                <div class="benefits">
                    <div class="benefit-card">
                        <div class="icon">🎯</div>
                        <h4>جداسازی نگرانی‌ها</h4>
                        <p>منطق کسب‌وکار از جزئیات فنی جدا می‌شود</p>
                    </div>
                    <div class="benefit-card">
                        <div class="icon">🧪</div>
                        <h4>تست‌پذیری بالا</h4>
                        <p>هر بخش به‌طور مستقل قابل تست است</p>
                    </div>
                    <div class="benefit-card">
                        <div class="icon">🔄</div>
                        <h4>انعطاف‌پذیری</h4>
                        <p>تغییر فناوری‌ها بدون تأثیر بر منطق اصلی</p>
                    </div>
                    <div class="benefit-card">
                        <div class="icon">🛠️</div>
                        <h4>نگهداری آسان</h4>
                        <p>کد تمیز و قابل فهم</p>
                    </div>
                </div>

                <h3>چرا شش‌ضلعی؟</h3>
                <div class="architecture-diagram">
                    <h4>نمای کلی معماری</h4>
                    <div class="layer layer-adapters">
                        <strong>🔌 ADAPTERS</strong> - پیاده‌سازی‌های واقعی (Database, Web, CLI)
                    </div>
                    <div style="text-align: center; margin: 1rem 0;">⬇️ ⬆️</div>
                    <div class="layer layer-ports">
                        <strong>🚪 PORTS</strong> - رابط‌ها و قراردادها (Interfaces)
                    </div>
                    <div style="text-align: center; margin: 1rem 0;">⬇️ ⬆️</div>
                    <div class="layer layer-domain">
                        <strong>💎 DOMAIN</strong> - منطق کسب‌وکار خالص (Entities, Services)
                    </div>
                </div>
            </section>

            <!-- Principles -->
            <section id="principles" class="section">
                <h2>⚖️ اصول معماری هگزاگونال</h2>

                <h3>1. سه لایه اصلی</h3>

                <h4>Domain (هسته)</h4>
                <div class="code-block" data-lang="Python">
                    <pre># منطق کسب‌وکار خالص - بدون وابستگی خارجی
class User:
    def __init__(self, username: str, email: str):
        self.username = username
        self.email = email
    
    def change_email(self, new_email: str):
        if "@" not in new_email:
            raise ValueError("ایمیل نامعتبر")
        self.email = new_email</pre>
                </div>

                <h4>Ports (رابط‌ها)</h4>
                <div class="code-block" data-lang="Python">
                    <pre># رابط‌های انتزاعی
from abc import ABC, abstractmethod

class UserRepository(ABC):
    @abstractmethod
    def save(self, user: User) -> None:
        pass
    
    @abstractmethod
    def find_by_id(self, user_id: str) -> User:
        pass</pre>
                </div>

                <h4>Adapters (پیاده‌سازی‌ها)</h4>
                <div class="code-block" data-lang="Python">
                    <pre># پیاده‌سازی واقعی رابط‌ها
class DatabaseUserRepository(UserRepository):
    def save(self, user: User) -> None:
        # ذخیره در دیتابیس
        pass
    
    def find_by_id(self, user_id: str) -> User:
        # جستجو در دیتابیس
        pass</pre>
                </div>

                <h3>2. Dependency Inversion Principle</h3>
                <div class="highlight">
                    <strong>اصل وارونگی وابستگی:</strong> ماژول‌های سطح بالا نباید به ماژول‌های سطح پایین وابسته باشند. هر دو باید به انتزاعات وابسته باشند.
                </div>

                <div class="code-block" data-lang="Python">
                    <pre># ✅ معماری هگزاگونال - استقلال
class UserService:
    def __init__(self, user_repository: UserRepository):
        self.user_repository = user_repository  # وابستگی به interface
    
    def create_user(self, name, email):
        # فقط منطق کسب‌وکار
        if self.user_repository.find_by_email(email):
            raise UserAlreadyExistsError("User exists")
        return self.user_repository.save(User(name, email))</pre>
                </div>
            </section>

            <!-- Design -->
            <section id="design" class="section">
                <h2>🎨 طراحی سیستم</h2>

                <h3>ساختار کامل پروژه</h3>
                <div class="file-tree">
auth_system/
├── 📁 domain/                    # 🧠 منطق کسب‌وکار
│   ├── __init__.py
│   ├── entities.py               # موجودیت‌های اصلی
│   ├── value_objects.py          # اشیاء ارزشی
│   ├── services.py               # سرویس‌های دامنه
│   └── exceptions.py             # استثناهای دامنه
├── 📁 ports/                     # 🚪 رابط‌ها
│   ├── __init__.py
│   ├── repositories.py           # رابط‌های Repository
│   ├── auth_service.py           # رابط سرویس احراز هویت
│   └── notification.py           # رابط اعلان‌رسانی
├── 📁 adapters/                  # 🔌 پیاده‌سازی‌ها
│   ├── __init__.py
│   ├── repositories/             # Repository ها
│   │   ├── memory_repository.py
│   │   ├── file_repository.py
│   │   └── sqlite_repository.py
│   ├── services/                 # سرویس‌ها
│   │   └── auth_service_impl.py
│   └── ui/                       # رابط‌های کاربری
│       ├── cli_adapter.py
│       └── web_adapter.py
├── 📁 tests/                     # 🧪 تست‌ها
│   ├── unit/
│   ├── integration/
│   └── fixtures/
├── 📁 config/                    # ⚙️ تنظیمات
│   └── settings.py
├── requirements.txt
└── main.py
                </div>
            </section>

            <!-- Implementation -->
            <section id="implementation" class="section">
                <h2>💻 پیاده‌سازی گام به گام</h2>

                <h3>گام 1: Value Objects (اشیاء ارزشی)</h3>
                <div class="code-block" data-lang="Python">
                    <pre># domain/value_objects.py
from dataclasses import dataclass
import re

@dataclass(frozen=True)
class Email:
    """شیء ارزشی ایمیل"""
    value: str
    
    def __post_init__(self):
        if not self._is_valid():
            raise ValueError(f"ایمیل نامعتبر: {self.value}")
    
    def _is_valid(self) -> bool:
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        return re.match(pattern, self.value) is not None
    
    def __str__(self) -> str:
        return self.value

@dataclass(frozen=True)
class Username:
    """شیء ارزشی نام کاربری"""
    value: str
    
    def __post_init__(self):
        if not self._is_valid():
            raise ValueError(f"نام کاربری نامعتبر: {self.value}")
    
    def _is_valid(self) -> bool:
        # 3-20 کاراکتر، فقط حروف، اعداد و _
        pattern = r'^[a-zA-Z0-9_]{3,20}$'
        return re.match(pattern, self.value) is not None
    
    def __str__(self) -> str:
        return self.value</pre>
                </div>

                <h3>گام 2: Entities (موجودیت‌ها)</h3>
                <div class="code-block" data-lang="Python">
                    <pre># domain/entities.py
from dataclasses import dataclass, field
from datetime import datetime
from typing import Optional
import hashlib
import uuid

@dataclass
class User:
    """موجودیت کاربر"""
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    username: str = ""
    email: str = ""
    password_hash: str = ""
    created_at: datetime = field(default_factory=datetime.now)
    last_login: Optional[datetime] = None
    is_active: bool = True
    failed_login_attempts: int = 0
    locked_until: Optional[datetime] = None
    
    @classmethod
    def create(cls, username: str, email: str, password: str) -> 'User':
        """ایجاد کاربر جدید"""
        return cls(
            username=username.lower().strip(),
            email=email.lower().strip(),
            password_hash=cls._hash_password(password)
        )
    
    @staticmethod
    def _hash_password(password: str) -> str:
        """هش کردن رمز عبور"""
        salt = "auth_system_salt_2024"
        return hashlib.pbkdf2_hmac('sha256', 
                                   password.encode('utf-8'), 
                                   salt.encode('utf-8'), 
                                   100000).hex()
    
    def verify_password(self, password: str) -> bool:
        """تأیید رمز عبور"""
        return self.password_hash == self._hash_password(password)
    
    def update_last_login(self) -> None:
        """به‌روزرسانی زمان آخرین ورود"""
        self.last_login = datetime.now()
        self.failed_login_attempts = 0
        self.locked_until = None</pre>
                </div>

                <h3>گام 3: Domain Services</h3>
                <div class="code-block" data-lang="Python">
                    <pre># domain/services.py
from datetime import datetime, timedelta
import secrets
from .entities import User, AuthToken
from .exceptions import *

class AuthDomainService:
    """سرویس‌های دامنه‌ای احراز هویت"""
    
    @staticmethod
    def create_user(username: str, email: str, password: str) -> User:
        """ایجاد کاربر جدید با اعتبارسنجی"""
        from .value_objects import Username, Email
        
        # اعتبارسنجی
        Username(username)  # خطا می‌دهد اگر نامعتبر باشد
        Email(email)        # خطا می‌دهد اگر نامعتبر باشد
        
        if len(password) < 8:
            raise WeakPasswordError("رمز عبور باید حداقل 8 کاراکتر باشد")
        
        return User.create(username, email, password)
    
    @staticmethod
    def authenticate_user(user: User, password: str) -> bool:
        """احراز هویت کاربر"""
        if not user.is_active:
            raise AuthenticationError("حساب کاربری غیرفعال است")
        
        if user.is_locked():
            raise AccountLockedError(user.locked_until)
        
        if not user.verify_password(password):
            user.increment_failed_login()
            raise AuthenticationError("نام کاربری یا رمز عبور اشتباه است")
        
        user.update_last_login()
        return True</pre>
                </div>

                <h3>گام 4: Ports (رابط‌ها)</h3>
                <div class="code-block" data-lang="Python">
                    <pre># ports/repositories.py
from abc import ABC, abstractmethod
from typing import Optional, List
from domain.entities import User

class UserRepository(ABC):
    """رابط مخزن کاربران"""
    
    @abstractmethod
    def save(self, user: User) -> None:
        """ذخیره کاربر"""
        pass
    
    @abstractmethod
    def find_by_username(self, username: str) -> Optional[User]:
        """جستجو با نام کاربری"""
        pass
    
    @abstractmethod
    def find_by_email(self, email: str) -> Optional[User]:
        """جستجو با ایمیل"""
        pass
    
    @abstractmethod
    def exists_by_username(self, username: str) -> bool:
        """بررسی وجود نام کاربری"""
        pass</pre>
                </div>

                <h3>گام 5: Adapters (پیاده‌سازی‌ها)</h3>
                <div class="code-block" data-lang="Python">
                    <pre># adapters/repositories/memory_repository.py
from typing import Optional, Dict
from ports.repositories import UserRepository
from domain.entities import User

class InMemoryUserRepository(UserRepository):
    """پیاده‌سازی مخزن کاربران در حافظه"""
    
    def __init__(self):
        self._users: Dict[str, User] = {}
        self._username_index: Dict[str, str] = {}
        self._email_index: Dict[str, str] = {}
    
    def save(self, user: User) -> None:
        self._users[user.id] = user
        self._username_index[user.username] = user.id
        self._email_index[user.email] = user.id
    
    def find_by_username(self, username: str) -> Optional[User]:
        user_id = self._username_index.get(username.lower())
        return self._users.get(user_id) if user_id else None
    
    def find_by_email(self, email: str) -> Optional[User]:
        user_id = self._email_index.get(email.lower())
        return self._users.get(user_id) if user_id else None
    
    def exists_by_username(self, username: str) -> bool:
        return username.lower() in self._username_index</pre>
                </div>

                <h3>گام 6: CLI Adapter</h3>
                <div class="code-block" data-lang="Python">
                    <pre># adapters/ui/cli_adapter.py
from typing import Optional
from ports.auth_service import AuthService

class CLIAdapter:
    """رابط خط فرمان"""
    
    def __init__(self, auth_service: AuthService):
        self.auth_service = auth_service
        self.current_token: Optional[str] = None
    
    def run(self):
        """اجرای برنامه"""
        print("🔐 سیستم احراز هویت")
        print("=" * 30)
        
        while True:
            self.show_menu()
            choice = input("انتخاب شما: ").strip()
            
            if choice == "1":
                self.register()
            elif choice == "2":
                self.login()
            elif choice == "3":
                self.logout()
            elif choice == "4":
                print("خداحافظ! 👋")
                break
            else:
                print("❌ انتخاب نامعتبر")
    
    def show_menu(self):
        """نمایش منو"""
        status = "وارد شده ✅" if self.current_token else "خارج ❌"
        print(f"\nوضعیت: {status}")
        print("1. ثبت‌نام")
        print("2. ورود")
        print("3. خروج")
        print("4. خروج از برنامه")</pre>
                </div>

                <h3>گام 7: فایل اصلی</h3>
                <div class="code-block" data-lang="Python">
                    <pre># main.py
from adapters.repositories.memory_repository import InMemoryUserRepository
from adapters.services.auth_service_impl import AuthServiceImpl
from adapters.ui.cli_adapter import CLIAdapter

def main():
    """تابع اصلی برنامه"""
    # ایجاد dependencies
    user_repo = InMemoryUserRepository()
    
    # ایجاد سرویس احراز هویت
    auth_service = AuthServiceImpl(user_repo)
    
    # ایجاد رابط CLI
    cli = CLIAdapter(auth_service)
    
    # اجرای برنامه
    cli.run()

if __name__ == "__main__":
    main()</pre>
                </div>
            </section>

            <!-- Testing -->
            <section id="testing" class="section">
                <h2>🧪 تست‌نویسی</h2>

                <h3>تست Domain Layer</h3>
                <div class="code-block" data-lang="Python">
                    <pre># tests/unit/test_user_entity.py
import pytest
from datetime import datetime
from domain.entities import User
from domain.exceptions import WeakPasswordError

class TestUser:
    def test_create_user_success(self):
        """تست ایجاد موفق کاربر"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        assert user.username == "testuser"
        assert user.email == "test@example.com"
        assert```html
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آموزش کامل معماری هگزاگونال در پایتون</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .toc {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-right: 5px solid #667eea;
        }

        .toc h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            margin: 10px 0;
            padding-right: 20px;
        }

        .toc a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #667eea;
        }

        .section {
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .section h3 {
            color: #764ba2;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
        }

        .section h4 {
            color: #555;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
        }

        .code-block::before {
            content: "Python";
            position: absolute;
            top: 10px;
            left: 15px;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .code-block pre {
            margin-top: 30px;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-right: 5px solid #667eea;
        }

        .highlight h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .architecture-diagram {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .layer {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
        }

        .layer.adapters {
            background: #e74c3c;
        }

        .layer.ports {
            background: #f39c12;
        }

        .layer.domain {
            background: #27ae60;
        }

        .file-structure {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
        }

        .benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .benefit-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
            transition: transform 0.3s;
        }

        .benefit-card:hover {
            transform: translateY(-5px);
        }

        .benefit-card h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .emoji {
            font-size: 1.5em;
            margin-left: 10px;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .navigation {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .navigation a {
            display: block;
            padding: 8px 15px;
            color: #667eea;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px 0;
            transition: background 0.3s;
        }

        .navigation a:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .navigation {
                display: none;
            }
            
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .benefits {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="#introduction">🎯 مقدمه</a>
        <a href="#principles">⚖️ اصول</a>
        <a href="#design">🏗️ طراحی</a>
        <a href="#implementation">💻 پیاده‌سازی</a>
        <a href="#testing">🧪 تست</a>
        <a href="#improvements">🚀 بهبودها</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>🔐 آموزش کامل معماری هگزاگونال</h1>
            <p>پیاده‌سازی سیستم احراز هویت با پایتون خالص</p>
        </div>

        <div class="toc">
            <h2>📚 فهرست مطالب</h2>
            <ul>
                <li><a href="#introduction">1. مقدمه و مفاهیم پایه</a></li>
                <li><a href="#principles">2. اصول معماری هگزاگونال</a></li>
                <li><a href="#design">3. طراحی سیستم</a></li>
                <li><a href="#implementation">4. پیاده‌سازی کامل</a></li>
                <li><a href="#testing">5. تست‌نویسی</a></li>
                <li><a href="#improvements">6. بهبودها و توسعه</a></li>
            </ul>
        </div>

        <div class="section" id="introduction">
            <h2>🎯 مقدمه و مفاهیم پایه</h2>
            
            <h3>معماری هگزاگونال چیست؟</h3>
            <p>معماری هگزاگونال (که به آن <strong>Ports and Adapters</strong> هم می‌گویند) یک الگوی معماری است که توسط Alistair Cockburn معرفی شد. هدف اصلی آن جداسازی منطق کسب‌وکار از جزئیات فنی است.</p>

            <div class="architecture-diagram">
                <div class="layer adapters">🔌 ADAPTERS (جزئیات فنی)</div>
                <div style="margin: 10px 0;">↕️</div>
                <div class="layer ports">🚪 PORTS (رابط‌ها)</div>
                <div style="margin: 10px 0;">↕️</div>
                <div class="layer domain">💎 DOMAIN (هسته کسب‌وکار)</div>
            </div>

            <div class="benefits">
                <div class="benefit-card">
                    <h4><span class="emoji">✅</span>تست‌پذیری بالا</h4>
                    <p>منطق کسب‌وکار را بدون وابستگی‌های خارجی تست کنید</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">🔄</span>انعطاف‌پذیری</h4>
                    <p>تغییر فناوری‌های خارجی بدون تأثیر بر منطق اصلی</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">🧩</span>جداسازی نگرانی‌ها</h4>
                    <p>هر لایه مسئولیت مشخص و جداگانه‌ای دارد</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">🛠️</span>قابلیت نگهداری</h4>
                    <p>کد تمیز، منظم و قابل توسعه</p>
                </div>
            </div>

            <div class="highlight">
                <h4>💡 نکته مهم</h4>
                <p>شکل شش‌ضلعی فقط نمادین است و نشان می‌دهد که سیستم می‌تواند چندین ورودی و خروجی داشته باشد.</p>
            </div>
        </div>

        <div class="section" id="principles">
            <h2>⚖️ اصول معماری هگزاگونال</h2>

            <h3>سه لایه اصلی</h3>

            <h4>1. Domain (هسته) 💎</h4>
            <p>منطق کسب‌وکار خالص - بدون وابستگی خارجی</p>
            <div class="code-block">
                <pre><code># منطق کسب‌وکار خالص
class User:
    def __init__(self, username: str, email: str):
        self.username = username
        self.email = email
    
    def change_email(self, new_email: str):
        if "@" not in new_email:
            raise ValueError("ایمیل نامعتبر")
        self.email = new_email</code></pre>
            </div>

            <h4>2. Ports (رابط‌ها) 🚪</h4>
            <p>رابط‌های انتزاعی که قراردادهای ورودی و خروجی را تعریف می‌کنند</p>
            <div class="code-block">
                <pre><code>from abc import ABC, abstractmethod

class UserRepository(ABC):
    @abstractmethod
    def save(self, user: User) -> None:
        pass
    
    @abstractmethod
    def find_by_id(self, user_id: str) -> User:
        pass</code></pre>
            </div>

            <h4>3. Adapters (پیاده‌سازی‌ها) 🔌</h4>
            <p>پیاده‌سازی واقعی رابط‌ها</p>
            <div class="code-block">
                <pre><code>class DatabaseUserRepository(UserRepository):
    def save(self, user: User) -> None:
        # ذخیره در دیتابیس
        pass
    
    def find_by_id(self, user_id: str) -> User:
        # جستجو در دیتابیس
        pass</code></pre>
            </div>

            <div class="info">
                <strong>اصل Dependency Inversion:</strong> ماژول‌های سطح بالا نباید به ماژول‌های سطح پایین وابسته باشند. هر دو باید به انتزاعات وابسته باشند.
            </div>
        </div>

        <div class="section" id="design">
            <h2>🏗️ طراحی سیستم</h2>

            <h3>ساختار کامل پروژه</h3>
            <div class="file-structure">
auth_system/
├── 📁 domain/                    # 🎯 منطق کسب‌وکار
│   ├── __init__.py
│   ├── entities.py              # موجودیت‌ها
│   ├── services.py              # سرویس‌های دامنه
│   ├── exceptions.py            # خطاهای دامنه‌ای
│   └── value_objects.py         # اشیاء ارزشی
├── 📁 ports/                    # 🔌 رابط‌ها
│   ├── __init__.py
│   ├── repositories.py          # رابط‌های Repository
│   ├── auth_service.py          # رابط سرویس احراز هویت
│   └── notification.py          # رابط اعلان‌رسانی
├── 📁 adapters/                 # 🔧 پیاده‌سازی‌ها
│   ├── __init__.py
│   ├── repositories/            # Repository ها
│   │   ├── memory_repository.py
│   │   ├── file_repository.py
│   │   └── sqlite_repository.py
│   ├── services/                # سرویس‌ها
│   │   └── auth_service_impl.py
│   └── ui/                      # رابط‌های کاربری
│       ├── cli_adapter.py
│       └── web_adapter.py
├── 📁 tests/                    # 🧪 تست‌ها
│   ├── unit/
│   ├── integration/
│   └── fixtures/
├── 📁 config/                   # ⚙️ تنظیمات
│   └── settings.py
├── requirements.txt
└── main.py
            </div>

            <h3>نقشه معماری سیستم احراز هویت</h3>
            <div class="architecture-diagram">
                <div style="background: #3498db; color: white; padding: 10px; border-radius: 5px; margin: 5px;">
                    📱 CLI Interface
                </div>
                <div>↕️</div>
                <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 5px; margin: 5px;">
                    🔌 CLI Adapter
                </div>
                <div>↕️</div>
                <div style="background: #f39c12; color: white; padding: 10px; border-radius: 5px; margin: 5px;">
                    🚪 Auth Service Port
                </div>
                <div>↕️</div>
                <div style="background: #27ae60; color: white; padding: 15px; border-radius: 10px; margin: 10px;">
                    💎 DOMAIN LAYER<br>
                    • User Entity<br>
                    • Auth Token<br>
                    • Business Rules
                </div>
                <div>↕️</div>
                <div style="display: flex; justify-content: space-around;">
                    <div style="background: #f39c12; color: white; padding: 10px; border-radius: 5px;">
                        🚪 User Repo Port
                    </div>
                    <div style="background: #f39c12; color: white; padding: 10px; border-radius: 5px;">
                        🚪 Token Repo Port
                    </div>
                </div>
                <div>↕️</div>
                <div style="display: flex; justify-content: space-around;">
                    <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 5px;">
                        🔌 Memory Adapter
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 5px;">
                        🔌 File Adapter
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="implementation">
            <h2>💻 پیاده‌سازی کامل</h2>

            <h3>1. Domain Layer - موجودیت‌ها</h3>

            <h4>Value Objects (اشیاء ارزشی)</h4>
            <div class="code-block">
                <pre><code># domain/value_objects.py
from dataclasses import dataclass
import re

@dataclass(frozen=True)
class Email:
    """شیء ارزشی ایمیل"""
    value: str
    
    def __post_init__(self):
        if not self._is_valid():
            raise ValueError(f"ایمیل نامعتبر: {self.value}")
    
    def _is_valid(self) -> bool:
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        return re.match(pattern, self.value) is not None
    
    def __str__(self) -> str:
        return self.value

@dataclass(frozen=True)
class Username:
    """شیء ارزشی نام کاربری"""
    value: str
    
    def __post_init__(self):
        if not self._is_valid():
            raise ValueError(f"نام کاربری نامعتبر: {self.value}")
    
    def _is_valid(self) -> bool:
        # 3-20 کاراکتر، فقط حروف، اعداد و _
        pattern = r'^[a-zA-Z0-9_]{3,20}$'
        return re.match(pattern, self.value) is not None
    
    def __str__(self) -> str:
        return self.value</code></pre>
            </div>

            <h4>Entities (موجودیت‌ها)</h4>
            <div class="code-block">
                <pre><code># domain/entities.py
from dataclasses import dataclass, field
from datetime import datetime
from typing import Optional
import hashlib
import uuid

@dataclass
class User:
    """موجودیت کاربر"""
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    username: str = ""
    email: str = ""
    password_hash: str = ""
    created_at: datetime = field(default_factory=datetime.now)
    last_login: Optional[datetime] = None
    is_active: bool = True
    failed_login_attempts: int = 0
    locked_until: Optional[datetime] = None
    
    @classmethod
    def create(cls, username: str, email: str, password: str) -> 'User':
        """ایجاد کاربر جدید"""
        return cls(
            username=username.lower().strip(),
            email=email.lower().strip(),
            password_hash=cls._hash_password(password)
        )
    
    @staticmethod
    def _hash_password(password: str) -> str:
        """هش کردن رمز عبور"""
        salt = "auth_system_salt_2024"
        return hashlib.pbkdf2_hmac('sha256', 
                                   password.encode('utf-8'), 
                                   salt.encode('utf-8'), 
                                   100000).hex()
    
    def verify_password(self, password: str) -> bool:
        """تأیید رمز عبور"""
        return self.password_hash == self._hash_password(password)
    
    def update_last_login(self) -> None:
        """به‌روزرسانی زمان آخرین ورود"""
        self.last_login = datetime.now()
        self.failed_login_attempts = 0
        self.locked_until = None
    
    def is_locked(self) -> bool:
        """بررسی قفل بودن حساب"""
        if self.locked_until is None:
            return False
        return datetime.now() < self.locked_until</code></pre>
            </div>

            <h3>2. Ports - رابط‌ها</h3>
            <div class="code-block">
                <pre><code># ports/repositories.py
from abc import ABC, abstractmethod
from typing import Optional, List
from domain.entities import User, AuthToken

class UserRepository(ABC):
    """رابط مخزن کاربران"""
    
    @abstractmethod
    def save(self, user: User) -> None:
        """ذخیره کاربر"""
        pass
    
    @abstractmethod
    def find_by_username(self, username: str) -> Optional[User]:
        """جستجو با نام کاربری"""
        pass
    
    @abstractmethod
    def find_by_email(self, email: str) -> Optional[User]:
        """جستجو با ایمیل"""
        pass
    
    @abstractmethod
    def exists_by_username(self, username: str) -> bool:
        """بررسی وجود نام کاربری"""
        pass

class TokenRepository(ABC):
    """رابط مخزن توکن‌ها"""
    
    @abstractmethod
    def save(self, token: AuthToken) -> None:
        """ذخیره توکن"""
        pass
    
    @abstractmethod
    def find_by_token(self, token: str) -> Optional[AuthToken]:
        """جستجو با توکن"""
        pass
    
    @abstractmethod
    def delete(self, token: str) -> bool:
        """حذف توکن"""
        pass</code></pre>
            </div>

            <h3>3. Adapters - پیاده‌سازی Repository</h3>
            <div class="code-block">
                <pre><code># adapters/repositories/memory_repository.py
from typing import Optional, List, Dict
from ports.repositories import UserRepository, TokenRepository
from domain.entities import User, AuthToken

class InMemoryUserRepository(UserRepository):
    """پیاده‌سازی مخزن کاربران در حافظه"""
    
    def __init__(self):
        self._users: Dict[str, User] = {}
        self._username_index: Dict[str, str] = {}
        self._email_index: Dict[str, str] = {}
    
    def save(self, user: User) -> None:
        self._users[user.id] = user
        self._username_index[user.username] = user.id
        self._email_index[user.email] = user.id
    
    def find_by_username(self, username: str) -> Optional[User]:
        user_id = self._username_index.get(username.lower())
        return self._users.get(user_id) if user_id else None
    
    def find_by_email(self, email: str) -> Optional[User]:
        user_id = self._email_index.get(email.lower())
        return self._users.get(user_id) if user_id else None
    
    def exists_by_username(self, username: str) -> bool:
        return username.lower() in self._username_index</code></pre>
            </div>

            <h3>4. سرویس احراز هویت</h3>
            <div class="code-block">
                <pre><code># adapters/services/auth_service_impl.py
from typing import Optional
from ports.auth_service import AuthService
from ports.repositories import UserRepository, TokenRepository
from domain.entities import User, AuthToken
from domain.services import AuthDomainService
from domain.exceptions import *

class AuthServiceImpl(AuthService):
    """پیاده‌سازی سرویس احراز هویت"""
    
    def __init__(self, user_repo: UserRepository, token_repo: TokenRepository):
        self.user_repo = user_repo
        self.token_repo = token_repo
    
    def register(self, username: str, email: str, password: str) -> User:
        """ثبت‌نام کاربر جدید"""
        # بررسی وجود کاربر
        if self.user_repo.exists_by_username(username):
            raise UserAlreadyExistsError(f"کاربر {username} از قبل وجود دارد")
        
        if self.user_repo.find_by_email(email):
            raise UserAlreadyExistsError(f"ایمیل {email} از قبل استفاده شده")
        
        # ایجاد کاربر جدید
        user = AuthDomainService.create_user(username, email, password)
        self.user_repo.save(user)
        
        return user
    
    def login(self, username: str, password: str, ip_address: str = "unknown") -> AuthToken:
        """ورود کاربر"""
        user = self.user_repo.find_by_username(username)
        if not user:
            raise UserNotFoundError("کاربر یافت نشد")
        
        # احراز هویت
        if AuthDomainService.authenticate_user(user, password, ip_address):
            user.update_last_login()
            self.user_repo.save(user)
            
            # تولید توکن
            token = AuthDomainService.generate_token(user.id)
            self.token_repo.save(token)
            
            return token</code></pre>
            </div>

            <h3>5. رابط خط فرمان (CLI)</h3>
            <div class="code-block">
                <pre><code># adapters/ui/cli_adapter.py
from typing import Optional
from ports.auth_service import AuthService
from domain.exceptions import *

class CLIAdapter:
    """رابط خط فرمان"""
    
    def __init__(self, auth_service: AuthService):
        self.auth_service = auth_service
        self.current_token: Optional[str] = None
    
    def run(self):
        """اجرای برنامه"""
        print("🔐 سیستم احراز هویت")
        print("=" * 30)
        
        while True:
            self.show_menu()
            choice = input("انتخاب شما: ").strip()
            
            if choice == "1":
                self.register()
            elif choice == "2":
                self.login()
            elif choice == "3":
                self.logout()
            elif choice == "4":
                self.show_profile()
            elif choice == "5":
                print("خداحافظ! 👋")
                break
            else:
                print("❌ انتخاب نامعتبر")
    
    def show_menu(self):
        """نمایش منو"""
        status = "وارد شده ✅" if self.current_token else "خارج ❌"
        print(f"\nوضعیت: {status}")
        print("1. ثبت‌نام")
        print("2. ورود")
        print("3. خروج")
        print("4. نمایش پروفایل")
        print("5. خروج از برنامه")
    
    def register(self):
        """ثبت‌نام کاربر جدید"""
        try:
            print("\n📝 ثبت‌نام کاربر جدید")
            print("-" * 20)
            
            username = input("نام کاربری: ").strip()
            email = input("ایمیل: ").strip()
            password = input("رمز عبور: ").strip()
            
            user = self.auth_service.register(username, email, password)
            print(f"✅ کاربر {user.username} با موفقیت ثبت شد!")
            
        except (UserAlreadyExistsError, ValidationError, WeakPasswordError) as e:
            print(f"❌ خطا: {e}")
        except Exception as e:
            print(f"❌ خطای غیرمنتظره: {e}")
    
    def login(self):
        """ورود کاربر"""
        try:
            print("\n🔑 ورود کاربر")
            print("-" * 15)
            
            username = input("نام کاربری: ").strip()
            password = input("رمز عبور: ").strip()
            
            token = self.auth_service.login(username, password)
            self.current_token = token.token
            print(f"✅ ورود موفق! خوش آمدید {username}")
            
        except (UserNotFoundError, AuthenticationError, AccountLockedError) as e:
            print(f"❌ خطا: {e}")
        except Exception as e:
            print(f"❌ خطای غیرمنتظره: {e}")
    
    def logout(self):
        """خروج کاربر"""
        if not self.current_token:
            print("❌ شما وارد نشده‌اید!")
            return
        
        try:
            self.auth_service.logout(self.current_token)
            self.current_token = None
            print("✅ با موفقیت خارج شدید!")
        except Exception as e:
            print(f"❌ خطا در خروج: {e}")
    
    def show_profile(self):
        """نمایش پروفایل کاربر"""
        if not self.current_token:
            print("❌ ابتدا وارد شوید!")
            return
        
        try:
            user = self.auth_service.verify_token(self.current_token)
            if user:
                print("\n👤 پروفایل کاربر")
                print("-" * 15)
                print(f"نام کاربری: {user.username}")
                print(f"ایمیل: {user.email}")
                print(f"تاریخ ثبت‌نام: {user.created_at}")
                print(f"آخرین ورود: {user.last_login or 'هرگز'}")
            else:
                print("❌ توکن نامعتبر!")
                self.current_token = None
        except Exception as e:
            print(f"❌ خطا: {e}")
</code></pre>
            </div>

            <h3>6. فایل اصلی برنامه</h3>
            <div class="code-block">
                <pre><code># main.py
from adapters.repositories.memory_repository import (
    InMemoryUserRepository, 
    InMemoryTokenRepository
)
from adapters.services.auth_service_impl import AuthServiceImpl
from adapters.ui.cli_adapter import CLIAdapter

def main():
    """تابع اصلی برنامه"""
    print("🚀 راه‌اندازی سیستم احراز هویت...")
    
    # ایجاد dependencies
    user_repo = InMemoryUserRepository()
    token_repo = InMemoryTokenRepository()
    
    # ایجاد سرویس احراز هویت
    auth_service = AuthServiceImpl(user_repo, token_repo)
    
    # ایجاد رابط CLI
    cli = CLIAdapter(auth_service)
    
    # اجرای برنامه
    try:
        cli.run()
    except KeyboardInterrupt:
        print("\n\n👋 برنامه متوقف شد!")
    except Exception as e:
        print(f"\n❌ خطای غیرمنتظره: {e}")

if __name__ == "__main__":
    main()
</code></pre>
            </div>
        </div>

        <div class="section" id="testing">
            <h2>🧪 تست‌نویسی</h2>

            <h3>تست Domain Layer</h3>
            <div class="code-block">
                <pre><code># tests/unit/test_user_entity.py
import pytest
from datetime import datetime, timedelta
from domain.entities import User
from domain.exceptions import WeakPasswordError

class TestUser:
    def test_create_user_success(self):
        """تست ایجاد موفق کاربر"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        assert user.username == "testuser"
        assert user.email == "test@example.com"
        assert user.is_active is True
        assert user.failed_login_attempts == 0
    
    def test_verify_password_correct(self):
        """تست تأیید رمز عبور صحیح"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        assert user.verify_password("StrongPass123") is True
    
    def test_verify_password_incorrect(self):
        """تست تأیید رمز عبور اشتباه"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        assert user.verify_password("WrongPassword") is False
    
    def test_user_lock_after_failed_attempts(self):
        """تست قفل شدن حساب بعد از تلاش‌های ناموفق"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        # 5 تلاش ناموفق
        for _ in range(5):
            user.increment_failed_login()
        
        assert user.is_locked() is True
        assert user.locked_until is not None
    
    def test_successful_login_resets_attempts(self):
        """تست ریست شدن تلاش‌های ناموفق بعد از ورود موفق"""
        user = User.create("testuser", "test@example.com", "StrongPass123")
        
        # چند تلاش ناموفق
        user.increment_failed_login()
        user.increment_failed_login()
        
        # ورود موفق
        user.update_last_login()
        
        assert user.failed_login_attempts == 0
        assert user.locked_until is None
        assert user.last_login is not None
</code></pre>
            </div>

            <h3>تست Value Objects</h3>
            <div class="code-block">
                <pre><code># tests/unit/test_value_objects.py
import pytest
from domain.value_objects import Email, Username
from domain.exceptions import ValidationError

class TestEmail:
    def test_valid_email(self):
        """تست ایمیل معتبر"""
        email = Email("test@example.com")
        assert str(email) == "test@example.com"
    
    def test_invalid_email_no_at(self):
        """تست ایمیل بدون @"""
        with pytest.raises(ValueError):
            Email("testexample.com")
    
    def test_invalid_email_no_domain(self):
        """تست ایمیل بدون دامین"""
        with pytest.raises(ValueError):
            Email("test@")
    
    def test_invalid_email_no_extension(self):
        """تست ایمیل بدون پسوند"""
        with pytest.raises(ValueError):
            Email("test@example")

class TestUsername:
    def test_valid_username(self):
        """تست نام کاربری معتبر"""
        username = Username("testuser123")
        assert str(username) == "testuser123"
    
    def test_username_too_short(self):
        """تست نام کاربری کوتاه"""
        with pytest.raises(ValueError):
            Username("ab")
    
    def test_username_too_long(self):
        """تست نام کاربری طولانی"""
        with pytest.raises(ValueError):
            Username("a" * 25)
    
    def test_username_invalid_characters(self):
        """تست نام کاربری با کاراکترهای نامعتبر"""
        with pytest.raises(ValueError):
            Username("test-user")
        
        with pytest.raises(ValueError):
            Username("test user")
</code></pre>
            </div>

            <h3>تست Repository ها</h3>
            <div class="code-block">
                <pre><code># tests/unit/test_repositories.py
import pytest
from adapters.repositories.memory_repository import InMemoryUserRepository
from domain.entities import User

class TestInMemoryUserRepository:
    def setup_method(self):
        """راه‌اندازی برای هر تست"""
        self.repo = InMemoryUserRepository()
        self.user = User.create("testuser", "test@example.com", "password123")
    
    def test_save_and_find_by_username(self):
        """تست ذخیره و جستجو با نام کاربری"""
        self.repo.save(self.user)
        
        found_user = self.repo.find_by_username("testuser")
        assert found_user is not None
        assert found_user.username == "testuser"
    
    def test_find_by_email(self):
        """تست جستجو با ایمیل"""
        self.repo.save(self.user)
        
        found_user = self.repo.find_by_email("test@example.com")
        assert found_user is not None
        assert found_user.email == "test@example.com"
    
    def test_exists_by_username(self):
        """تست بررسی وجود نام کاربری"""
        self.repo.save(self.user)
        
        assert self.repo.exists_by_username("testuser") is True
        assert self.repo.exists_by_username("nonexistent") is False
    
    def test_user_not_found(self):
        """تست عدم یافت کاربر"""
        found_user = self.repo.find_by_username("nonexistent")
        assert found_user is None
</code></pre>
            </div>

            <h3>تست Integration</h3>
            <div class="code-block">
                <pre><code># tests/integration/test_auth_service.py
import pytest
from adapters.repositories.memory_repository import (
    InMemoryUserRepository, 
    InMemoryTokenRepository
)
from adapters.services.auth_service_impl import AuthServiceImpl
from domain.exceptions import *

class TestAuthServiceIntegration:
    def setup_method(self):
        """راه‌اندازی برای هر تست"""
        self.user_repo = InMemoryUserRepository()
        self.token_repo = InMemoryTokenRepository()
        self.auth_service = AuthServiceImpl(self.user_repo, self.token_repo)
    
    def test_complete_registration_flow(self):
        """تست فرآیند کامل ثبت‌نام"""
        # ثبت‌نام
        user = self.auth_service.register(
            "testuser", 
            "test@example.com", 
            "StrongPass123"
        )
        
        assert user.username == "testuser"
        assert user.email == "test@example.com"
        
        # بررسی ذخیره در repository
        saved_user = self.user_repo.find_by_username("testuser")
        assert saved_user is not None
    
    def test_complete_login_flow(self):
        """تست فرآیند کامل ورود"""
        # ثبت‌نام
        self.auth_service.register(
            "testuser", 
            "test@example.com", 
            "StrongPass123"
        )
        
        # ورود
        token = self.auth_service.login("testuser", "StrongPass123")
        
        assert token is not None
        assert token.token is not None
        
        # تأیید توکن
        user = self.auth_service.verify_token(token.token)
        assert user is not None
        assert user.username == "testuser"
    
    def test_duplicate_username_registration(self):
        """تست ثبت‌نام با نام کاربری تکراری"""
        # ثبت‌نام اول
        self.auth_service.register(
            "testuser", 
            "test1@example.com", 
            "StrongPass123"
        )
        
        # ثبت‌نام دوم با همان نام کاربری
        with pytest.raises(UserAlreadyExistsError):
            self.auth_service.register(
                "testuser", 
                "test2@example.com", 
                "StrongPass123"
            )
    
    def test_login_with_wrong_password(self):
        """تست ورود با رمز عبور اشتباه"""
        # ثبت‌نام
        self.auth_service.register(
            "testuser", 
            "test@example.com", 
            "StrongPass123"
        )
        
        # ورود با رمز اشتباه
        with pytest.raises(AuthenticationError):
            self.auth_service.login("testuser", "WrongPassword")
</code></pre>
            </div>

            <div class="success">
                <h4>✅ اجرای تست‌ها</h4>
                <p>برای اجرای تست‌ها دستور زیر را اجرا کنید:</p>
                <code>pytest tests/ -v --tb=short</code>
            </div>
        </div>

        <div class="section" id="improvements">
            <h2>🚀 بهبودها و توسعه</h2>

            <h3>1. پیاده‌سازی SQLite Repository</h3>
            <div class="code-block">
                <pre><code># adapters/repositories/sqlite_repository.py
import sqlite3
import json
from typing import Optional
from datetime import datetime
from ports.repositories import UserRepository
from domain.entities import User

class SQLiteUserRepository(UserRepository):
    """پیاده‌سازی SQLite برای مخزن کاربران"""
    
    def __init__(self, db_path: str = "auth_system.db"):
        self.db_path = db_path
        self._init_database()
    
    def _init_database(self):
        """ایجاد جداول دیتابیس"""
        with sqlite3.connect(self.db_path) as conn:
            conn.execute("""
                CREATE TABLE IF NOT EXISTS users (
                    id TEXT PRIMARY KEY,
                    username TEXT UNIQUE NOT NULL,
                    email TEXT UNIQUE NOT NULL,
                    password_hash TEXT NOT NULL,
                    created_at TEXT NOT NULL,
                    last_login TEXT,
                    is_active BOOLEAN DEFAULT 1,
                    failed_login_attempts INTEGER DEFAULT 0,
                    locked_until TEXT
                )
            """)
            conn.commit()
    
    def save(self, user: User) -> None:
        """ذخیره کاربر در دیتابیس"""
        with sqlite3.connect(self.db_path) as conn:
            conn.execute("""
                INSERT OR REPLACE INTO users 
                (id, username, email, password_hash, created_at, 
                 last_login, is_active, failed_login_attempts, locked_until)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                user.id,
                user.username,
                user.email,
                user.password_hash,
                user.created_at.isoformat(),
                user.last_login.isoformat() if user.last_login else None,
                user.is_active,
                user.failed_login_attempts,
                user.locked_until.isoformat() if user.locked_until else None
            ))
            conn.commit()
    
    def find_by_username(self, username: str) -> Optional[User]:
        """جستجوی کاربر با نام کاربری"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.execute(
                "SELECT * FROM users WHERE username = ?", 
                (username.lower(),)
            )
            row = cursor.fetchone()
            
            if row:
                return self._row_to_user(row)
            return None
    
    def _row_to_user(self, row) -> User:
        """تبدیل سطر دیتابیس به شیء User"""
        return User(
            id=row[0],
            username=row[1],
            email=row[2],
            password_hash=row[3],
            created_at=datetime.fromisoformat(row[4]),
            last_login=datetime.fromisoformat(row[5]) if row[5] else None,
            is_active=bool(row[6]),
            failed_login_attempts=row[7],
            locked_until=datetime.fromisoformat(row[8]) if row[8] else None
        )
</code></pre>
            </div>

            <h3>2. پیاده‌سازی File Repository</h3>
            <div class="code-block">
                <pre><code># adapters/repositories/file_repository.py
import json
import os
from typing import Optional, Dict, Any
from datetime import datetime
from ports.repositories import UserRepository
from domain.entities import User

class FileUserRepository(UserRepository):
    """پیاده‌سازی فایل JSON برای مخزن کاربران"""
    
    def __init__(self, file_path: str = "users.json"):
        self.file_path = file_path
        self._ensure_file_exists()
    
    def _ensure_file_exists(self):
        """اطمینان از وجود فایل"""
        if not os.path.exists(self.file_path):
            with open(self.file_path, 'w', encoding='utf-8') as f:
                json.dump({}, f)
    
    def _load_users(self) -> Dict[str, Dict[str, Any]]:
        """بارگذاری کاربران از فایل"""
        try:
            with open(self.file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (json.JSONDecodeError, FileNotFoundError):
            return {}
    
    def _save_users(self, users: Dict[str, Dict[str, Any]]):
        """ذخیره کاربران در فایل"""
        with open(self.file_path, 'w', encoding='utf-8') as f:
            json.dump(users, f, indent=2, ensure_ascii=False, default=str)
    
    def save(self, user: User) -> None:
        """ذخیره کاربر"""
        users = self._load_users()
        users[user.id] = self._user_to_dict(user)
        self._save_users(users)
    
    def find_by_username(self, username: str) -> Optional[User]:
        """جستجو با نام کاربری"""
        users = self._load_users()
        for user_data in users.values():
            if user_data.get('username', '').lower() == username.lower():
                return self._dict_to_user(user_data)
        return None
    
    def _user_to_dict(self, user: User) -> Dict[str, Any]:
        """تبدیل User به dictionary"""
        return {
            'id': user.id,
            'username': user.username,
            'email': user.email,
            'password_hash': user.password_hash,
            'created_at': user.created_at.isoformat(),
            'last_login': user.last_login.isoformat() if user.last_login else None,
            'is_active': user.is_active,
            'failed_login_attempts': user.failed_login_attempts,
            'locked_until': user.locked_until.isoformat() if user.locked_until else None
        }
    
    def _dict_to_user(self, data: Dict[str, Any]) -> User:
        """تبدیل dictionary به User"""
        return User(
            id=data['id'],
            username=data['username'],
            email=data['email'],
            password_hash=data['password_hash'],
            created_at=datetime.fromisoformat(data['created_at']),
            last_login=datetime.fromisoformat(data['last_login']) if data['last_login'] else None,
            is_active=data['is_active'],
            failed_login_attempts=data['failed_login_attempts'],
            locked_until=datetime.fromisoformat(data['locked_until']) if data['locked_until'] else None
        )
</code></pre>
            </div>

            <h3>3. سیستم Configuration</h3>
            <div class="code-block">
                <pre><code># config/settings.py
from dataclasses import dataclass
from typing import Optional
import os

@dataclass
class DatabaseConfig:
    """تنظیمات دیتابیس"""
    type: str = "memory"  # memory, file, sqlite
    file_path: Optional[str] = None
    sqlite_path: Optional[str] = None

@dataclass
class SecurityConfig:
    """تنظیمات امنیتی"""
    password_salt: str = "auth_system_salt_2024"
    token_expiry_hours: int = 24
    max_login_attempts: int = 5
    lockout_duration_minutes: int = 15

@dataclass
class AppConfig:
    """تنظیمات کلی برنامه"""
    debug: bool = False
    log_level: str = "INFO"
    database: DatabaseConfig = DatabaseConfig()
    security: SecurityConfig = SecurityConfig()

def load_config() -> AppConfig:
    """بارگذاری تنظیمات از متغیرهای محیطی"""
    config = AppConfig()
    
    # تنظیمات دیتابیس
    config.database.type = os.getenv("DB_TYPE", "memory")
    config.database.file_path = os.getenv("DB_FILE_PATH", "users.json")
    config.database.sqlite_path = os.getenv("DB_SQLITE_PATH", "auth_system.db")
    
    # تنظیمات امنیتی
    config.security.password_salt = os.getenv("PASSWORD_SALT", config.security.password_salt)
    config.security.token_expiry_hours = int(os.getenv("TOKEN_EXPIRY_HOURS", "24"))
    config.security.max_login_attempts = int(os.getenv("MAX_LOGIN_ATTEMPTS", "5"))
    
    # تنظیمات عمومی
    config.debug = os.getenv("DEBUG", "false").lower() == "true"
    config.log_level = os.getenv("LOG_LEVEL", "INFO")
    
    return config
</code></pre>
            </div>

            <h3>4. Dependency Injection Container</h3>
            <div class="code-block">
                <pre><code># infrastructure/container.py
from typing import Dict, Any, Type
from config.settings import AppConfig, load_config
from ports.repositories import UserRepository, TokenRepository
from ports.auth_service import AuthService
from adapters.repositories.memory_repository import (
    InMemoryUserRepository, 
    InMemoryTokenRepository
)
from adapters.repositories.file_repository import FileUserRepository
from adapters.repositories.sqlite_repository import SQLiteUserRepository
from adapters.services.auth_service_impl import AuthServiceImpl

class Container:
    """کانتینر Dependency Injection"""
    
    def __init__(self):
        self._services: Dict[str, Any] = {}
        self._config = load_config()
    
    def get_config(self) -> AppConfig:
        """دریافت تنظیمات"""
        return self._config
    
    def get_user_repository(self) -> UserRepository:
        """دریافت User Repository"""
        if 'user_repository' not in self._services:
            db_type = self._config.database.type
            
            if db_type == "memory":
                self._services['user_repository'] = InMemoryUserRepository()
            elif db_type == "file":
                self._services['user_repository'] = FileUserRepository(
                    self._config.database.file_path
                )
            elif db_type == "sqlite":
                self._services['user_repository'] = SQLiteUserRepository(
                    self._config.database.sqlite_path
                )
            else:
                raise ValueError(f"نوع دیتابیس پشتیبانی نشده: {db_type}")
        
        return self._services['user_repository']
    
    def get_token_repository(self) -> TokenRepository:
        """دریافت Token Repository"""
        if 'token_repository' not in self._services:
            # فعلاً فقط memory
            self._services['token_repository'] = InMemoryTokenRepository()
        
        return self._services['token_repository']
    
    def get_auth_service(self) -> AuthService:
        """دریافت Auth Service"""
        if 'auth_service' not in self._services:
            user_repo = self.get_user_repository()
            token_repo = self.get_token_repository()
            self._services['auth_service'] = AuthServiceImpl(user_repo, token_repo)
        
        return self._services['auth_service']

# سینگلتون کانتینر
_container = None

def get_container() -> Container:
    """دریافت کانتینر سینگلتون"""
    global _container
    if _container is None:
        _container = Container()
    return _container
</code></pre>
            </div>

            <h3>5. بهبود فایل اصلی با Container</h3>
            <div class="code-block">
                <pre><code># main.py (نسخه بهبود یافته)
import logging
from infrastructure.container import get_container
from adapters.ui.cli_adapter import CLIAdapter

def setup_logging(config):
    """راه‌اندازی لاگ"""
    logging.basicConfig(
        level=getattr(logging, config.log_level),
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

def main():
    """تابع اصلی برنامه"""
    try:
        # دریافت کانتینر
        container = get_container()
        config = container.get_config()
        
        # راه‌اندازی لاگ
        setup_logging(config)
        logger = logging.getLogger(__name__)
        
        logger.info("🚀 راه‌اندازی سیستم احراز هویت...")
        logger.info(f"نوع دیتابیس: {config.database.type}")
        
        # دریافت سرویس‌ها از کانتینر
        auth_service = container.get_auth_service()
        
        # ایجاد رابط CLI
        cli = CLIAdapter(auth_service)
        
        # اجرای برنامه
        cli.run()
        
    except KeyboardInterrupt:
        print("\n\n👋 برنامه متوقف شد!")
    except Exception as e:
        logger.error(f"خطای غیرمنتظره: {e}")
        if config.debug:
            raise

if __name__ == "__main__":
    main()
</code></pre>
            </div>

            <h3>6. اضافه کردن Web Adapter</h3>
            <div class="code-block">
                <pre><code># adapters/ui/web_adapter.py (با Flask)
from flask import Flask, request, jsonify
from ports.auth_service import AuthService
from domain.exceptions import *

class WebAdapter:
    """رابط وب با Flask"""
    
    def __init__(self, auth_service: AuthService):
        self.auth_service = auth_service
        self.app = Flask(__name__)
        self._setup_routes()
    
    def _setup_routes(self):
        """تنظیم مسیرها"""
        
        @self.app.route('/api/register', methods=['POST'])
        def register():
            try:
                data = request.get_json()
                user = self.auth_service.register(
                    data['username'],
                    data['email'],
                    data['password']
                )
                return jsonify({
                    'success': True,
                    'user': {
                        'id': user.id,
                        'username': user.username,
                        'email': user.email
                    }
                })
            except (UserAlreadyExistsError, ValidationError) as e:
                return jsonify({'success': False, 'error': str(e)}), 400
            except Exception as e:
                return jsonify({'success': False, 'error': 'خطای سرور'}), 500
        
        @self.app.route('/api/login', methods=['POST'])
        def login():
            try:
                data = request.get_json()
                token = self.auth_service.login(
                    data['username'],
                    data['password'],
                    request.remote_addr
                )
                return jsonify({
                    'success': True,
                    'token': token.token
                })
            except (UserNotFoundError, AuthenticationError) as e:
                return jsonify({'success': False, 'error': str(e)}), 401
            except Exception as e:
                return jsonify({'success': False, 'error': 'خطای سرور'}), 500
        
        @self.app.route('/api/profile', methods=['GET'])
        def profile():
            try:
                token = request.headers.get('Authorization', '').replace('Bearer ', '')
                user = self.auth_service.verify_token(token)
                
                if not user:
                    return jsonify({'success': False, 'error': 'توکن نامعتبر'}), 401
                
                return jsonify({
                    'success': True,
                    'user': {
                      'id': user.id,
                        'username': user.username,
                        'email': user.email,
                        'created_at': user.created_at.isoformat(),
                        'last_login': user.last_login.isoformat() if user.last_login else None
                    }
                })
            except Exception as e:
                return jsonify({'success': False, 'error': 'خطای سرور'}), 500
    
    def run(self, host='127.0.0.1', port=5000, debug=False):
        """اجرای سرور وب"""
        self.app.run(host=host, port=port, debug=debug)
</code></pre>
            </div>

            <h3>7. اضافه کردن Logging و Monitoring</h3>
            <div class="code-block">
                <pre><code># infrastructure/logging.py
import logging
import json
from datetime import datetime
from typing import Dict, Any

class SecurityLogger:
    """لاگر امنیتی برای رویدادهای احراز هویت"""
    
    def __init__(self):
        self.logger = logging.getLogger('security')
        self.logger.setLevel(logging.INFO)
        
        # فرمت JSON برای لاگ‌ها
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        
        # فایل لاگ
        file_handler = logging.FileHandler('security.log')
        file_handler.setFormatter(formatter)
        self.logger.addHandler(file_handler)
    
    def log_login_attempt(self, username: str, ip_address: str, success: bool):
        """لاگ تلاش ورود"""
        event = {
            'event': 'login_attempt',
            'username': username,
            'ip_address': ip_address,
            'success': success,
            'timestamp': datetime.now().isoformat()
        }
        
        if success:
            self.logger.info(f"Successful login: {json.dumps(event)}")
        else:
            self.logger.warning(f"Failed login attempt: {json.dumps(event)}")
    
    def log_registration(self, username: str, email: str, ip_address: str):
        """لاگ ثبت‌نام"""
        event = {
            'event': 'user_registration',
            'username': username,
            'email': email,
            'ip_address': ip_address,
            'timestamp': datetime.now().isoformat()
        }
        self.logger.info(f"User registration: {json.dumps(event)}")
    
    def log_account_locked(self, username: str, ip_address: str):
        """لاگ قفل شدن حساب"""
        event = {
            'event': 'account_locked',
            'username': username,
            'ip_address': ip_address,
            'timestamp': datetime.now().isoformat()
        }
        self.logger.warning(f"Account locked: {json.dumps(event)}")
</code></pre>
            </div>

            <h3>8. اضافه کردن Metrics و Statistics</h3>
            <div class="code-block">
                <pre><code># infrastructure/metrics.py
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from typing import Dict, List
from collections import defaultdict

@dataclass
class AuthMetrics:
    """متریک‌های احراز هویت"""
    total_users: int = 0
    active_users: int = 0
    total_logins: int = 0
    failed_logins: int = 0
    locked_accounts: int = 0
    registrations_today: int = 0
    login_attempts_by_hour: Dict[int, int] = field(default_factory=lambda: defaultdict(int))
    failed_attempts_by_ip: Dict[str, int] = field(default_factory=lambda: defaultdict(int))

class MetricsCollector:
    """جمع‌آوری و نگهداری متریک‌ها"""
    
    def __init__(self):
        self.metrics = AuthMetrics()
        self.events: List[Dict] = []
    
    def record_login_attempt(self, username: str, ip_address: str, success: bool):
        """ثبت تلاش ورود"""
        hour = datetime.now().hour
        self.metrics.login_attempts_by_hour[hour] += 1
        
        if success:
            self.metrics.total_logins += 1
        else:
            self.metrics.failed_logins += 1
            self.metrics.failed_attempts_by_ip[ip_address] += 1
        
        # ثبت رویداد
        self.events.append({
            'type': 'login_attempt',
            'username': username,
            'ip_address': ip_address,
            'success': success,
            'timestamp': datetime.now()
        })
    
    def record_registration(self, username: str, email: str):
        """ثبت ثبت‌نام"""
        self.metrics.total_users += 1
        self.metrics.active_users += 1
        
        # بررسی ثبت‌نام امروز
        today = datetime.now().date()
        today_registrations = sum(1 for event in self.events 
                                if event['type'] == 'registration' 
                                and event['timestamp'].date() == today)
        self.metrics.registrations_today = today_registrations + 1
        
        # ثبت رویداد
        self.events.append({
            'type': 'registration',
            'username': username,
            'email': email,
            'timestamp': datetime.now()
        })
    
    def record_account_locked(self, username: str):
        """ثبت قفل شدن حساب"""
        self.metrics.locked_accounts += 1
        
        self.events.append({
            'type': 'account_locked',
            'username': username,
            'timestamp': datetime.now()
        })
    
    def get_suspicious_ips(self, threshold: int = 10) -> List[str]:
        """دریافت IP های مشکوک"""
        return [ip for ip, count in self.metrics.failed_attempts_by_ip.items() 
                if count >= threshold]
    
    def get_hourly_stats(self) -> Dict[int, int]:
        """آمار ساعتی تلاش‌های ورود"""
        return dict(self.metrics.login_attempts_by_hour)
    
    def export_metrics(self) -> Dict:
        """صادر کردن تمام متریک‌ها"""
        return {
            'total_users': self.metrics.total_users,
            'active_users': self.metrics.active_users,
            'total_logins': self.metrics.total_logins,
            'failed_logins': self.metrics.failed_logins,
            'locked_accounts': self.metrics.locked_accounts,
            'registrations_today': self.metrics.registrations_today,
            'suspicious_ips': self.get_suspicious_ips(),
            'hourly_login_attempts': self.get_hourly_stats()
        }
</code></pre>
            </div>

            <h3>9. CLI پیشرفته با Admin Panel</h3>
            <div class="code-block">
                <pre><code># adapters/ui/admin_cli.py
from typing import Optional
from ports.auth_service import AuthService
from infrastructure.metrics import MetricsCollector
from infrastructure.logging import SecurityLogger
import json

class AdminCLI:
    """رابط مدیریتی خط فرمان"""
    
    def __init__(self, auth_service: AuthService, metrics: MetricsCollector):
        self.auth_service = auth_service
        self.metrics = metrics
        self.logger = SecurityLogger()
    
    def run(self):
        """اجرای پنل مدیریت"""
        print("🔧 پنل مدیریت سیستم احراز هویت")
        print("=" * 40)
        
        while True:
            self.show_admin_menu()
            choice = input("انتخاب شما: ").strip()
            
            if choice == "1":
                self.show_system_stats()
            elif choice == "2":
                self.show_user_management()
            elif choice == "3":
                self.show_security_logs()
            elif choice == "4":
                self.show_suspicious_activities()
            elif choice == "5":
                self.export_data()
            elif choice == "6":
                print("خروج از پنل مدیریت 👋")
                break
            else:
                print("❌ انتخاب نامعتبر")
    
    def show_admin_menu(self):
        """نمایش منوی مدیریت"""
        print("\n📊 پنل مدیریت")
        print("-" * 20)
        print("1. آمار سیستم")
        print("2. مدیریت کاربران")
        print("3. لاگ‌های امنیتی")
        print("4. فعالیت‌های مشکوک")
        print("5. صادر کردن داده‌ها")
        print("6. خروج")
    
    def show_system_stats(self):
        """نمایش آمار سیستم"""
        print("\n📈 آمار سیستم")
        print("-" * 15)
        
        metrics = self.metrics.export_metrics()
        
        print(f"👥 تعداد کل کاربران: {metrics['total_users']}")
        print(f"✅ کاربران فعال: {metrics['active_users']}")
        print(f"🔑 تعداد ورودهای موفق: {metrics['total_logins']}")
        print(f"❌ تعداد ورودهای ناموفق: {metrics['failed_logins']}")
        print(f"🔒 حساب‌های قفل شده: {metrics['locked_accounts']}")
        print(f"📝 ثبت‌نام‌های امروز: {metrics['registrations_today']}")
        
        # نمودار ساعتی
        print("\n⏰ آمار ساعتی تلاش‌های ورود:")
        hourly_stats = metrics['hourly_login_attempts']
        for hour in sorted(hourly_stats.keys()):
            bar = "█" * (hourly_stats[hour] // 2)  # نمودار ساده
            print(f"{hour:02d}:00 - {hourly_stats[hour]:3d} {bar}")
    
    def show_user_management(self):
        """مدیریت کاربران"""
        print("\n👥 مدیریت کاربران")
        print("-" * 18)
        print("1. جستجوی کاربر")
        print("2. غیرفعال کردن کاربر")
        print("3. فعال کردن کاربر")
        print("4. بازگشت")
        
        choice = input("انتخاب: ").strip()
        
        if choice == "1":
            self.search_user()
        elif choice == "2":
            self.deactivate_user()
        elif choice == "3":
            self.activate_user()
    
    def search_user(self):
        """جستجوی کاربر"""
        username = input("نام کاربری: ").strip()
        try:
            user = self.auth_service.get_user_by_username(username)
            if user:
                print(f"\n📋 اطلاعات کاربر:")
                print(f"ID: {user.id}")
                print(f"نام کاربری: {user.username}")
                print(f"ایمیل: {user.email}")
                print(f"وضعیت: {'فعال' if user.is_active else 'غیرفعال'}")
                print(f"تاریخ ثبت‌نام: {user.created_at}")
                print(f"آخرین ورود: {user.last_login or 'هرگز'}")
                print(f"تلاش‌های ناموفق: {user.failed_login_attempts}")
                print(f"قفل تا: {user.locked_until or 'قفل نیست'}")
            else:
                print("❌ کاربر یافت نشد")
        except Exception as e:
            print(f"❌ خطا: {e}")
    
    def show_suspicious_activities(self):
        """نمایش فعالیت‌های مشکوک"""
        print("\n🚨 فعالیت‌های مشکوک")
        print("-" * 22)
        
        suspicious_ips = self.metrics.get_suspicious_ips()
        
        if suspicious_ips:
            print("IP های مشکوک (بیش از 10 تلاش ناموفق):")
            for ip in suspicious_ips:
                count = self.metrics.metrics.failed_attempts_by_ip[ip]
                print(f"🔴 {ip}: {count} تلاش ناموفق")
        else:
            print("✅ فعالیت مشکوکی یافت نشد")
    
    def export_data(self):
        """صادر کردن داده‌ها"""
        print("\n💾 صادر کردن داده‌ها")
        print("-" * 20)
        
        try:
            metrics = self.metrics.export_metrics()
            
            # ذخیره در فایل JSON
            filename = f"auth_metrics_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(metrics, f, indent=2, ensure_ascii=False, default=str)
            
            print(f"✅ داده‌ها در فایل {filename} ذخیره شد")
            
        except Exception as e:
            print(f"❌ خطا در صادر کردن: {e}")
</code></pre>
            </div>

            <h3>10. فایل اصلی کامل با تمام قابلیت‌ها</h3>
            <div class="code-block">
                <pre><code># main.py (نسخه نهایی)
import sys
import logging
from infrastructure.container import get_container
from adapters.ui.cli_adapter import CLIAdapter
from adapters.ui.admin_cli import AdminCLI
from adapters.ui.web_adapter import WebAdapter
from infrastructure.metrics import MetricsCollector
from infrastructure.logging import SecurityLogger

def setup_logging(config):
    """راه‌اندازی سیستم لاگ"""
    logging.basicConfig(
        level=getattr(logging, config.log_level),
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler('app.log'),
            logging.StreamHandler(sys.stdout)
        ]
    )

def run_cli_mode(container):
    """اجرای حالت CLI"""
    auth_service = container.get_auth_service()
    cli = CLIAdapter(auth_service)
    cli.run()

def run_admin_mode(container):
    """اجرای حالت مدیریت"""
    auth_service = container.get_auth_service()
    metrics = MetricsCollector()  # در حالت واقعی از container دریافت شود
    admin_cli = AdminCLI(auth_service, metrics)
    admin_cli.run()

def run_web_mode(container):
    """اجرای حالت وب"""
    try:
        from flask import Flask
    except ImportError:
        print("❌ برای حالت وب، Flask را نصب کنید: pip install flask")
        return
    
    auth_service = container.get_auth_service()
    web_adapter = WebAdapter(auth_service)
    
    print("🌐 سرور وب در حال اجرا...")
    print("📍 آدرس: http://127.0.0.1:5000")
    print("📋 API Endpoints:")
    print("   POST /api/register - ثبت‌نام")
    print("   POST /api/login - ورود")
    print("   GET /api/profile - پروفایل")
    
    web_adapter.run(debug=True)

def show_main_menu():
    """نمایش منوی اصلی"""
    print("\n🔐 سیستم احراز هویت - انتخاب حالت")
    print("=" * 40)
    print("1. 💻 حالت CLI (خط فرمان)")
    print("2. 🔧 حالت مدیریت")
    print("3. 🌐 حالت وب سرور")
    print("4. ❌ خروج")

def main():
    """تابع اصلی برنامه"""
    try:
        # دریافت کانتینر و تنظیمات
        container = get_container()
        config = container.get_config()
        
        # راه‌اندازی لاگ
        setup_logging(config)
        logger = logging.getLogger(__name__)
        
        logger.info("🚀 راه‌اندازی سیستم احراز هویت...")
        logger.info(f"نوع دیتابیس: {config.database.type}")
        logger.info(f"حالت دیباگ: {config.debug}")
        
        # نمایش منوی اصلی
        while True:
            show_main_menu()
            choice = input("انتخاب شما: ").strip()
            
            if choice == "1":
                run_cli_mode(container)
            elif choice == "2":
                run_admin_mode(container)
            elif choice == "3":
                run_web_mode(container)
            elif choice == "4":
                print("👋 خداحافظ!")
                break
            else:
                print("❌ انتخاب نامعتبر")
        
    except KeyboardInterrupt:
        print("\n\n👋 برنامه متوقف شد!")
    except Exception as e:
        logger.error(f"خطای غیرمنتظره: {e}")
        if container.get_config().debug:
            raise

if __name__ == "__main__":
    main()
</code></pre>
            </div>

            <div class="success">
                <h4>✅ نحوه اجرا</h4>
                <p>برای اجرای برنامه:</p>
                <ul>
                    <li><code>python main.py</code> - اجرای عادی با منوی انتخاب</li>
                    <li><code>DB_TYPE=sqlite python main.py</code> - استفاده از SQLite</li>
                    <li><code>DB_TYPE=file python main.py</code> - استفاده از فایل JSON</li>
                    <li><code>DEBUG=true python main.py</code> - حالت دیباگ</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>🎯 خلاصه و نتیجه‌گیری</h2>

            <h3>مزایای معماری هگزاگونال</h3>
            <div class="benefits">
                <div class="benefit-card">
                    <h4><span class="emoji">🧪</span>تست‌پذیری عالی</h4>
                    <p>منطق کسب‌وکار را بدون وابستگی‌های خارجی تست کنید</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">🔄</span>انعطاف‌پذیری بالا</h4>
                    <p>تغییر دیتابیس، UI یا سرویس‌های خارجی بدون تغییر منطق اصلی</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">🧩</span>جداسازی کامل</h4>
                    <p>هر لایه مسئولیت مشخص و مستقل دارد</p>
                </div>
                <div class="benefit-card">
                    <h4><span class="emoji">📈</span>مقیاس‌پذیری</h4>
                    <p>اضافه کردن قابلیت‌های جدید بدون تأثیر بر کد موجود</p>
                </div>
            </div>

            <h3>نکات مهم پیاده‌سازی</h3>
            <div class="highlight">
                <h4>💡 بهترین روش‌ها</h4>
                <ul>
                    <li><strong>Domain First:</strong> همیشه از منطق کسب‌وکار شروع کنید</li>
                    <li><strong>Interface Segregation:</strong> رابط‌ها را کوچک و مشخص نگه دارید</li>
                    <li><strong>Dependency Injection:</strong> از کانتینر DI استفاده کنید</li>
                    <li><strong>Testing Strategy:</strong> تست‌های واحد، یکپارچگی و End-to-End بنویسید</li>
                    <li><strong>Configuration:</strong> تنظیمات را از کد جدا نگه دارید</li>
                </ul>
            </div>

            <h3>مراحل توسعه آینده</h3>
            <div class="info">
                <h4>🚀 قابلیت‌های پیشنهادی</h4>
                <ul>
                    <li>اضافه کردن احراز هویت دو مرحله‌ای (2FA)</li>
                    <li>پیاده‌سازی OAuth2 و JWT</li>
                    <li>سیستم نقش‌ها و مجوزها (RBAC)</li>
                    <li>یکپارچه‌سازی با Redis برای Cache</li>
                    <li>پیاده‌سازی Event Sourcing</li>
                    <li>اضافه کردن GraphQL API</li>
                    <li>سیستم Audit Log کامل</li>
                </ul>
            </div>

            <div class="warning">
                <h4>⚠️ توجه</h4>
                <p>این پیاده‌سازی برای آموزش طراحی شده است. برای استفاده در محیط تولید، موارد امنیتی بیشتری مانند HTTPS، Rate Limiting، و امنیت پیشرفته‌تر لازم است.</p>
            </div>
        </div>

        <div class="section">
            <h2>📚 منابع و مطالعه بیشتر</h2>
            
            <h3>کتاب‌ها</h3>
            <ul>
                <li>Clean Architecture - Robert C. Martin</li>
                <li>Implementing Domain-Driven Design - Vaughn Vernon</li>
                <li>Patterns of Enterprise Application Architecture - Martin Fowler</li>
            </ul>

            <h3>مقالات</h3>
            <ul>
                <li>Hexagonal Architecture - Alistair Cockburn</li>
                <li>The Clean Architecture - Uncle Bob</li>
                <li>Domain-Driven Design Quickly - InfoQ</li>
            </ul>

            <h3>ابزارها و کتابخانه‌ها</h3>
            <ul>
                <li>FastAPI - برای API های مدرن</li>
                <li>SQLAlchemy - ORM پیشرفته</li>
                <li>Pydantic - اعتبارسنجی داده‌ها</li>
                <li>pytest - تست‌نویسی</li>
                <li>dependency-injector - DI Container</li>
            </ul>
        </div>
    </div>
</body>
</html>
