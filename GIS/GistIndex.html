<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù…ÙˆØ²Ø´ GistIndex Ø¯Ø± Django</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            background: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
            padding: 20px;
            line-height: 1.7;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #1b5e20;
            font-size: 2.5em;
            text-align: center;
            border-bottom: 4px solid #4caf50;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #1b5e20;
            font-size: 1.8em;
            margin: 30px 0 15px;
            border-right: 5px solid #4caf50;
            padding-right: 12px;
        }
        
        h3 {
            color: #2e7d32;
            font-size: 1.3em;
            margin: 20px 0 10px;
        }
        
        p, li {
            font-size: 1.05em;
            margin-bottom: 10px;
            text-align: justify;
        }
        
        ul { margin-right: 25px; }
        
        .code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            margin: 12px 0;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            overflow-x: auto;
            border-right: 4px solid #4caf50;
            direction: ltr;
            text-align: left;
            white-space: pre;
        }
        
        .output {
            background: #0d1117;
            color: #58a6ff;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            border-right: 4px solid #4caf50;
            direction: ltr;
            text-align: left;
        }
        
        .box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-right: 4px solid;
        }
        
        .info { background: #e8f5e9; border-color: #4caf50; }
        .warn { background: #fff3e0; border-color: #ff9800; }
        .error { background: #ffebee; border-color: #f44336; }
        .success { background: #e8f5e9; border-color: #4caf50; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th {
            background: #4caf50;
            color: white;
            padding: 10px;
            text-align: right;
        }
        
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }
        
        tr:nth-child(even) { background: #f0f7f0; }
        
        code {
            background: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
            color: #d32f2f;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 2em; }
            .grid { grid-template-columns: 1fr; }
        }
        
        .k { color: #569cd6; font-weight: bold; }
        .s { color: #ce9178; }
        .c { color: #6a9955; font-style: italic; }
        .n { color: #b5cea8; }
        .f { color: #dcdcaa; }
        .cl { color: #4ec9b0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ Ø¢Ù…ÙˆØ²Ø´ GistIndex Ø¯Ø± Django</h1>

        <!-- Ø¨Ø®Ø´ 1 -->
        <h2>ğŸ“ 1. Ù…Ù‚Ø¯Ù…Ù‡</h2>
        <div class="info box">
            <strong>GistIndex Ú†ÛŒØ³ØªØŸ</strong>
            <p><strong>GIST</strong> (Generalized Search Tree) ÛŒÚ© Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆÛŒÚ˜Ù‡ PostgreSQL Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø³Ø±Ø¹Øª Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÙ‡Ø§ Ø±Ø§ ØªØ§ <strong>1000 Ø¨Ø±Ø§Ø¨Ø±</strong> Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
        </div>

        <div class="grid">
            <div class="error box">
                <strong>âŒ Ø¨Ø¯ÙˆÙ† GistIndex:</strong>
                <ul>
                    <li>Sequential Scan</li>
                    <li>Ø²Ù…Ø§Ù†: 5-10 Ø«Ø§Ù†ÛŒÙ‡</li>
                    <li>CPU Ø¨Ø§Ù„Ø§</li>
                </ul>
            </div>
            <div class="success box">
                <strong>âœ… Ø¨Ø§ GistIndex:</strong>
                <ul>
                    <li>Index Scan</li>
                    <li>Ø²Ù…Ø§Ù†: 0.05 Ø«Ø§Ù†ÛŒÙ‡</li>
                    <li>Ø¨Ù‡ÛŒÙ†Ù‡ Ùˆ Ø³Ø±ÛŒØ¹</li>
                </ul>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ 2 -->
        <h2>ğŸ”§ 2. Ù†ØµØ¨ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
        
        <h3>Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§:</h3>
        <div class="code"><span class="c"># Ubuntu/Debian</span>
sudo apt-get install postgresql postgis postgresql-14-postgis-3
sudo apt-get install binutils libproj-dev gdal-bin

<span class="c"># Python packages</span>
pip install django psycopg2-binary</div>

        <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Django:</h3>
        <div class="code"><span class="c"># settings.py</span>
<span class="cl">INSTALLED_APPS</span> = [
    ...,
    <span class="s">'django.contrib.gis'</span>,  <span class="c"># Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</span>
]

<span class="cl">DATABASES</span> = {
    <span class="s">'default'</span>: {
        <span class="s">'ENGINE'</span>: <span class="s">'django.contrib.gis.db.backends.postgis'</span>,
        <span class="s">'NAME'</span>: <span class="s">'mydb'</span>,
        <span class="s">'USER'</span>: <span class="s">'postgres'</span>,
        <span class="s">'PASSWORD'</span>: <span class="s">'password'</span>,
        <span class="s">'HOST'</span>: <span class="s">'localhost'</span>,
    }
}</div>

        <h3>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ PostGIS:</h3>
        <div class="code"><span class="c">-- Ø¯Ø± PostgreSQL Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯</span>
<span class="k">CREATE EXTENSION</span> postgis;
<span class="k">CREATE EXTENSION</span> postgis_topology;</div>

        <!-- Ø¨Ø®Ø´ 3 -->
        <h2>ğŸ—ï¸ 3. ØªØ¹Ø±ÛŒÙ Ù…Ø¯Ù„ Ø¨Ø§ GistIndex</h2>
        
        <div class="code"><span class="k">from</span> django.db <span class="k">import</span> models
<span class="k">from</span> django.contrib.gis.db <span class="k">import</span> models <span class="k">as</span> gis_models
<span class="k">from</span> django.contrib.gis.db.models <span class="k">import</span> GistIndex

<span class="k">class</span> <span class="cl">Store</span>(models.Model):
    name = models.CharField(max_length=<span class="n">100</span>)
    address = models.TextField()
    location = gis_models.PointField(srid=<span class="n">4326</span>)  <span class="c"># WGS84</span>
    city = models.CharField(max_length=<span class="n">50</span>)
    category = models.CharField(max_length=<span class="n">50</span>)
    is_open = models.BooleanField(default=<span class="k">True</span>)
    
    <span class="k">class</span> <span class="cl">Meta</span>:
        indexes = [
            <span class="c"># Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ú©Ø§Ù†ÛŒ Ø§ØµÙ„ÛŒ</span>
            GistIndex(fields=[<span class="s">'location'</span>]),
            
            <span class="c"># Ø§ÛŒÙ†Ø¯Ú©Ø³ ØªØ±Ú©ÛŒØ¨ÛŒ</span>
            GistIndex(fields=[<span class="s">'location'</span>, <span class="s">'category'</span>]),
            
            <span class="c"># Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</span>
            models.Index(fields=[<span class="s">'city'</span>]),
        ]
    
    <span class="k">def</span> <span class="f">__str__</span>(self):
        <span class="k">return</span> self.name</div>

        <h3>Ø§Ù†ÙˆØ§Ø¹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ:</h3>
        <table>
            <tr>
                <th>ÙÛŒÙ„Ø¯</th>
                <th>Ú©Ø§Ø±Ø¨Ø±Ø¯</th>
            </tr>
            <tr>
                <td><code>PointField</code></td>
                <td>Ù†Ù‚Ø·Ù‡ (Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ±ÙˆØ´Ú¯Ø§Ù‡)</td>
            </tr>
            <tr>
                <td><code>LineStringField</code></td>
                <td>Ø®Ø· (Ù…Ø³ÛŒØ± Ø¬Ø§Ø¯Ù‡)</td>
            </tr>
            <tr>
                <td><code>PolygonField</code></td>
                <td>Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ (Ù…Ø±Ø² Ø´Ù‡Ø±)</td>
            </tr>
            <tr>
                <td><code>MultiPointField</code></td>
                <td>Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù†Ù‚Ø§Ø·</td>
            </tr>
        </table>

        <div class="code"><span class="c"># Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª</span>
python manage.py makemigrations
python manage.py migrate</div>

        <!-- Ø¨Ø®Ø´ 4 -->
        <h2>ğŸ“Š 4. Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ</h2>
        
        <div class="code"><span class="k">from</span> django.contrib.gis.geos <span class="k">import</span> Point, Polygon

<span class="c"># Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø·Ù‡: Point(longitude, latitude)</span>
<span class="c"># ØªÙˆØ¬Ù‡: Ø§ÙˆÙ„ Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒØŒ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶!</span>

<span class="c"># ØªÙ‡Ø±Ø§Ù†</span>
tehran_loc = Point(<span class="n">51.3890</span>, <span class="n">35.6892</span>)

store = Store.objects.create(
    name=<span class="s">"ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø±Ú©Ø²ÛŒ"</span>,
    address=<span class="s">"ØªÙ‡Ø±Ø§Ù†ØŒ Ù…ÛŒØ¯Ø§Ù† ÙˆÙ„ÛŒØ¹ØµØ±"</span>,
    location=tehran_loc,
    city=<span class="s">"ØªÙ‡Ø±Ø§Ù†"</span>,
    category=<span class="s">"supermarket"</span>
)

<span class="c"># Ù…Ø´Ù‡Ø¯</span>
mashhad_loc = Point(<span class="n">59.6168</span>, <span class="n">36.2974</span>)
Store.objects.create(
    name=<span class="s">"ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø´Ù‡Ø¯"</span>,
    location=mashhad_loc,
    city=<span class="s">"Ù…Ø´Ù‡Ø¯"</span>,
    category=<span class="s">"restaurant"</span>
)</div>

        <!-- Ø¨Ø®Ø´ 5 -->
        <h2>ğŸ” 5. Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ</h2>
        
        <h3>Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ:</h3>
        <table>
            <tr>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                <th>ØªÙˆØ¶ÛŒØ­</th>
            </tr>
            <tr>
                <td><code>__distance_lte</code></td>
                <td>ÙØ§ØµÙ„Ù‡ Ú©Ù…ØªØ± ÛŒØ§ Ù…Ø³Ø§ÙˆÛŒ</td>
            </tr>
            <tr>
                <td><code>__distance_lt</code></td>
                <td>ÙØ§ØµÙ„Ù‡ Ú©Ù…ØªØ±</td>
            </tr>
            <tr>
                <td><code>__within</code></td>
                <td>Ø¯Ø§Ø®Ù„ Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ</td>
            </tr>
            <tr>
                <td><code>__contains</code></td>
                <td>Ø´Ø§Ù…Ù„ Ù†Ù‚Ø·Ù‡</td>
            </tr>
            <tr>
                <td><code>__intersects</code></td>
                <td>ØªÙ‚Ø§Ø·Ø¹ Ø¯Ø§Ø±Ø¯</td>
            </tr>
        </table>

        <h3>1ï¸âƒ£ ÛŒØ§ÙØªÙ† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§:</h3>
        <div class="code"><span class="k">from</span> django.contrib.gis.db.models.functions <span class="k">import</span> Distance
<span class="k">from</span> django.contrib.gis.measure <span class="k">import</span> D
<span class="k">from</span> django.contrib.gis.geos <span class="k">import</span> Point

<span class="k">def</span> <span class="f">find_nearby_stores</span>(user_lat, user_lng, radius_km=<span class="n">10</span>):
    user_location = Point(user_lng, user_lat)
    
    nearby = Store.objects.filter(
        location__distance_lte=(user_location, D(km=radius_km))
    ).annotate(
        distance=Distance(<span class="s">'location'</span>, user_location)
    ).order_by(<span class="s">'distance'</span>)
    
    <span class="k">return</span> nearby

<span class="c"># Ø§Ø³ØªÙØ§Ø¯Ù‡</span>
stores = find_nearby_stores(<span class="n">35.6892</span>, <span class="n">51.3890</span>, radius_km=<span class="n">5</span>)

<span class="k">for</span> store <span class="k">in</span> stores:
    print(<span class="s">f"</span>{store.name}<span class="s">: </span>{store.distance.km:.2f}<span class="s"> Ú©ÛŒÙ„ÙˆÙ…ØªØ±"</span>)</div>

        <div class="output">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø±Ú©Ø²ÛŒ: 0.85 Ú©ÛŒÙ„ÙˆÙ…ØªØ±
ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø´Ù…Ø§Ù„: 2.34 Ú©ÛŒÙ„ÙˆÙ…ØªØ±
ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ØºØ±Ø¨: 4.12 Ú©ÛŒÙ„ÙˆÙ…ØªØ±</div>

        <h3>2ï¸âƒ£ ÙÛŒÙ„ØªØ± ØªØ±Ú©ÛŒØ¨ÛŒ (Ù…Ú©Ø§Ù†ÛŒ + Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ):</h3>
        <div class="code"><span class="k">def</span> <span class="f">find_restaurants</span>(lat, lng, radius=<span class="n">3</span>):
    location = Point(lng, lat)
    
    restaurants = Store.objects.filter(
        location__distance_lte=(location, D(km=radius)),
        category=<span class="s">'restaurant'</span>,
        is_open=<span class="k">True</span>
    ).annotate(
        distance=Distance(<span class="s">'location'</span>, location)
    ).order_by(<span class="s">'distance'</span>)[:<span class="n">10</span>]
    
    <span class="k">return</span> restaurants</div>

        <h3>3ï¸âƒ£ Ù†Ù‚Ø§Ø· Ø¯Ø§Ø®Ù„ Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ:</h3>
        <div class="code"><span class="c"># ØªØ¹Ø±ÛŒÙ Ù…Ø±Ø² ØªÙ‡Ø±Ø§Ù†</span>
tehran_boundary = Polygon((
    (<span class="n">51.0</span>, <span class="n">35.5</span>), (<span class="n">51.8</span>, <span class="n">35.5</span>),
    (<span class="n">51.8</span>, <span class="n">35.9</span>), (<span class="n">51.0</span>, <span class="n">35.9</span>),
    (<span class="n">51.0</span>, <span class="n">35.5</span>)
))

<span class="c"># ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ ØªÙ‡Ø±Ø§Ù†</span>
stores_in_tehran = Store.objects.filter(
    location__within=tehran_boundary
)

print(<span class="s">f"ØªØ¹Ø¯Ø§Ø¯: </span>{stores_in_tehran.count()}<span class="s">"</span>)</div>

        <!-- Ø¨Ø®Ø´ 6 -->
        <h2>âš¡ 6. Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ</h2>
        
        <h3>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Cache:</h3>
        <div class="code"><span class="k">from</span> django.core.cache <span class="k">import</span> cache

<span class="k">def</span> <span class="f">get_nearby_cached</span>(lat, lng, radius=<span class="n">10</span>):
    cache_key = <span class="s">f"stores_</span>{lat:.3f}<span class="s">_</span>{lng:.3f}<span class="s">_</span>{radius}<span class="s">"</span>
    
    result = cache.get(cache_key)
    <span class="k">if</span> result <span class="k">is</span> <span class="k">None</span>:
        location = Point(lng, lat)
        result = list(Store.objects.filter(
            location__distance_lte=(location, D(km=radius))
        ).annotate(
            distance=Distance(<span class="s">'location'</span>, location)
        ).order_by(<span class="s">'distance'</span>)[:<span class="n">20</span>])
        
        cache.set(cache_key, result, timeout=<span class="n">3600</span>)
    
    <span class="k">return</span> result</div>

        <div class="grid">
            <div class="info box">
                <strong>âœ… Ø¨Ù‡ØªØ±ÛŒÙ† Ø´ÛŒÙˆÙ‡â€ŒÙ‡Ø§:</strong>
                <ul>
                    <li>Ù‡Ù…ÛŒØ´Ù‡ <code>SRID=4326</code></li>
                    <li>Ø§ÛŒÙ†Ø¯Ú©Ø³ ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…Ú©Ø±Ø±</li>
                    <li>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Cache</li>
                    <li>Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§ EXPLAIN ANALYZE</li>
                </ul>
            </div>
            <div class="warn box">
                <strong>âš ï¸ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬:</strong>
                <ul>
                    <li>ÙØ±Ø§Ù…ÙˆØ´ÛŒ migration</li>
                    <li>Ø§Ø´ØªØ¨Ø§Ù‡ Ø¯Ø± (lng, lat)</li>
                    <li>SRID Ù†Ø§Ø¯Ø±Ø³Øª</li>
                    <li>ÙØ±Ø§Ù…ÙˆØ´ÛŒ postgis ENGINE</li>
                </ul>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ 7 -->
        <h2>ğŸ“Š 7. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
        
        <table>
            <tr>
                <th>ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯</th>
                <th>Ø¨Ø¯ÙˆÙ† Index</th>
                <th>Ø¨Ø§ GistIndex</th>
                <th>Ø¨Ù‡Ø¨ÙˆØ¯</th>
            </tr>
            <tr>
                <td>100</td>
                <td>50 ms</td>
                <td>5 ms</td>
                <td>10x âš¡</td>
            </tr>
            <tr>
                <td>10,000</td>
                <td>500 ms</td>
                <td>8 ms</td>
                <td>62x âš¡âš¡</td>
            </tr>
            <tr>
                <td>100,000</td>
                <td>5,000 ms</td>
                <td>12 ms</td>
                <td>416x âš¡âš¡âš¡</td>
            </tr>
            <tr>
                <td>1,000,000</td>
                <td>50,000 ms</td>
                <td>18 ms</td>
                <td>2777x ğŸš€</td>
            </tr>
        </table>

        <!-- Ø¨Ø®Ø´ 8 -->
        <h2>ğŸ™ï¸ 8. Ù…Ø«Ø§Ù„ Ú©Ø§Ù…Ù„ - Ø³ÛŒØ³ØªÙ… ØªØ§Ú©Ø³ÛŒ</h2>
        
        <div class="code"><span class="c"># models.py</span>
<span class="k">class</span> <span class="cl">Driver</span>(models.Model):
    name = models.CharField(max_length=<span class="n">100</span>)
    current_location = gis_models.PointField()
    is_available = models.BooleanField(default=<span class="k">True</span>)
    rating = models.DecimalField(max_digits=<span class="n">3</span>, decimal_places=<span class="n">2</span>)
    
    <span class="k">class</span> <span class="cl">Meta</span>:
        indexes = [
            GistIndex(fields=[<span class="s">'current_location'</span>]),
            models.Index(fields=[<span class="s">'is_available'</span>, <span class="s">'-rating'</span>]),
        ]

<span class="k">class</span> <span class="cl">Ride</span>(models.Model):
    driver = models.ForeignKey(Driver, on_delete=models.CASCADE)
    pickup_location = gis_models.PointField()
    dropoff_location = gis_models.PointField()
    status = models.CharField(max_length=<span class="n">20</span>)
    
    <span class="k">class</span> <span class="cl">Meta</span>:
        indexes = [
            GistIndex(fields=[<span class="s">'pickup_location'</span>]),
            GistIndex(fields=[<span class="s">'dropoff_location'</span>]),
        ]


<span class="c"># services.py</span>
<span class="k">def</span> <span class="f">find_nearest_driver</span>(passenger_lat, passenger_lng, max_km=<span class="n">5</span>):
    <span class="s">"""ÛŒØ§ÙØªÙ† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¢Ø²Ø§Ø¯"""</span>
    location = Point(passenger_lng, passenger_lat)
    
    driver = Driver.objects.filter(
        is_available=<span class="k">True</span>,
        current_location__distance_lte=(location, D(km=max_km))
    ).annotate(
        distance=Distance(<span class="s">'current_location'</span>, location)
    ).order_by(<span class="s">'distance'</span>, <span class="s">'-rating'</span>).first()
    
    <span class="k">return</span> driver


<span class="k">def</span> <span class="f">create_ride</span>(passenger_lat, passenger_lng, dest_lat, dest_lng):
    <span class="s">"""Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ± Ø¬Ø¯ÛŒØ¯"""</span>
    driver = find_nearest_driver(passenger_lat, passenger_lng)
    
    <span class="k">if</span> <span class="k">not</span> driver:
        <span class="k">raise</span> Exception(<span class="s">"Ø±Ø§Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª"</span>)
    
    ride = Ride.objects.create(
        driver=driver,
        pickup_location=Point(passenger_lng, passenger_lat),
        dropoff_location=Point(dest_lng, dest_lat),
        status=<span class="s">'pending'</span>
    )
    
    <span class="c"># Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª</span>
    driver.is_available = <span class="k">False</span>
    driver.save()
    
    <span class="k">return</span> ride


<span class="k">def</span> <span class="f">get_ride_statistics</span>(city_boundary):
    <span class="s">"""Ø¢Ù…Ø§Ø± Ø³ÙØ±Ù‡Ø§ÛŒ ÛŒÚ© Ø´Ù‡Ø±"""</span>
    rides = Ride.objects.filter(
        pickup_location__within=city_boundary,
        status=<span class="s">'completed'</span>
    )
    
    <span class="k">return</span> {
        <span class="s">'total_rides'</span>: rides.count(),
        <span class="s">'avg_distance'</span>: rides.aggregate(
            avg_dist=Avg(Distance(<span class="s">'pickup_location'</span>, <span class="s">'dropoff_location'</span>))
        )[<span class="s">'avg_dist'</span>]
    }</div>

        <!-- Ø¨Ø®Ø´ 9 -->
        <h2>ğŸ” 9. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³</h2>
        
        <div class="code"><span class="c"># Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ†Ø¯Ú©Ø³</span>
<span class="k">from</span> django.db <span class="k">import</span> connection

<span class="k">def</span> <span class="f">check_index_usage</span>():
    location = Point(<span class="n">51.3890</span>, <span class="n">35.6892</span>)
    
    query = Store.objects.filter(
        location__distance_lte=(location, D(km=<span class="n">10</span>))
    ).query
    
    <span class="k">with</span> connection.cursor() <span class="k">as</span> cursor:
        cursor.execute(<span class="s">f"EXPLAIN ANALYZE </span>{query}<span class="s">"</span>)
        <span class="k">for</span> row <span class="k">in</span> cursor.fetchall():
            print(row[<span class="n">0</span>])

check_index_usage()</div>

        <div class="output">Index Scan using store_location_gist on store
  Index Cond: (location && '...'::geography)
Planning Time: 0.123 ms
Execution Time: 2.456 ms  âœ…</div>

        <!-- Ø¨Ø®Ø´ 10 -->
        <h2>ğŸ“š 10. Ø®Ù„Ø§ØµÙ‡ Ùˆ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ</h2>
        
        <div class="success box">
            <h3>âœ… Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ:</h3>
            <ul>
                <li><strong>GistIndex</strong> Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ú©Ø§Ù†ÛŒ Ø¨Ø§ +1000 Ø±Ú©ÙˆØ±Ø¯ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª</li>
                <li>Ø³Ø±Ø¹Øª Ø±Ø§ ØªØ§ <strong>1000 Ø¨Ø±Ø§Ø¨Ø±</strong> Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯</li>
                <li>Ø§Ø² <code>SRID=4326</code> (WGS84) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</li>
                <li>Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…Ú©Ø±Ø± Ø¨Ø³Ø§Ø²ÛŒØ¯</li>
                <li>Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÙ‡Ø§ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ø±Ø§ Ú©Ø´ Ú©Ù†ÛŒØ¯</li>
                <li>Ø¨Ø§ <code>EXPLAIN ANALYZE</code> Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯</li>
            </ul>
        </div>

        <div class="info box">
            <h3>ğŸ“– Ù…Ù†Ø§Ø¨Ø¹ Ø¨ÛŒØ´ØªØ±:</h3>
            <ul>
                <li>Ù…Ø³ØªÙ†Ø¯Ø§Øª Django GeoDjango</li>
                <li>Ù…Ø³ØªÙ†Ø¯Ø§Øª PostGIS</li>
                <li>PostgreSQL GIST Index Documentation</li>
            </ul>
        </div>

        <div class="warn box">
            <h3>âš ï¸ Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ù‚Ø¨Ù„ Ø§Ø² Production:</h3>
            <ul>
                <li>âœ“ PostGIS Ù†ØµØ¨ Ùˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª</li>
                <li>âœ“ ØªÙ…Ø§Ù… migrationÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯</li>
                <li>âœ“ GistIndex Ø±ÙˆÛŒ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯</li>
                <li>âœ“ Ø¨Ø§ EXPLAIN ANALYZE ØªØ³Øª Ø´Ø¯Ù‡ Ø§Ø³Øª</li>
                <li>âœ“ Cache Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª</li>
                <li>âœ“ Backup Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px; background: #e8f5e9; border-radius: 10px;">
            <h3 style="color: #1b5e20;">ğŸ‰ Ù¾Ø§ÛŒØ§Ù† Ø¢Ù…ÙˆØ²Ø´</h3>
            <p style="font-size: 1.1em;">Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Django Ø¨Ø³Ø§Ø²ÛŒØ¯!</p>
        </div>
    </div>
</body>
</html>
