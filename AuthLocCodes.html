<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی - Django Models</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            line-height: 1.8;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .model-section {
            background: white;
            margin: 30px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .model-section:hover {
            transform: translateY(-5px);
        }

        .model-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            position: relative;
        }

        .model-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .model-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }

        .model-content {
            padding: 30px;
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .field-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #27ae60;
            transition: all 0.3s ease;
        }

        .field-item:hover {
            background: #e8f5e8;
            transform: translateX(-5px);
        }

        .field-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .field-type {
            color: #e74c3c;
            font-family: 'Courier New', monospace;
            background: #fff;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-bottom: 8px;
            display: inline-block;
        }

        .field-description {
            color: #666;
            font-size: 0.95em;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
        }

        .code-block::before {
            content: "Python Code";
            position: absolute;
            top: 10px;
            right: 15px;
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.8em;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: scale(1.05);
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .example-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
        }

        .example-title {
            color: #856404;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .relationship-diagram {
            background: white;
            border: 2px dashed #27ae60;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .relationship-item {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .relationship-item:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .arrow {
            font-size: 1.5em;
            color: #27ae60;
            margin: 0 15px;
        }

        .summary-section {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-top: 40px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .summary-number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }

        .toc {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .toc h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .toc ul {
            list-style: none;
        }

        .toc li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .toc a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .field-grid {
                grid-template-columns: 1fr;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success-box {
            background: #d4edda;
            border-left: 5px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏛️ سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی</h1>
            <p>مدل‌های Django برای پیاده‌سازی سیستم کنترل دسترسی پیشرفته با قابلیت‌های GIS</p>
        </div>

        <!-- Table of Contents -->
        <div class="toc">
            <h3>📋 فهرست مطالب</h3>
            <ul>
                <li><a href="#overview">نمای کلی سیستم</a></li>
                <li><a href="#basemodel">BaseModel - مدل پایه</a></li>
                <li><a href="#organization">Organization - سازمان</a></li>
                <li><a href="#user">User - کاربر</a></li>
                <li><a href="#role">Role - نقش</a></li>
                <li><a href="#rolegroup">RoleGroup - گروه نقش</a></li>
                <li><a href="#userrole">UserRole - اختصاص نقش</a></li>
                <li><a href="#geographiczone">GeographicZone - محدوده جغرافیایی</a></li>
                <li><a href="#fieldpermission">FieldPermission - مجوزهای فیلد</a></li>
                <li><a href="#relationships">روابط مدل‌ها</a></li>
                <li><a href="#scenarios">سناریوهای کاربردی</a></li>
                <li><a href="#summary">خلاصه و نتیجه‌گیری</a></li>
            </ul>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="model-section">
            <div class="model-header">
                <h2>🎯 نمای کلی سیستم</h2>
                <span class="badge">Architecture Overview</span>
            </div>
            <div class="model-content">
                <p>این سیستم یک راه‌حل جامع برای کنترل دسترسی در سازمان‌های مختلف ارائه می‌دهد که شامل:</p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🔐</div>
                        <h4>کنترل دسترسی چندلایه</h4>
                        <p>سطوح مختلف امنیت و کنترل دسترسی</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🗺️</div>
                        <h4>کنترل جغرافیایی</h4>
                        <p>محدودیت دسترسی بر اساس موقعیت مکانی</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">⏰</div>
                        <h4>کنترل زمانی</h4>
                        <p>تعریف بازه‌های زمانی مجاز برای دسترسی</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">👥</div>
                        <h4>سلسله مراتب سازمانی</h4>
                        <p>ساختار نقش‌های سلسله مراتبی</p>
                    </div>
                </div>

                <div class="success-box">
                    <strong>💡 نکته مهم:</strong> این سیستم به گونه‌ای طراحی شده که قابل تطبیق با انواع مختلف سازمان‌ها باشد، از شهرداری‌ها گرفته تا شرکت‌ها و بیمارستان‌ها.
                </div>
            </div>
        </div>

        <!-- BaseModel -->
        <div id="basemodel" class="model-section">
            <div class="model-header">
                <h2>🏗️ BaseModel - مدل پایه</h2>
                <span class="badge">Abstract Model</span>
            </div>
            <div class="model-content">
                <p>مدل پایه‌ای که تمام مدل‌های دیگر از آن ارث‌بری می‌کنند و فیلدهای مشترک را فراهم می‌کند.</p>

                <div class="code-block">
class BaseModel(models.Model):
    """مدل پایه با فیلدهای مشترک"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        abstract = True
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">id</div>
                        <div class="field-type">UUIDField</div>
                        <div class="field-description">شناسه یکتای UUID به جای ID عددی برای امنیت بالاتر</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">created_at</div>
                        <div class="field-type">DateTimeField</div>
                        <div class="field-description">زمان ایجاد رکورد (خودکار)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">updated_at</div>
                        <div class="field-type">DateTimeField</div>
                        <div class="field-description">زمان آخرین بروزرسانی (خودکار)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">is_active</div>
                        <div class="field-type">BooleanField</div>
                        <div class="field-description">فعال/غیرفعال بودن رکورد (Soft Delete)</div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>🔍 ویژگی‌های کلیدی:</strong>
                    <ul>
                        <li>استفاده از UUID برای جلوگیری از حدس‌زنی ID</li>
                        <li>ردیابی خودکار زمان ایجاد و بروزرسانی</li>
                        <li>امکان حذف منطقی با فیلد is_active</li>
                        <li>قابلیت ارث‌بری برای تمام مدل‌ها</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Organization Model -->
        <div id="organization" class="model-section">
            <div class="model-header">
                <h2>🏢 Organization - سازمان</h2>
                <span class="badge">Core Model</span>
            </div>
            <div class="model-content">
                <p>مدل اصلی سازمان که تمام اطلاعات مربوط به یک سازمان را نگهداری می‌کند.</p>

                <div class="code-block">
class Organization(BaseModel):
    """سازمان اصلی"""
    name = models.CharField(max_length=255)
    code = models.CharField(max_length=50, unique=True)
    domain_type = models.CharField(max_length=50)  # municipality, company, hospital
    settings = models.JSONField(default=dict)
    logo = models.ImageField(upload_to='organizations/logos/', null=True, blank=True)
    
    # Geographic bounds
    boundary = models.PolygonField(null=True, blank=True)
    center_point = models.PointField(null=True, blank=True)
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">name</div>
                        <div class="field-type">CharField(255)</div>
                        <div class="field-description">نام سازمان (مثل "شهرداری تهران")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">code</div>
                        <div class="field-type">CharField(50) - Unique</div>
                        <div class="field-description">کد یکتای سازمان (مثل "THR_MUN_001")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">domain_type</div>
                        <div class="field-type">CharField(50)</div>
                        <div class="field-description">نوع حوزه کاری (municipality, company, hospital)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">settings</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">تنظیمات سازمان (ساعات کاری، زبان، ارز و...)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">boundary</div>
                        <div class="field-type">PolygonField</div>
                        <div class="field-description">مرز جغرافیایی سازمان</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">center_point</div>
                        <div class="field-type">PointField</div>
                        <div class="field-description">نقطه مرکزی سازمان</div>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">📝 مثال عملی: ایجاد شهرداری تهران</div>
                    <div class="code-block">
tehran_municipality = Organization.objects.create(
    name="شهرداری تهران",
    code="THR_MUN_2024",
    domain_type="municipality",
    settings={
        "working_hours": {
            "saturday_to_wednesday": "08:00-16:00",
            "thursday": "08:00-13:00"
        },
        "timezone": "Asia/Tehran",
        "language": "fa",
        "currency": "IRR"
    },
    boundary=Polygon([...]),  # مختصات مرز تهران
    center_point=Point(51.4, 35.7)  # میدان آزادی
)
                    </div>
                </div>
            </div>
        </div>

        <!-- User Model -->
        <div id="user" class="model-section">
            <div class="model-header">
                <h2>👤 User - کاربر سیستم</h2>
                <span class="badge">Authentication</span>
            </div>
            <div class="model-content">
                <p>مدل کاربر که از AbstractUser ارث‌بری کرده و قابلیت‌های اضافی برای ردیابی موقعیت و امنیت دارد.</p>

                <div class="code-block">
class User(AbstractUser):
    """کاربر سیستم"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    employee_code = models.CharField(max_length=50, null=True, blank=True)
    phone = models.CharField(max_length=15, null=True, blank=True)
    national_id = models.CharField(max_length=20, null=True, blank=True)
    
    # Location tracking
    last_known_location = models.PointField(null=True, blank=True)
    location_updated_at = models.DateTimeField(null=True, blank=True)
    
    # Security
    failed_login_attempts = models.IntegerField(default=0)
    locked_until = models.DateTimeField(null=True, blank=True)
    force_password_change = models.BooleanField(default=False)
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">organization</div>
                        <div class="field-type">ForeignKey</div>
                        <div class="field-description">سازمان متعلق به کاربر</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">employee_code</div>
                        <div class="field-type">CharField(50)</div>
                        <div class="field-description">کد پرسنلی کاربر</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">last_known_location</div>
                        <div class="field-type">PointField</div>
                        <div class="field-description">آخرین موقعیت شناخته شده کاربر</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">failed_login_attempts</div>
                        <div class="field-type">IntegerField</div>
                        <div class="field-description">تعداد تلاش‌های ناموفق ورود</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">locked_until</div>
                        <div class="field-type">DateTimeField</div>
                        <div class="field-description">زمان قفل شدن حساب کاربری</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">force_password_change</div>
                        <div class="field-type">BooleanField</div>
                        <div class="field-description">اجبار تغییر رمز عبور</div>
                    </div>
                </div>

                <div class="warning-box">
                    <strong>⚠️ نکات امنیتی:</strong>
                    <ul>
                        <li>ردیابی موقعیت کاربر برای کنترل دسترسی جغرافیایی</li>
                        <li>قفل خودکار حساب پس از تلاش‌های ناموفق</li>
                        <li>اجبار تغییر رمز عبور در ورود اول</li>
                        <li>نگهداری اطلاعات تماس برای اعلان‌های امنیتی</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Role Model -->
        <div id="role" class="model-section">
            <div class="model-header">
                <h2>🎭 Role - نقش‌های سلسله مراتبی</h2>
                <span class="badge">Authorization</span>
            </div>
            <div class="model-content">
                <p>مدل نقش که ساختار سلسله مراتبی سازمان را تعریف می‌کند و مجوزهای مختلف را شامل می‌شود.</p>

                <div class="code-block">
class Role(BaseModel):
    """نقش‌های سلسله مراتبی"""
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=50)
    hierarchy_level = models.IntegerField()  # 1=highest
    parent_role = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True)
    group = models.ForeignKey('RoleGroup', on_delete=models.CASCADE)
    permissions = models.JSONField(default=dict)
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">name</div>
                        <div class="field-type">CharField(100)</div>
                        <div class="field-description">نام نقش (مثل "شهردار منطقه 1")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">hierarchy_level</div>
                        <div class="field-type">IntegerField</div>
                        <div class="field-description">سطح سلسله مراتب (1 = بالاترین)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">parent_role</div>
                        <div class="field-type">ForeignKey(self)</div>
                        <div class="field-description">نقش والد در سلسله مراتب</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">permissions</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">مجوزهای اختصاصی نقش</div>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">📊 مثال ساختار سلسله مراتبی شهرداری</div>
                    <div class="relationship-diagram">
                        <div class="relationship-item">شهردار (سطح 1)</div>
                        <div class="arrow">↓</div>
                        <div class="relationship-item">معاون شهردار (سطح 2)</div>
                        <div class="arrow">↓</div>
                        <div class="relationship-item">مدیر منطقه (سطح 3)</div>
                        <div class="arrow">↓</div>
                        <div class="relationship-item">رئیس اداره (سطح 4)</div>
                        <div class="arrow">↓</div>
                        <div class="relationship-item">کارشناس (سطح 5)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RoleGroup Model -->
        <div id="rolegroup" class="model-section">
            <div class="model-header">
                <h2>👥 RoleGroup - گروه‌های نقش</h2>
                <span class="badge">Organization</span>
            </div>
            <div class="model-content">
                <p>گروه‌بندی نقش‌ها بر اساس حوزه کاری و تعریف قوانین مشترک برای هر گروه.</p>

                <div class="code-block">
class RoleGroup(BaseModel):
    """گروه‌های نقش"""
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=50)
    rules = models.JSONField(default=dict)
    access_policies = models.JSONField(default=dict)
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">name</div>
                        <div class="field-type">CharField(100)</div>
                        <div class="field-description">نام گروه (مثل "گروه مدیریت")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">rules</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">قوانین و محدودیت‌های گروه</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">access_policies</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">سیاست‌های دسترسی مشترک گروه</div>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">📝 مثال گروه‌های نقش در شهرداری</div>
                    <div class="code-block">
# گروه مدیریت
management_group = RoleGroup.objects.create(
    name="گروه مدیریت",
    code="MANAGEMENT",
    rules={
        "can_approve_budget": True,
        "max_approval_amount": 5000000000,
        "can_access_financial_reports": True,
        "working_hours_flexibility": True
    },
    access_policies={
        "require_2fa": True,
        "session_timeout_minutes": 480,
        "ip_restrictions": ["192.168.1.0/24"]
    }
)

# گروه فنی
technical_group = RoleGroup.objects.create(
    name="گروه فنی و مهندسی",
    code="TECHNICAL",
    rules={
        "can_access_gis_system": True,
        "can_modify_maps": True,
        "can_approve_construction_permits": True
    },
    access_policies={
        "require_vpn": True,
        "allowed_file_types": [".dwg", ".pdf", ".shp"],
        "backup_required": True
    }
)
                    </div>
                </div>
            </div>
        </div>

        <!-- UserRole Model -->
        <div id="userrole" class="model-section">
            <div class="model-header">
                <h2>🔗 UserRole - اختصاص نقش به کاربر</h2>
                <span class="badge">Assignment</span>
            </div>
            <div class="model-content">
                <p>مدل واسط که نقش‌ها را به کاربران اختصاص می‌دهد و محدودیت‌های زمانی و مکانی تعریف می‌کند.</p>

                <div class="code-block">
class UserRole(BaseModel):
    """اختصاص نقش به کاربر"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='user_roles')
    role = models.ForeignKey(Role, on_delete=models.CASCADE)
    geographic_zones = models.ManyToManyField('GeographicZone', blank=True)
    
    # Time restrictions
    valid_from = models.DateTimeField()
    valid_until = models.DateTimeField(null=True, blank=True)
    
    # Additional conditions
    conditions = models.JSONField(default=dict)
    
    class Meta:
        unique_together = ['user', 'role', 'valid_from']
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">user</div>
                        <div class="field-type">ForeignKey(User)</div>
                        <div class="field-description">کاربر دریافت‌کننده نقش</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">role</div>
                        <div class="field-type">ForeignKey(Role)</div>
                        <div class="field-description">نقش اختصاص‌یافته</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">geographic_zones</div>
                        <div class="field-type">ManyToManyField</div>
                        <div class="field-description">محدوده‌های جغرافیایی مجاز</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">valid_from</div>
                        <div class="field-type">DateTimeField</div>
                        <div class="field-description">شروع اعتبار نقش</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">valid_until</div>
                        <div class="field-type">DateTimeField</div>
                        <div class="field-description">پایان اعتبار نقش (اختیاری)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">conditions</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">شرایط اضافی دسترسی</div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>🔄 ویژگی‌های کلیدی:</strong>
                    <ul>
                        <li>امکان اختصاص چندین نقش به یک کاربر</li>
                        <li>تعریف بازه زمانی اعتبار نقش</li>
                        <li>محدودیت جغرافیایی برای هر اختصاص</li>
                        <li>شرایط خاص برای فعال‌سازی نقش</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- GeographicZone Model -->
        <div id="geographiczone" class="model-section">
            <div class="model-header">
                <h2>🗺️ GeographicZone - محدوده‌های جغرافیایی</h2>
                <span class="badge">GIS</span>
            </div>
            <div class="model-content">
                <p>تعریف محدوده‌های جغرافیایی مختلف برای کنترل دسترسی مبتنی بر موقعیت.</p>

                <div class="code-block">
class GeographicZone(BaseModel):
    """محدوده‌های جغرافیایی"""
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    name = models.CharField(max_length=200)
    zone_type = models.CharField(max_length=20)  # polygon, circle, point
    parent_zone = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True)
    
    # Geographic data
    polygon = models.PolygonField(null=True, blank=True)
    center_point = models.PointField(null=True, blank=True)
    radius = models.FloatField(null=True, blank=True)  # meters
    
    # Additional properties
    properties = models.JSONField(default=dict)
    
    class Meta:
        unique_together = ['organization', 'name']
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">zone_type</div>
                        <div class="field-type">CharField(20)</div>
                        <div class="field-description">نوع محدوده: polygon, circle, point</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">parent_zone</div>
                        <div class="field-type">ForeignKey(self)</div>
                        <div class="field-description">محدوده والد (برای ساختار درختی)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">polygon</div>
                        <div class="field-type">PolygonField</div>
                        <div class="field-description">محدوده چندضلعی (برای مناطق پیچیده)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">center_point</div>
                        <div class="field-type">PointField</div>
                        <div class="field-description">نقطه مرکزی محدوده</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">radius</div>
                        <div class="field-type">FloatField</div>
                        <div class="field-description">شعاع محدوده (برای نوع circle)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">properties</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">ویژگی‌های اضافی محدوده</div>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🏙️ مثال محدوده‌های شهری</div>
                    <div class="code-block">
# منطقه 1 تهران (محدوده چندضلعی)
region_1 = GeographicZone.objects.create(
    organization=tehran_municipality,
    name="منطقه 1 تهران",
    zone_type="polygon",
    polygon=Polygon([...]),  # مختصات مرز منطقه
    properties={
        "population": 280000,
        "area_km2": 47.8,
        "districts": ["ولنجک", "الهیه", "کامرانیه"],
        "economic_status": "high"
    }
)

# ساختمان شهرداری (محدوده دایره‌ای)
municipality_building = GeographicZone.objects.create(
    organization=tehran_municipality,
    name="ساختمان شهرداری منطقه 1",
    zone_type="circle",
    center_point=Point(51.42, 35.80),
    radius=50.0,  # 50 متر
    parent_zone=region_1,
    properties={
        "address": "خیابان ولیعصر",
        "floors": 8,
        "departments": ["مالی", "فنی", "خدمات شهری"]
    }
)
                    </div>
                </div>
            </div>
        </div>

        <!-- FieldPermission Model -->
        <div id="fieldpermission" class="model-section">
            <div class="model-header">
                <h2>🔐 FieldPermission - مجوزهای سطح فیلد</h2>
                <span class="badge">Fine-grained Control</span>
            </div>
            <div class="model-content">
                <p>کنترل دقیق دسترسی به فیلدهای خاص با قابلیت ماسک‌گذاری و شرایط پیچیده.</p>

                <div class="code-block">
class FieldPermission(BaseModel):
    """مجوزهای سطح فیلد"""
    role = models.ForeignKey(Role, on_delete=models.CASCADE)
    resource_type = models.CharField(max_length=100)  # Model name
    field_name = models.CharField(max_length=100)
    geographic_zones = models.ManyToManyField(GeographicZone, blank=True)
    
    # CRUD permissions
    can_read = models.BooleanField(default=False)
    can_update = models.BooleanField(default=False)
    can_create = models.BooleanField(default=False)
    can_delete = models.BooleanField(default=False)
    can_view_history = models.BooleanField(default=False)
    can_export = models.BooleanField(default=False)
    
    # Data masking
    masking_rule = models.CharField(max_length=50, null=True, blank=True)
    masking_pattern = models.CharField(max_length=100, null=True, blank=True)
    
    # Conditions and restrictions
    conditions = models.JSONField(default=dict)
    time_restrictions = models.JSONField(default=dict)
    
    class Meta:
        unique_together = ['role', 'resource_type', 'field_name']
                </div>

                <div class="field-grid">
                    <div class="field-item">
                        <div class="field-name">resource_type</div>
                        <div class="field-type">CharField(100)</div>
                        <div class="field-description">نام مدل (مثل "CitizenProfile")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">field_name</div>
                        <div class="field-type">CharField(100)</div>
                        <div class="field-description">نام فیلد (مثل "national_id")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">masking_rule</div>
                        <div class="field-type">CharField(50)</div>
                        <div class="field-description">نوع ماسک‌گذاری (partial, full, none)</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">masking_pattern</div>
                        <div class="field-type">CharField(100)</div>
                        <div class="field-description">الگوی ماسک (مثل "***-***-{last_3}")</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">conditions</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">شرایط اضافی دسترسی</div>
                    </div>
                    <div class="field-item">
                        <div class="field-name">time_restrictions</div>
                        <div class="field-type">JSONField</div>
                        <div class="field-description">محدودیت‌های زمانی</div>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🎭 مثال مجوزهای مختلف</div>
                    <div class="code-block">
# شهردار - دسترسی کامل به کد ملی
mayor_national_id_permission = FieldPermission.objects.create(
    role=mayor_role,
    resource_type="CitizenProfile",
    field_name="national_id",
    can_read=True,
    can_update=False,
    can_view_history=True,
    masking_rule=None,  # بدون ماسک
    conditions={
        "purpose_required": True,
        "audit_log": True
    }
)

# کارشناس GIS - دسترسی محدود با ماسک
gis_national_id_permission = FieldPermission.objects.create(
    role=gis_expert_role,
    resource_type="CitizenProfile", 
    field_name="national_id",
    can_read=True,
    can_update=False,
    masking_rule="partial",
    masking_pattern="***-***-{last_3}",
    conditions={
        "working_hours_only": True,
        "own_district_only": True
    },
    time_restrictions={
        "allowed_hours": "08:00-16:00",
        "allowed_days": ["saturday", "sunday", "monday", "tuesday", "wednesday"]
    }
)
                    </div>
                </div>
            </div>
        </div>

        <!-- Relationships -->
        <div id="relationships" class="model-section">
            <div class="model-header">
                <h2>🔄 روابط بین مدل‌ها</h2>
                <span class="badge">Data Architecture</span>
            </div>
            <div class="model-content">
                <p>نمودار روابط و وابستگی‌های بین مدل‌های مختلف سیستم.</p>

                <div class="relationship-diagram">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: center;">
                        <div class="relationship-item">Organization</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">User</div>
                        
                        <div class="relationship-item">Organization</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">RoleGroup</div>
                        
                        <div class="relationship-item">RoleGroup</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">Role</div>
                        
                        <div class="relationship-item">User + Role</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">UserRole</div>
                        
                        <div class="relationship-item">Organization</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">GeographicZone</div>
                        
                        <div class="relationship-item">Role</div>
                        <div class="arrow">→</div>
                        <div class="relationship-item">FieldPermission</div>
                    </div>
                </div>

                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🏢</div>
                        <h4>Organization</h4>
                        <p>مرکز سیستم - همه چیز به آن وابسته است</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">👤</div>
                        <h4>User</h4>
                        <p>کاربران متعلق به سازمان</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🎭</div>
                        <h4>Role</h4>
                        <p>نقش‌های سلسله مراتبی</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🗺️</div>
                        <h4>GeographicZone</h4>
                        <p>محدوده‌های جغرافیایی</p>
                    </div>
                </div>

                <div class="info-box">
                    <strong>🔗 نکات مهم روابط:</strong>
                    <ul>
                        <li><span class="highlight">Organization</span> به عنوان مرکز سیستم، تمام مدل‌های اصلی به آن وابسته‌اند</li>
                        <li><span class="highlight">UserRole</span> رابطه Many-to-Many بین User و Role را مدیریت می‌کند</li>
                        <li><span class="highlight">Role</span> می‌تواند نقش والد داشته باشد (ساختار درختی)</li>
                        <li><span class="highlight">GeographicZone</span> نیز ساختار درختی دارد (منطقه → محله → ساختمان)</li>
                        <li><span class="highlight">FieldPermission</span> کنترل دقیق دسترسی به فیلدهای مدل‌ها را فراهم می‌کند</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Practical Scenarios -->
        <div id="scenarios" class="model-section">
            <div class="model-header">
                <h2>🎯 سناریوهای کاربردی واقعی</h2>
                <span class="badge">Real-world Examples</span>
            </div>
            <div class="model-content">
                <p>مثال‌های عملی از نحوه استفاده از این سیستم در سناریوهای مختلف.</p>

                <div class="example-section">
                    <div class="example-title">🏛️ سناریو 1: ورود کارشناس GIS به سیستم</div>
                    <div class="code-block">
def authenticate_user_with_location(username, password, location_lat, location_lng):
    """احراز هویت کاربر با بررسی موقعیت جغرافیایی"""
    
    # احراز هویت اولیه
    user = authenticate(username=username, password=password)
    if not user:
        return {"success": False, "error": "نام کاربری یا رمز عبور اشتباه"}
    
    # بررسی قفل بودن حساب
    if user.locked_until and user.locked_until > timezone.now():
        return {"success": False, "error": "حساب کاربری قفل است"}
    
    # بررسی موقعیت جغرافیایی
    current_location = Point(location_lng, location_lat)
    
    # یافتن نقش‌های فعال کاربر
    active_roles = UserRole.objects.filter(
        user=user,
        valid_from__lte=timezone.now(),
        valid_until__gte=timezone.now()
    )
    
    allowed_zones = []
    for role_assignment in active_roles:
        allowed_zones.extend(role_assignment.geographic_zones.all())
    
    # بررسی اینکه کاربر در محدوده مجاز است
    in_allowed_zone = False
    current_zone = None
    
    for zone in allowed_zones:
        if zone.zone_type == 'polygon' and zone.polygon:
            if zone.polygon.contains(current_location):
                in_allowed_zone = True
                current_zone = zone
                break
        elif zone.zone_type == 'circle':
            distance = zone.center_point.distance(current_location) * 111000
            if distance <= zone.radius:
                in_allowed_zone = True
                current_zone = zone
                break
    
    if not in_allowed_zone:
        return {
            "success": False, 
            "error": "شما خارج از محدوده مجاز قرار دارید",
            "allowed_zones": [z.name for z in allowed_zones]
        }
    
    # بروزرسانی موقعیت کاربر
    user.last_known_location = current_location
    user.location_updated_at = timezone.now()
    user.failed_login_attempts = 0
    user.save()
    
    return {
        "success": True,
        "user": user.get_full_name(),
        "current_zone": current_zone.name,
        "permissions": get_user_permissions(user)
    }
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🔍 سناریو 2: بررسی دسترسی به فیلد خاص</div>
                    <div class="code-block">
def check_field_access(user, resource_type, field_name, action="read"):
    """بررسی دسترسی کاربر به فیلد خاص با اعمال ماسک"""
    
    # یافتن نقش‌های فعال
    active_roles = UserRole.objects.filter(
        user=user,
        valid_from__lte=timezone.now(),
        valid_until__gte=timezone.now()
    ).select_related('role')
    
    for role_assignment in active_roles:
        # بررسی مجوزهای فیلد
        field_permissions = FieldPermission.objects.filter(
            role=role_assignment.role,
            resource_type=resource_type,
            field_name=field_name
        )
        
        for permission in field_permissions:
            # بررسی نوع عملیات
            has_permission = getattr(permission, f'can_{action}', False)
            
            if has_permission:
                # بررسی محدودیت‌های زمانی
                if not check_time_restrictions(permission.time_restrictions):
                    continue
                
                # بررسی محدوده جغرافیایی
                if not check_geographic_restrictions(user, permission):
                    continue
                
                # اعمال ماسک‌گذاری
                masking_info = None
                if permission.masking_rule:
                    masking_info = {
                        "rule": permission.masking_rule,
                        "pattern": permission.masking_pattern
                    }
                
                return {
                    "allowed": True,
                    "masking": masking_info,
                    "conditions": permission.conditions,
                    "role": role_assignment.role.name
                }
    
    return {"allowed": False, "reason": "دسترسی مجاز نیست"}

def apply_data_masking(value, masking_rule, masking_pattern):
    """اعمال ماسک روی داده"""
    if not masking_rule or masking_rule == "none":
        return value
    
    if masking_rule == "full":
        return "*" * len(str(value))
    
    elif masking_rule == "partial" and masking_pattern:
        # مثال: "***-***-{last_3}" برای کد ملی
        if "{last_3}" in masking_pattern:
            return masking_pattern.replace("{last_3}", str(value)[-3:])
        elif "{first_2}" in masking_pattern:
            return masking_pattern.replace("{first_2}", str(value)[:2])
    
    return value
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">📊 سناریو 3: گزارش‌گیری و آمار دسترسی</div>
                    <div class="code-block">
def generate_access_audit_report(organization, date_from, date_to):
    """تولید گزارش حسابرسی دسترسی‌ها"""
    
    report = {
        "organization": organization.name,
        "period": f"{date_from} تا {date_to}",
        "generated_at": timezone.now(),
        "statistics": {},
        "security_alerts": [],
        "user_activities": []
    }
    
    # آمار کلی
    total_users = User.objects.filter(organization=organization).count()
    active_users = User.objects.filter(
        organization=organization,
        last_login__gte=date_from
    ).count()
    
    # آمار نقش‌ها
    total_roles = Role.objects.filter(organization=organization).count()
    active_assignments = UserRole.objects.filter(
        user__organization=organization,
        valid_from__lte=date_to,
        valid_until__gte=date_from
    ).count()
    
    report["statistics"] = {
        "total_users": total_users,
        "active_users": active_users,
        "total_roles": total_roles,
        "active_assignments": active_assignments,
        "activity_rate": f"{(active_users/total_users)*100:.1f}%"
    }
    
    # هشدارهای امنیتی
    # کاربران با تلاش‌های ناموفق زیاد
    suspicious_users = User.objects.filter(
        organization=organization,
        failed_login_attempts__gte=3
    )
    
    for user in suspicious_users:
        report["security_alerts"].append({
            "type": "multiple_failed_logins",
            "user": user.username,
            "attempts": user.failed_login_attempts,
            "last_attempt": user.last_login
        })
    
    # دسترسی‌های خارج از محدوده
    out_of_zone_access = []  # باید از لاگ‌های سیستم استخراج شود
    
    # فعالیت‌های کاربران
    recent_activities = UserRole.objects.filter(
        user__organization=organization,
        created_at__gte=date_from
    ).select_related('user', 'role')
    
    for activity in recent_activities:
        zones = [zone.name for zone in activity.geographic_zones.all()]
        report["user_activities"].append({
            "user": activity.user.get_full_name(),
            "role": activity.role.name,
            "assigned_at": activity.created_at,
            "valid_until": activity.valid_until,
            "zones": zones
        })
    
    return report
                    </div>
                </div>

                <div class="warning-box">
                    <strong>⚠️ نکات مهم پیاده‌سازی:</strong>
                    <ul>
                        <li>همیشه موقعیت کاربر را قبل از دسترسی بررسی کنید</li>
                        <li>از کش برای بهبود عملکرد بررسی مجوزها استفاده کنید</li>
                        <li>تمام دسترسی‌ها را برای حسابرسی لاگ کنید</li>
                        <li>ماسک‌گذاری داده‌ها را در سمت سرور انجام دهید</li>
                        <li>برای عملیات‌های حساس، احراز هویت دو مرحله‌ای اعمال کنید</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div id="summary" class="summary-section">
            <h2>📋 خلاصه و نتیجه‌گیری</h2>
            <p>سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی که ارائه دادیم، یک راه‌حل جامع و قابل تطبیق برای سازمان‌های مختلف است.</p>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-number">7</span>
                    <div>مدل اصلی</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number">∞</span>
                    <div>قابلیت تطبیق</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number">🔒</span>
                    <div>امنیت چندلایه</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number">📍</span>
                    <div>کنترل مکانی</div>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: left;">
                <h3>🎯 مزایای کلیدی سیستم:</h3>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🚀</div>
                        <h4>عملکرد بالا</h4>
                        <p>استفاده از UUID و فیلدهای بهینه‌شده</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔧</div>
                        <h4>قابل تنظیم</h4>
                        <p>سازگار با انواع مختلف سازمان‌ها</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🛡️</div>
                        <h4>امنیت پیشرفته</h4>
                        <p>کنترل دسترسی چندبعدی</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h4>قابل نظارت</h4>
                        <p>ردیابی و گزارش‌گیری کامل</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Implementation Guide -->
        <div class="model-section">
            <div class="model-header">
                <h2>🛠️ راهنمای پیاده‌سازی</h2>
                <span class="badge">Implementation</span>
            </div>
            <div class="model-content">
                <h3>مراحل پیاده‌سازی:</h3>
                
                <div class="example-section">
                    <div class="example-title">📦 نصب و تنظیم اولیه</div>
                    <div class="code-block">
# requirements.txt
Django==4.2.7
djangorestframework==3.14.0
django-cors-headers==4.3.1
psycopg2-binary==2.9.9
django-extensions==3.2.3
celery==5.3.4
redis==5.0.1
pillow==10.1.0

# GIS requirements
GDAL==3.7.3
GEOS==3.7.3
PROJ==6.3.2

# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis',
        'NAME': 'location_auth_system',
        'USER': 'postgres',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.gis',
    'rest_framework',
    'corsheaders',
    'your_app_name',
]
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🗃️ ایجاد Migration ها</div>
                    <div class="code-block">
# مرحله 1: ایجاد مدل‌های اولیه
python manage.py makemigrations
python manage.py migrate

# مرحله 2: ایجاد superuser
python manage.py createsuperuser

# مرحله 3: بارگذاری داده‌های اولیه
python manage.py loaddata initial_data.json

# مرحله 4: تست سیستم
python manage.py test
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">⚙️ تنظیمات Django Admin</div>
                    <div class="code-block">
# admin.py
from django.contrib import admin
from django.contrib.gis.admin import OSMGeoAdmin
from .models import Organization, User, Role, UserRole, GeographicZone

@admin.register(Organization)
class OrganizationAdmin(OSMGeoAdmin):
    list_display = ['name', 'code', 'domain_type', 'is_active']
    list_filter = ['domain_type', 'is_active']
    search_fields = ['name', 'code']
    readonly_fields = ['id', 'created_at', 'updated_at']

@admin.register(GeographicZone)
class GeographicZoneAdmin(OSMGeoAdmin):
    list_display = ['name', 'zone_type', 'organization', 'parent_zone']
    list_filter = ['zone_type', 'organization']
    search_fields = ['name']
    raw_id_fields = ['parent_zone']

@admin.register(UserRole)
class UserRoleAdmin(admin.ModelAdmin):
    list_display = ['user', 'role', 'valid_from', 'valid_until', 'is_active']
    list_filter = ['role', 'valid_from', 'is_active']
    raw_id_fields = ['user', 'role']
    filter_horizontal = ['geographic_zones']
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Features -->
        <div class="model-section">
            <div class="model-header">
                <h2>🚀 ویژگی‌های پیشرفته</h2>
                <span class="badge">Advanced</span>
            </div>
            <div class="model-content">
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🔄</div>
                        <h4>Cache سیستم</h4>
                        <p>کش کردن مجوزها برای عملکرد بهتر</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📱</div>
                        <h4>API موبایل</h4>
                        <p>رابط‌های RESTful برای اپلیکیشن‌های موبایل</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔔</div>
                        <h4>اعلان‌های بلادرنگ</h4>
                        <p>هشدارهای امنیتی و تغییرات مجوزها</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📈</div>
                        <h4>تحلیل رفتار</h4>
                        <p>تجزیه و تحلیل الگوهای دسترسی</p>
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">⚡ سیستم Cache</div>
                    <div class="code-block">
# utils/cache.py
from django.core.cache import cache
from django.conf import settings
import hashlib

class PermissionCache:
    @staticmethod
    def get_cache_key(user_id, resource_type, field_name):
        """تولید کلید یکتای کش"""
        key_string = f"perm_{user_id}_{resource_type}_{field_name}"
        return hashlib.md5(key_string.encode()).hexdigest()
    
    @staticmethod
    def get_user_permissions(user_id, resource_type, field_name):
        """دریافت مجوزها از کش"""
        cache_key = PermissionCache.get_cache_key(user_id, resource_type, field_name)
        return cache.get(cache_key)
    
    @staticmethod
    def set_user_permissions(user_id, resource_type, field_name, permissions, timeout=3600):
        """ذخیره مجوزها در کش"""
        cache_key = PermissionCache.get_cache_key(user_id, resource_type, field_name)
        cache.set(cache_key, permissions, timeout)
    
    @staticmethod
    def invalidate_user_cache(user_id):
        """پاک کردن تمام مجوزهای کاربر از کش"""
        # پیاده‌سازی بر اساس الگوی کلیدهای کش
        pass

# استفاده در views
def check_field_access_cached(user, resource_type, field_name):
    # ابتدا از کش بررسی کن
    cached_permission = PermissionCache.get_user_permissions(
        user.id, resource_type, field_name
    )
    
    if cached_permission is not None:
        return cached_permission
    
    # اگر در کش نبود، از دیتابیس بگیر
    permission = check_field_access(user, resource_type, field_name)
    
    # در کش ذخیره کن
    PermissionCache.set_user_permissions(
        user.id, resource_type, field_name, permission
    )
    
    return permission
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🔔 سیستم اعلان‌ها</div>
                    <div class="code-block">
# notifications/models.py
class SecurityAlert(BaseModel):
    """هشدارهای امنیتی"""
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    alert_type = models.CharField(max_length=50)
    severity = models.CharField(max_length=20)  # low, medium, high, critical
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    message = models.TextField()
    details = models.JSONField(default=dict)
    is_resolved = models.BooleanField(default=False)
    resolved_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name='resolved_alerts')

# notifications/services.py
from django.core.mail import send_mail
from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync

class NotificationService:
    @staticmethod
    def send_security_alert(alert_type, user, details):
        """ارسال هشدار امنیتی"""
        
        # ایجاد هشدار در دیتابیس
        alert = SecurityAlert.objects.create(
            organization=user.organization,
            alert_type=alert_type,
            severity='high',
            user=user,
            message=f"هشدار امنیتی: {alert_type}",
            details=details
        )
        
        # ارسال ایمیل
        send_mail(
            subject=f'هشدار امنیتی - {alert_type}',
            message=f'کاربر {user.get_full_name()} - {details}',
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[user.organization.security_email],
        )
        
        # ارسال اعلان بلادرنگ
        channel_layer = get_channel_layer()
        async_to_sync(channel_layer.group_send)(
            f"org_{user.organization.id}_security",
            {
                "type": "security_alert",
                "alert": {
                    "id": str(alert.id),
                    "type": alert_type,
                    "user": user.get_full_name(),
                    "message": alert.message,
                    "timestamp": alert.created_at.isoformat()
                }
            }
        )
        
        return alert
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing -->
        <div class="model-section">
            <div class="model-header">
                <h2>🧪 تست و کیفیت‌سنجی</h2>
                <span class="badge">Testing</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">🔬 تست‌های Unit</div>
                    <div class="code-block">
# tests/test_models.py
from django.test import TestCase
from django.contrib.gis.geos import Point, Polygon
from django.utils import timezone
from datetime import timedelta
from ..models import Organization, User, Role, UserRole, GeographicZone

class AccessControlTestCase(TestCase):
    def setUp(self):
        """تنظیمات اولیه تست"""
        self.organization = Organization.objects.create(
            name="شهرداری تست",
            code="TEST_MUN",
            domain_type="municipality"
        )
        
        self.user = User.objects.create_user(
            username="test_user",
            password="test_pass",
            organization=self.organization
        )
        
        self.zone = GeographicZone.objects.create(
            organization=self.organization,
            name="منطقه تست",
            zone_type="circle",
            center_point=Point(51.0, 35.0),
            radius=1000.0
        )
    
    def test_user_in_allowed_zone(self):
        """تست قرارگیری کاربر در محدوده مجاز"""
        # کاربر در محدوده
        user_location = Point(51.001, 35.001)
        self.user.last_known_location = user_location
        
        # محاسبه فاصله
        distance = self.zone.center_point.distance(user_location) * 111000
        self.assertLess(distance, self.zone.radius)
    
    def test_role_hierarchy(self):
        """تست سلسله مراتب نقش‌ها"""
        parent_role = Role.objects.create(
            organization=self.organization,
            name="مدیر کل",
            hierarchy_level=1
        )
        
        child_role = Role.objects.create(
            organization=self.organization,
            name="مدیر بخش",
            hierarchy_level=2,
            parent_role=parent_role
        )
        
        self.assertEqual(child_role.parent_role, parent_role)
        self.assertGreater(child_role.hierarchy_level, parent_role.hierarchy_level)
    
    def test_time_based_access(self):
        """تست دسترسی بر اساس زمان"""
        role = Role.objects.create(
            organization=self.organization,
            name="کارشناس",
            hierarchy_level=3
        )
        
        # نقش با تاریخ انقضا
        user_role = UserRole.objects.create(
            user=self.user,
            role=role,
            valid_from=timezone.now(),
            valid_until=timezone.now() + timedelta(days=30)
        )
        
        # بررسی اعتبار
        self.assertTrue(user_role.valid_from <= timezone.now())
        self.assertTrue(user_role.valid_until >= timezone.now())
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🌐 تست‌های API</div>
                    <div class="code-block">
# tests/test_api.py
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth import get_user_model
from django.contrib.gis.geos import Point

User = get_user_model()

class LocationAuthAPITestCase(APITestCase):
    def setUp(self):
        self.organization = Organization.objects.create(
            name="تست API",
            code="API_TEST"
        )
        
        self.user = User.objects.create_user(
            username="api_user",
            password="api_pass",
            organization=self.organization
        )
    
    def test_location_based_login(self):
        """تست ورود با موقعیت جغرافیایی"""
        data = {
            "username": "api_user",
            "password": "api_pass", 
            "location": {
                "latitude": 35.7,
                "longitude": 51.4
            }
        }
        
        response = self.client.post('/api/auth/location-login/', data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('access_token', response.data)
    
    def test_permission_check_api(self):
        """تست API بررسی مجوزها"""
        self.client.force_authenticate(user=self.user)
        
        data = {
            "resource_type": "CitizenProfile",
            "field_name": "national_id",
            "action": "read"
        }
        
        response = self.client.post('/api/permissions/check/', data)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('allowed', response.data)
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance -->
        <div class="model-section">
            <div class="model-header">
                <h2>⚡ بهینه‌سازی عملکرد</h2>
                <span class="badge">Performance</span>
            </div>
            <div class="model-content">
                <div class="info-box">
                    <strong>🎯 نکات بهینه‌سازی:</strong>
                    <ul>
                        <li>استفاده از <span class="highlight">select_related</span> و <span class="highlight">prefetch_related</span> برای کاهش تعداد کوئری‌ها</li>
                        <li>ایجاد <span class="highlight">ایندکس مناسب</span> روی فیلدهای پرجستجو</li>
                        <li>کش کردن <span class="highlight">مجوزهای کاربران</span> برای کاهش بار دیتابیس</li>
                        <li>استفاده از <span class="highlight">Database Connection Pooling</span></li>
                    </ul>
                </div>

                <div class="example-section">
                    <div class="example-title">📊 بهینه‌سازی کوئری‌ها</div>
                    <div class="code-block">
# models.py - اضافه کردن ایندکس‌ها
class User(AbstractUser):
    # ...
    class Meta:
        indexes = [
            models.Index(fields=['organization', 'is_active']),
            models.Index(fields=['last_known_location']),
            models.Index(fields=['employee_code']),
        ]

class UserRole(BaseModel):
    # ...
    class Meta:
        indexes = [
            models.Index(fields=['user', 'valid_from', 'valid_until']),
            models.Index(fields=['role', 'is_active']),
        ]

# services.py - کوئری‌های بهینه
def get_user_active_roles(user):
    """دریافت نقش‌های فعال کاربر با کوئری بهینه"""
    return UserRole.objects.select_related(
        'role', 'role__group', 'role__parent_role'
    ).prefetch_related(
        'geographic_zones', 'role__fieldpermission_set'
    ).filter(
        user=user,
        valid_from__lte=timezone.now(),
        valid_until__gte=timezone.now(),
        is_active=True
    )

def check_user_permissions_bulk(user, permission_checks):
    """بررسی دسته‌ای مجوزها"""
    roles = get_user_active_roles(user)
    
    # دریافت تمام مجوزهای فیلد مرتبط یکجا
    field_permissions = FieldPermission.objects.filter(
        role__in=[ur.role for ur in roles]
    ).select_related('role')
    
    results = {}
    for check in permission_checks:
        resource_type = check['resource_type']
        field_name = check['field_name']
        action = check.get('action', 'read')
        
        # پیدا کردن مجوز مناسب
        relevant_permissions = field_permissions.filter(
            resource_type=resource_type,
            field_name=field_name
        )
        
        results[f"{resource_type}.{field_name}"] = any(
            getattr(perm, f'can_{action}', False) 
            for perm in relevant_permissions
        )
    
    return results
                    </div>
                </div>
            </div>
        </div>

        <!-- Security -->
        <div class="model-section">
            <div class="model-header">
                <h2>🛡️ امنیت و حریم خصوصی</h2>
                <span class="badge">Security</span>
            </div>
            <div class="model-content">
                <div class="warning-box">
                    <strong>🔐 نکات امنیتی حیاتی:</strong>
                    <ul>
                        <li><strong>رمزنگاری داده‌های حساس:</strong> اطلاعات مهم مانند کد ملی باید رمزنگاری شوند</li>
                        <li><strong>Audit Logging:</strong> تمام دسترسی‌ها و تغییرات باید لاگ شوند</li>
                        <li><strong>Rate Limiting:</strong> محدودیت تعداد درخواست‌ها برای جلوگیری از حملات</li>
                        <li><strong>Input Validation:</strong> اعتبارسنجی دقیق تمام ورودی‌های کاربر</li>
                    </ul>
                </div>

                <div class="example-section">
                    <div class="example-title">🔒 رمزنگاری داده‌های حساس</div>
                    <div class="code-block">
# utils/encryption.py
from cryptography.fernet import Fernet
from django.conf import settings
import base64

class DataEncryption:
    def __init__(self):
        key = settings.ENCRYPTION_KEY.encode()
        self.cipher_suite = Fernet(base64.urlsafe_b64encode(key[:32]))
    
    def encrypt(self, data):
        """رمزنگاری داده"""
        if not data:
            return None
        return self.cipher_suite.encrypt(str(data).encode()).decode()
    
    def decrypt(self, encrypted_data):
        """رمزگشایی داده"""
        if not encrypted_data:
            return None
        return self.cipher_suite.decrypt(encrypted_data.encode()).decode()

# models.py - فیلد رمزنگاری شده
class EncryptedField(models.TextField):
    """فیلد رمزنگاری شده سفارشی"""
    def __init__(self, *args, **kwargs):
        self.encryptor = DataEncryption()
        super().__init__(*args, **kwargs)
    
    def from_db_value(self, value, expression, connection):
        if value is None:
            return value
        return self.encryptor.decrypt(value)
    
    def to_python(self, value):
        if isinstance(value, str) and value:
            return self.encryptor.decrypt(value)
        return value
    
    def get_prep_value(self, value):
        if value is None:
            return value
        return self.encryptor.encrypt(value)

# استفاده در مدل
class CitizenProfile(BaseModel):
    name = models.CharField(max_length=100)
    national_id = EncryptedField()  # رمزنگاری شده
    phone = EncryptedField()  # رمزنگاری شده
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">📋 سیستم Audit Logging</div>
                    <div class="code-block">
# audit/models.py
class AuditLog(BaseModel):
    """لاگ حسابرسی"""
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    action = models.CharField(max_length=50)
    resource_type = models.CharField(max_length=100)
    resource_id = models.UUIDField(null=True, blank=True)
    field_name = models.CharField(max_length=100, null=True, blank=True)
    old_value = models.TextField(null=True, blank=True)
    new_value = models.TextField(null=True, blank=True)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    location = models.PointField(null=True, blank=True)
    
    class Meta:
        indexes = [
            models.Index(fields=['user', 'created_at']),
            models.Index(fields=['resource_type', 'created_at']),
            models.Index(fields=['action', 'created_at']),
        ]

# audit/services.py
class AuditService:
    @staticmethod
    def log_access(user, action, resource_type, resource_id=None, 
                   field_name=None, request=None):
        """ثبت لاگ دسترسی"""
        
        ip_address = None
        user_agent = ""
        
        if request:
            ip_address = request.META.get('HTTP_X_FORWARDED_FOR') or \
                        request.META.get('REMOTE_ADDR')
            user_agent = request.META.get('HTTP_USER_AGENT', '')
        
        AuditLog.objects.create(
            organization=user.organization,
            user=user,
            action=action,
            resource_type=resource_type,
            resource_id=resource_id,
            field_name=field_name,
            ip_address=ip_address,
            user_agent=user_agent,
            location=user.last_known_location
        )
    
    @staticmethod
    def log_field_access(user, resource_type, field_name, 
                        old_value=None, new_value=None, request=None):
        """ثبت لاگ دسترسی به فیلد"""
        AuditService.log_access(
            user=user,
            action='field_access',
            resource_type=resource_type,
            field_name=field_name,
            request=request
        )
        
        # ثبت تغییرات
        if old_value is not None or new_value is not None:
            AuditLog.objects.create(
                organization=user.organization,
                user=user,
                action='field_update',
                resource_type=resource_type,
                field_name=field_name,
                old_value=str(old_value) if old_value else None,
                new_value=str(new_value) if new_value else None,
                ip_address=request.META.get('REMOTE_ADDR') if request else None,
                user_agent=request.META.get('HTTP_USER_AGENT', '') if request else "",
                location=user.last_known_location
            )

# استفاده در views
def get_citizen_profile(request, citizen_id):
    # ثبت لاگ دسترسی
    AuditService.log_access(
        user=request.user,
        action='view',
        resource_type='CitizenProfile',
        resource_id=citizen_id,
        request=request
    )
    
    # ادامه پردازش...
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Enhancements -->
        <div class="model-section">
            <div class="model-header">
                <h2>🔮 ویژگی‌های آینده</h2>
                <span class="badge">Roadmap</span>
            </div>
            <div class="model-content">
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🤖</div>
                        <h4>هوش مصنوعی</h4>
                        <p>تشخیص الگوهای مشکوک و پیش‌بینی تهدیدات</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📱</div>
                        <h4>اپلیکیشن موبایل</h4>
                        <p>اپ موبایل برای مدیریت دسترسی‌ها</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔗</div>
                        <h4>Blockchain</h4>
                        <p>ثبت تغییرات در بلاک‌چین برای امنیت بالاتر</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">☁️</div>
                        <h4>Cloud Native</h4>
                        <p>پشتیبانی کامل از معماری کلود</p>
                    </div>
                </div>

                <div class="success-box">
                    <strong>✨ نسخه‌های آینده شامل:</strong>
                    <ul>
                        <li>تحلیل رفتار کاربران با Machine Learning</li>
                        <li>اتصال به سیستم‌های بیومتریک</li>
                        <li>پشتیبانی از IoT و دستگاه‌های هوشمند</li>
                        <li>پشتیبانی از IoT و دستگاه‌های هوشمند</li>
                        <li>داشبورد تحلیلی پیشرفته با نمودارهای تعاملی</li>
                        <li>اتصال به سیستم‌های مدیریت هویت خارجی (LDAP, Active Directory)</li>
                        <li>قابلیت‌های Workflow و تایید چندمرحله‌ای</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Deployment Guide -->
        <div class="model-section">
            <div class="model-header">
                <h2>🚀 راهنمای استقرار Production</h2>
                <span class="badge">Deployment</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">🐳 Docker Configuration</div>
                    <div class="code-block">
# Dockerfile
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gdal-bin \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create non-root user
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "project.wsgi:application"]
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🔧 docker-compose.yml</div>
                    <div class="code-block">
version: '3.8'

services:
  db:
    image: postgis/postgis:15-3.3
    environment:
      POSTGRES_DB: location_auth_system
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=False
      - DATABASE_URL=postgres://postgres:${DB_PASSWORD}@db:5432/location_auth_system
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    depends_on:
      - db
      - redis
    volumes:
      - ./media:/app/media
      - ./static:/app/static

  celery:
    build: .
    command: celery -A project worker -l info
    environment:
      - DATABASE_URL=postgres://postgres:${DB_PASSWORD}@db:5432/location_auth_system
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - ./static:/var/www/static
    depends_on:
      - web

volumes:
  postgres_data:
  redis_data:
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">⚙️ تنظیمات Production</div>
                    <div class="code-block">
# settings/production.py
import os
from .base import *

DEBUG = False
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', '').split(',')

# Database
DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis',
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('DB_USER'),
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT', '5432'),
        'OPTIONS': {
            'sslmode': 'require',
        },
    }
}

# Cache
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.getenv('REDIS_URL'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# Security
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True

# Logging
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': '/var/log/django/app.log',
            'formatter': 'verbose',
        },
        'security_file': {
            'level': 'WARNING',
            'class': 'logging.FileHandler',
            'filename': '/var/log/django/security.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
        'django.security': {
            'handlers': ['security_file'],
            'level': 'WARNING',
            'propagate': False,
        },
        'audit': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring -->
        <div class="model-section">
            <div class="model-header">
                <h2>📊 نظارت و مانیتورینگ</h2>
                <span class="badge">Monitoring</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">📈 متریک‌های کلیدی</div>
                    <div class="code-block">
# monitoring/metrics.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
import json

class SystemMetrics:
    @staticmethod
    def get_daily_stats():
        """آمار روزانه سیستم"""
        today = timezone.now().date()
        yesterday = today - timedelta(days=1)
        
        stats = {
            "date": str(today),
            "users": {
                "total_active": User.objects.filter(is_active=True).count(),
                "logged_in_today": User.objects.filter(
                    last_login__date=today
                ).count(),
                "failed_logins": User.objects.filter(
                    failed_login_attempts__gt=0
                ).count()
            },
            "access_control": {
                "total_roles": Role.objects.count(),
                "active_assignments": UserRole.objects.filter(
                    valid_from__lte=timezone.now(),
                    valid_until__gte=timezone.now(),
                    is_active=True
                ).count(),
                "expired_assignments": UserRole.objects.filter(
                    valid_until__lt=timezone.now()
                ).count()
            },
            "security": {
                "security_alerts": SecurityAlert.objects.filter(
                    created_at__date=today,
                    is_resolved=False
                ).count(),
                "audit_logs": AuditLog.objects.filter(
                    created_at__date=today
                ).count()
            },
            "geographic": {
                "total_zones": GeographicZone.objects.count(),
                "users_with_location": User.objects.filter(
                    last_known_location__isnull=False
                ).count()
            }
        }
        
        return stats
    
    @staticmethod
    def get_performance_metrics():
        """متریک‌های عملکرد"""
        from django.db import connection
        
        with connection.cursor() as cursor:
            # میانگین زمان پاسخ کوئری‌ها
            cursor.execute("""
                SELECT 
                    AVG(query_time) as avg_query_time,
                    MAX(query_time) as max_query_time,
                    COUNT(*) as total_queries
                FROM django_slow_queries 
                WHERE created_at >= NOW() - INTERVAL '1 hour'
            """)
            
            query_stats = cursor.fetchone()
        
        return {
            "database": {
                "avg_query_time": query_stats[0] if query_stats[0] else 0,
                "max_query_time": query_stats[1] if query_stats[1] else 0,
                "total_queries": query_stats[2] if query_stats[2] else 0
            },
            "cache": {
                "hit_rate": get_cache_hit_rate(),
                "memory_usage": get_cache_memory_usage()
            }
        }

def get_cache_hit_rate():
    """محاسبه نرخ hit کش"""
    # پیاده‌سازی بر اساس Redis INFO
    import redis
    r = redis.Redis()
    info = r.info()
    
    hits = info.get('keyspace_hits', 0)
    misses = info.get('keyspace_misses', 0)
    
    if hits + misses == 0:
        return 0
    
    return (hits / (hits + misses)) * 100

# management/commands/generate_metrics.py
class Command(BaseCommand):
    help = 'Generate system metrics'
    
    def handle(self, *args, **options):
        metrics = SystemMetrics.get_daily_stats()
        performance = SystemMetrics.get_performance_metrics()
        
        report = {
            "timestamp": timezone.now().isoformat(),
            "system_stats": metrics,
            "performance": performance
        }
        
        # ذخیره در فایل
        with open(f'/var/log/metrics/metrics_{timezone.now().date()}.json', 'w') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        self.stdout.write(
            self.style.SUCCESS('Metrics generated successfully')
        )
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🚨 هشدارهای خودکار</div>
                    <div class="code-block">
# monitoring/alerts.py
class AlertManager:
    THRESHOLDS = {
        'failed_logins': 10,
        'response_time': 2000,  # milliseconds
        'disk_usage': 85,  # percentage
        'memory_usage': 90,  # percentage
    }
    
    @staticmethod
    def check_security_alerts():
        """بررسی هشدارهای امنیتی"""
        alerts = []
        
        # کاربران با تلاش‌های ناموفق زیاد
        suspicious_users = User.objects.filter(
            failed_login_attempts__gte=AlertManager.THRESHOLDS['failed_logins']
        )
        
        for user in suspicious_users:
            alerts.append({
                'type': 'security',
                'severity': 'high',
                'message': f'کاربر {user.username} دارای {user.failed_login_attempts} تلاش ناموفق',
                'user_id': str(user.id),
                'timestamp': timezone.now()
            })
        
        # دسترسی‌های خارج از محدوده
        recent_access = AuditLog.objects.filter(
            created_at__gte=timezone.now() - timedelta(hours=1),
            action='location_violation'
        )
        
        for log in recent_access:
            alerts.append({
                'type': 'location_violation',
                'severity': 'medium',
                'message': f'دسترسی خارج از محدوده توسط {log.user.username}',
                'user_id': str(log.user.id),
                'location': f"{log.location.x}, {log.location.y}" if log.location else None,
                'timestamp': log.created_at
            })
        
        return alerts
    
    @staticmethod
    def send_alert_notifications(alerts):
        """ارسال اعلان‌های هشدار"""
        for alert in alerts:
            if alert['severity'] == 'high':
                # ارسال SMS و ایمیل فوری
                send_emergency_notification(alert)
            elif alert['severity'] == 'medium':
                # ارسال ایمیل
                send_email_notification(alert)
            
            # ثبت در سیستم
            SecurityAlert.objects.create(
                alert_type=alert['type'],
                severity=alert['severity'],
                message=alert['message'],
                details=alert
            )

# Celery task برای بررسی دوره‌ای
@shared_task
def check_system_alerts():
    """تسک دوره‌ای بررسی هشدارها"""
    alerts = AlertManager.check_security_alerts()
    
    if alerts:
        AlertManager.send_alert_notifications(alerts)
        
        # لاگ کردن
        logger.warning(f"Generated {len(alerts)} alerts", extra={
            'alerts': alerts
        })
    
    return f"Processed {len(alerts)} alerts"
                    </div>
                </div>
            </div>
        </div>

        <!-- API Documentation -->
        <div class="model-section">
            <div class="model-header">
                <h2>📚 مستندات API</h2>
                <span class="badge">API Docs</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">🔐 Authentication Endpoints</div>
                    <div class="code-block">
# POST /api/auth/location-login/
{
    "username": "john_doe",
    "password": "secure_password",
    "location": {
        "latitude": 35.7219,
        "longitude": 51.3347
    },
    "device_info": {
        "device_id": "unique_device_id",
        "platform": "web",
        "user_agent": "Mozilla/5.0..."
    }
}

# Response
{
    "success": true,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "user": {
        "id": "uuid-here",
        "username": "john_doe",
        "full_name": "John Doe",
        "organization": "Tehran Municipality",
        "current_zone": "Region 1"
    },
    "permissions": {
        "roles": ["GIS Expert", "Data Analyst"],
        "can_access": ["maps", "reports", "citizen_data"],
        "restrictions": {
            "working_hours": "08:00-16:00",
            "allowed_zones": ["region_1", "central_office"]
        }
    },
    "expires_in": 3600
}

# POST /api/auth/refresh/
{
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}

# POST /api/auth/logout/
{
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🔍 Permission Check Endpoints</div>
                    <div class="code-block">
# POST /api/permissions/check/
{
    "resource_type": "CitizenProfile",
    "field_name": "national_id",
    "action": "read",
    "context": {
        "citizen_id": "uuid-here",
        "purpose": "verification"
    }
}

# Response
{
    "allowed": true,
    "masking": {
        "rule": "partial",
        "pattern": "***-***-{last_3}"
    },
    "conditions": {
        "audit_required": true,
        "purpose_required": true,
        "time_limit": 300
    },
    "role": "Data Analyst",
    "expires_at": "2024-01-15T16:00:00Z"
}

# POST /api/permissions/bulk-check/
{
    "checks": [
        {
            "resource_type": "CitizenProfile",
            "field_name": "national_id",
            "action": "read"
        },
        {
            "resource_type": "CitizenProfile", 
            "field_name": "phone",
            "action": "update"
        }
    ]
}

# Response
{
    "results": {
        "CitizenProfile.national_id": {
            "allowed": true,
            "masking": {"rule": "partial"}
        },
        "CitizenProfile.phone": {
            "allowed": false,
            "reason": "insufficient_privileges"
        }
    }
}
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🗺️ Geographic Endpoints</div>
                    <div class="code-block">
# GET /api/zones/
# Response
{
    "zones": [
        {
            "id": "uuid-here",
            "name": "Region 1 Tehran",
            "type": "polygon",
            "bounds": {
                "north": 35.8,
                "south": 35.7,
                "east": 51.5,
                "west": 51.4
            },
            "properties": {
                "population": 280000,
                "area_km2": 47.8
            }
        }
    ]
}

# POST /api/location/update/
{
    "latitude": 35.7219,
    "longitude": 51.3347,
    "accuracy": 10,
    "timestamp": "2024-01-15T14:30:00Z"
}

# GET /api/location/validate/
# Query params: lat=35.7219&lng=51.3347
# Response
{
    "valid": true,
    "zone": {
        "id": "uuid-here",
        "name": "Central Office",
        "type": "circle"
    },
    "distance_to_center": 25.5,
    "allowed_actions": ["read", "update"]
}
                    </div>
                </div>
            </div>
        </div>

        <!-- Best Practices -->
        <div class="model-section">
            <div class="model-header">
                <h2>✨ بهترین شیوه‌ها</h2>
                <span class="badge">Best Practices</span>
            </div>
            <div class="model-content">
                <div class="success-box">
                    <strong>🎯 اصول طراحی:</strong>
                    <ul>
                        <li><strong>Principle of Least Privilege:</strong> کمترین دسترسی لازم</li>
                        <li><strong>Defense in Depth:</strong> چندین لایه امنیتی</li>
                        <li><strong>Zero Trust:</strong> هیچ‌چیز را بدون تایید باور نکن</li>
                        <li><strong>Fail Secure:</strong> در صورت خرابی، امن باش</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <strong>⚠️ نکات مهم:</strong>
                    <ul>
                        <li>همیشه input validation انجام دهید</li>
                        <li>از SQL injection محافظت کنید</li>
                        <li>داده‌های حساس را رمزنگاری کنید</li>
                        <li>تمام عملیات را لاگ کنید</li>
                        <li>از HTTPS استفاده کنید</li>
                        <li>رمزهای عبور قوی اجباری کنید</li>
                    </ul>
                </div>

                <div class="info-box">
                    <strong>📋 چک‌لیست پیاده‌سازی:</strong>
                    <ul>
                        <li>✅ تست‌های امنیتی انجام شده</li>
                        <li>✅ مستندات کامل نوشته شده</li>
                        <li>✅ سیستم مانیتورینگ راه‌اندازی شده</li>
                        <li>✅ بک‌آپ خودکار تنظیم شده</li>
                        <li>✅ SSL/TLS پیکربندی شده</li>
                        <li>✅ Rate limiting فعال شده</li>
                        <li>✅ Audit logging راه‌اندازی شده</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Conclusion -->
        <div class="conclusion-section">
            <h2>🎉 نتیجه‌گیری نهایی</h2>
            <p>
                سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی که در این مستند ارائه شد، یک راه‌حل 
                <span class="highlight">جامع، امن و قابل تطبیق</span> برای سازمان‌های مختلف است.
            </p>
            
            <div class="final-stats">
                <div class="stat-item">
                    <div class="stat-number">7</div>
                    <div class="stat-label">مدل کلیدی</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">50+</div>
                    <div class="stat-label">فیلد طراحی شده</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">∞</div>
                    <div class="stat-label">قابلیت تطبیق</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">100%</div>
                    <div class="stat-label">امنیت</div>
                </div>
            </div>

            <div class="final-message">
                <p>
                    این سیستم با استفاده از تکنولوژی‌های مدرن مانند Django، PostGIS، و Redis طراحی شده 
                    و قابلیت پشتیبانی از هزاران کاربر همزمان را دارد. با پیروی از اصول امنیتی و 
                    بهترین شیوه‌های صنعت، این راه‌حل می‌تواند نیازهای پیچیده سازمان‌های بزرگ را برآورده کند.
                </p>
                
                <div class="contact-info">
                    <h3>📞 پشتیبانی و مشاوره</h3>
                    <p>برای اطلاعات بیشتر و مشاوره پیاده‌سازی، با تیم توسعه در تماس باشید.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>🔗 لینک‌های مفید</h4>
                    <ul>
                        <li><a href="#organization">مدل Organization</a></li>
                        <li><a href="#user">مدل User</a></li>
                        <li><a href="#role">مدل Role</a></li>
                        <li><a href="#scenarios">سناریوهای کاربردی</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>📚 منابع</h4>
                    <ul>
                        <li><a href="https://docs.djangoproject.com/" target="_blank">Django Documentation</a></li>
                        <li><a href="https://postgis.net/" target="_blank">PostGIS</a></li>
                        <li><a href="https://redis.io/" target="_blank">Redis</a></li>
                        <li><a href="https://www.django-rest-framework.org/" target="_blank">Django REST Framework</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>🛠️ ابزارها</h4>
                    <ul>
                        <li>Django 4.2+</li>
                        <li>PostgreSQL + PostGIS</li>
                        <li>Redis Cache</li>
                        <li>Celery</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی - طراحی شده با ❤️ برای Django</p>
            </div>
        </footer>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">↑</button>

    <!-- JavaScript -->
    <script>
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Back to top button functionality
        window.onscroll = function() {
            const backToTopButton = document.getElementById('backToTop');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.style.display = 'block';
            } else {
                backToTopButton.style.display = 'none';
            }
        };

        function scrollToTop() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }

        // Code block copy functionality
        document.querySelectorAll('.code-block').forEach(block => {
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerHTML = '📋 کپی';
            copyButton.onclick = function() {
                navigator.clipboard.writeText(block.textContent).then(() => {
                    copyButton.innerHTML = '✅ کپی شد';
                    setTimeout(() => {
                        copyButton.innerHTML = '📋 کپی';
                    }, 2000);
                });
            };
            block.style.position = 'relative';
            block.appendChild(copyButton);
        });

        // Progress bar
        window.addEventListener('scroll', function() {
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const progress = (scrollTop / scrollHeight) * 100;
            
            let progressBar = document.getElementById('progressBar');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.id = 'progressBar';
                progressBar.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: ${progress}%;
                    height: 4px;
                    background: linear-gradient(90deg, #4CAF50, #2196F3);
                    z-index: 9999;
                    transition: width 0.3s ease;
                `;
                document.body.appendChild(progressBar);
            } else {
                progressBar.style.width = progress + '%';
            }
        });

        // Print functionality
        function printDocument() {
            window.print();
        }

        // Add print button
        const printButton = document.createElement('button');
        printButton.innerHTML = '🖨️ چاپ';
        printButton.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-family: 'Vazir', sans-serif;
        `;
        printButton.onclick = printDocument;
        document.body.appendChild(printButton);
    </script>

    <!-- Print Styles -->
    <style media="print">
        .navigation, .back-to-top, .copy-button, #progressBar, button {
            display: none !important;
        }
        
        .container {
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .model-section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .code-block {
            Hello! I'm Claude 4 Sonnet by Anthropic. I see you'd like me to continue completing the HTML code for the location-based authentication system documentation. Let me continue from where it left off:

```html
                        <li>پشتیبانی از IoT و دستگاه‌های هوشمند</li>
                        <li>داشبورد تحلیلی پیشرفته با نمودارهای تعاملی</li>
                        <li>یکپارچه‌سازی با سیستم‌های مدیریت هویت خارجی (LDAP, Active Directory)</li>
                        <li>پشتیبانی از استانداردهای بین‌المللی امنیت (OAuth 2.0, SAML)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Best Practices -->
        <div class="model-section">
            <div class="model-header">
                <h2>💡 بهترین شیوه‌های پیاده‌سازی</h2>
                <span class="badge">Best Practices</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">🏗️ معماری پیشنهادی</div>
                    <div class="code-block">
# پروژه ساختار
location_auth_system/
├── config/
│   ├── settings/
│   │   ├── base.py
│   │   ├── development.py
│   │   ├── production.py
│   │   └── testing.py
│   ├── urls.py
│   └── wsgi.py
├── apps/
│   ├── core/
│   │   ├── models.py      # مدل‌های اصلی
│   │   ├── managers.py    # کوئری‌های سفارشی
│   │   ├── permissions.py # کلاس‌های مجوز
│   │   └── validators.py  # اعتبارسنجی‌ها
│   ├── authentication/
│   │   ├── views.py       # API های احراز هویت
│   │   ├── serializers.py # سریالایزرها
│   │   └── services.py    # منطق کسب و کار
│   ├── audit/
│   │   ├── models.py      # مدل‌های حسابرسی
│   │   ├── services.py    # سرویس‌های لاگ
│   │   └── reports.py     # گزارش‌گیری
│   └── notifications/
│       ├── models.py      # مدل‌های اعلان
│       ├── services.py    # سرویس‌های اعلان
│       └── consumers.py   # WebSocket consumers
├── utils/
│   ├── cache.py          # مدیریت کش
│   ├── encryption.py     # رمزنگاری
│   ├── gis_utils.py      # ابزارهای GIS
│   └── permissions.py    # ابزارهای مجوز
├── tests/
│   ├── test_models.py
│   ├── test_api.py
│   ├── test_permissions.py
│   └── test_security.py
└── requirements/
    ├── base.txt
    ├── development.txt
    └── production.txt
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">⚙️ تنظیمات پیداکشن</div>
                    <div class="code-block">
# settings/production.py
import os
from .base import *

# امنیت
DEBUG = False
ALLOWED_HOSTS = ['your-domain.com', 'api.your-domain.com']

# دیتابیس
DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis',
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '5432'),
        'CONN_MAX_AGE': 60,
        'OPTIONS': {
            'MAX_CONNS': 20,
            'sslmode': 'require',
        }
    }
}

# کش
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.environ.get('REDIS_URL', 'redis://localhost:6379/1'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 50,
                'retry_on_timeout': True,
            }
        }
    }
}

# لاگ‌ها
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': '/var/log/django/location_auth.log',
            'maxBytes': 1024*1024*15,  # 15MB
            'backupCount': 10,
            'formatter': 'verbose',
        },
        'security': {
            'level': 'WARNING',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': '/var/log/django/security.log',
            'maxBytes': 1024*1024*15,
            'backupCount': 10,
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django.security': {
            'handlers': ['security'],
            'level': 'WARNING',
            'propagate': False,
        },
        'location_auth': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}

# امنیت اضافی
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
X_FRAME_OPTIONS = 'DENY'
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🐳 Docker Configuration</div>
                    <div class="code-block">
# Dockerfile
FROM python:3.11-slim

# نصب وابستگی‌های سیستم
RUN apt-get update && apt-get install -y \
    gdal-bin \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# نصب وابستگی‌های Python
COPY requirements/production.txt .
RUN pip install --no-cache-dir -r production.txt

# کپی کد
COPY . .

# تنظیمات
ENV DJANGO_SETTINGS_MODULE=config.settings.production
ENV PYTHONPATH=/app

# پورت
EXPOSE 8000

# اجرا
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "config.wsgi:application"]

# docker-compose.yml
version: '3.8'

services:
  db:
    image: postgis/postgis:14-3.2
    environment:
      POSTGRES_DB: location_auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  web:
    build: .
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    environment:
      - DB_HOST=db
      - REDIS_URL=redis://redis:6379/1

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - web

volumes:
  postgres_data:
  static_volume:
  media_volume:
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring -->
        <div class="model-section">
            <div class="model-header">
                <h2>📊 مانیتورینگ و نظارت</h2>
                <span class="badge">Monitoring</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">📈 متریک‌های کلیدی</div>
                    <div class="code-block">
# monitoring/metrics.py
from django.db import models
from django.utils import timezone
from datetime import timedelta

class SystemMetrics:
    """محاسبه متریک‌های سیستم"""
    
    @staticmethod
    def get_daily_stats(date=None):
        """آمار روزانه"""
        if not date:
            date = timezone.now().date()
        
        start_date = timezone.datetime.combine(date, timezone.datetime.min.time())
        end_date = start_date + timedelta(days=1)
        
        stats = {
            'total_logins': User.objects.filter(
                last_login__gte=start_date,
                last_login__lt=end_date
            ).count(),
            
            'failed_attempts': User.objects.filter(
                failed_login_attempts__gt=0
            ).count(),
            
            'active_sessions': UserRole.objects.filter(
                valid_from__lte=timezone.now(),
                valid_until__gte=timezone.now(),
                is_active=True
            ).count(),
            
            'security_alerts': SecurityAlert.objects.filter(
                created_at__gte=start_date,
                created_at__lt=end_date
            ).count(),
            
            'permission_checks': AuditLog.objects.filter(
                action='permission_check',
                created_at__gte=start_date,
                created_at__lt=end_date
            ).count()
        }
        
        return stats
    
    @staticmethod
    def get_performance_metrics():
        """متریک‌های عملکرد"""
        from django.db import connection
        
        with connection.cursor() as cursor:
            # متوسط زمان پاسخ کوئری‌ها
            cursor.execute("""
                SELECT 
                    AVG(query_time) as avg_query_time,
                    MAX(query_time) as max_query_time,
                    COUNT(*) as total_queries
                FROM django_slow_query_log 
                WHERE created_at >= NOW() - INTERVAL '1 hour'
            """)
            
            query_stats = cursor.fetchone()
        
        return {
            'avg_query_time': query_stats[0] or 0,
            'max_query_time': query_stats[1] or 0,
            'total_queries': query_stats[2] or 0,
            'cache_hit_rate': cache.get('cache_hit_rate', 0),
            'memory_usage': get_memory_usage(),
        }

# monitoring/views.py
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAdminUser
from rest_framework.response import Response

@api_view(['GET'])
@permission_classes([IsAdminUser])
def system_health(request):
    """وضعیت سلامت سیستم"""
    
    health_status = {
        'database': check_database_health(),
        'cache': check_cache_health(),
        'storage': check_storage_health(),
        'external_services': check_external_services(),
        'overall': 'healthy'
    }
    
    # تعیین وضعیت کلی
    if any(status != 'healthy' for status in health_status.values() if status != 'overall'):
        health_status['overall'] = 'degraded'
    
    return Response(health_status)

def check_database_health():
    """بررسی سلامت دیتابیس"""
    try:
        from django.db import connection
        with connection.cursor() as cursor:
            cursor.execute("SELECT 1")
        return 'healthy'
    except Exception:
        return 'unhealthy'

def check_cache_health():
    """بررسی سلامت کش"""
    try:
        from django.core.cache import cache
        cache.set('health_check', 'ok', 10)
        if cache.get('health_check') == 'ok':
            return 'healthy'
        return 'unhealthy'
    except Exception:
        return 'unhealthy'
                    </div>
                </div>

                <div class="info-box">
                    <strong>📊 متریک‌های مهم برای نظارت:</strong>
                    <ul>
                        <li><span class="highlight">تعداد ورودهای موفق/ناموفق</span> در بازه‌های زمانی مختلف</li>
                        <li><span class="highlight">زمان پاسخ‌دهی</span> API های مختلف</li>
                        <li><span class="highlight">تعداد بررسی مجوزها</span> و نرخ موفقیت</li>
                        <li><span class="highlight">استفاده از منابع</span> (CPU, Memory, Database)</li>
                        <li><span class="highlight">هشدارهای امنیتی</span> و تعداد تهدیدات شناسایی شده</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="model-section">
            <div class="model-header">
                <h2>🔧 عیب‌یابی و حل مشکلات</h2>
                <span class="badge">Troubleshooting</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">🚨 مشکلات رایج و راه‌حل‌ها</div>
                    <div class="code-block">
# مشکل 1: کندی در بررسی مجوزها
# علت: عدم استفاده از کش و کوئری‌های ناکارآمد
# راه‌حل:
def optimize_permission_check():
    # 1. فعال‌سازی کش
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': 'redis://127.0.0.1:6379/1',
            'TIMEOUT': 300,  # 5 دقیقه
        }
    }
    
    # 2. بهینه‌سازی کوئری‌ها
    def get_user_permissions_optimized(user):
        cache_key = f"user_permissions_{user.id}"
        permissions = cache.get(cache_key)
        
        if permissions is None:
            permissions = UserRole.objects.select_related(
                'role', 'role__group'
            ).prefetch_related(
                'geographic_zones', 'role__fieldpermission_set'
            ).filter(user=user, is_active=True)
            
            cache.set(cache_key, permissions, timeout=300)
        
        return permissions

# مشکل 2: خطای موقعیت جغرافیایی
# علت: مشکل در محاسبه فاصله یا تنظیمات GIS
# راه‌حل:
def debug_location_issue(user_location, allowed_zones):
    """عیب‌یابی مشکلات موقعیت"""
    
    print(f"موقعیت کاربر: {user_location}")
    print(f"تعداد محدوده‌های مجاز: {len(allowed_zones)}")
    
    for zone in allowed_zones:
        if zone.zone_type == 'circle':
            distance = zone.center_point.distance(user_location) * 111000  # تبدیل به متر
            print(f"محدوده {zone.name}: فاصله = {distance:.2f}m, شعاع = {zone.radius}m")
            
            if distance <= zone.radius:
                print(f"✅ کاربر در محدوده {zone.name} قرار دارد")
                return True
            else:
                print(f"❌ کاربر خارج از محدوده {zone.name} است")
        
        elif zone.zone_type == 'polygon' and zone.polygon:
            contains = zone.polygon.contains(user_location)
            print(f"محدوده {zone.name} (چندضلعی): {contains}")
            
            if contains:
                return True
    
    return False

# مشکل 3: مشکلات امنیتی
# علت: تنظیمات ناکافی امنیت
# راه‌حل:
def security_hardening_checklist():
    """چک‌لیست تقویت امنیت"""
    
    checks = {
        'https_enabled': settings.SECURE_SSL_REDIRECT,
        'debug_disabled': not settings.DEBUG,
        'secret_key_secure': len(settings.SECRET_KEY) >= 50,
        'database_password_set': bool(settings.DATABASES['default']['PASSWORD']),
        'allowed_hosts_configured': len(settings.ALLOWED_HOSTS) > 0,
        'csrf_protection': 'django.middleware.csrf.CsrfViewMiddleware' in settings.MIDDLEWARE,
        'session_security': settings.SESSION_COOKIE_SECURE,
        'xframe_protection': settings.X_FRAME_OPTIONS == 'DENY',
    }
    
    failed_checks = [check for check, passed in checks.items() if not passed]
    
    if failed_checks:
        print("⚠️ موارد امنیتی که نیاز به بررسی دارند:")
        for check in failed_checks:
            print(f"  - {check}")
    else:
        print("✅ تمام بررسی‌های امنیتی موفق بود")
    
    return len(failed_checks) == 0

# مشکل 4: مشکلات عملکرد دیتابیس
# علت: عدم وجود ایندکس مناسب
# راه‌حل:
def analyze_slow_queries():
    """تجزیه و تحلیل کوئری‌های کند"""
    
    from django.db import connection
    
    with connection.cursor() as cursor:
        # فعال‌سازی لاگ کوئری‌های کند در PostgreSQL
        cursor.execute("SET log_min_duration_statement = 1000;")  # کوئری‌های بالای 1 ثانیه
        
        # بررسی کوئری‌های اجرا شده
        cursor.execute("""
            SELECT query, mean_time, calls, total_time
            FROM pg_stat_statements 
            WHERE mean_time > 100 
            ORDER BY mean_time DESC 
            LIMIT 10;
        """)
        
        slow_queries = cursor.fetchall()
        
        print("🐌 کوئری‌های کند:")
        for query, mean_time, calls, total_time in slow_queries:
            print(f"متوسط زمان: {mean_time:.2f}ms | تعداد اجرا: {calls}")
            print(f"کوئری: {query[:100]}...")
            print("-" * 50)
                    </div>
                </div>

                <div class="warning-box">
                    <strong>🔍 نکات عیب‌یابی:</strong>
                    <ul>
                        <li><strong>لاگ‌ها را بررسی کنید:</strong> اولین قدم همیشه بررسی فایل‌های لاگ است</li>
                        <li><strong>محیط تست:</strong> مشکلات را ابتدا در محیط تست بازتولید کنید</li>
                        <li><strong>مانیتورینگ:</strong> از ابزارهای مانیتورینگ برای شناسایی مشکلات استفاده کنید</li>
                        <li><strong>بکاپ:</strong> قبل از هر تغییر، حتماً بکاپ تهیه کنید</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Deployment Guide -->
        <div class="model-section">
            <div class="model-header">
                <h2>🚀 راهنمای استقرار</h2>
                <span class="badge">Deployment</span>
            </div>
            <div class="model-content">
                <div class="example-section">
                    <div class="example-title">☁️ استقرار در کلود</div>
                    <div class="code-block">
# استقرار در AWS
# 1. تنظیمات RDS (PostgreSQL با PostGIS)
resource "aws_db_instance" "location_auth_db" {
  identifier = "location-auth-db"
  engine     = "postgres"
  engine_version = "14.9"
  instance_class = "db.t3.medium"
  
  allocated_storage     = 100
  max_allocated_storage = 1000
  storage_type         = "gp2"
  storage_encrypted    = true
  
  db_name  = "location_auth"
  username = "postgres"
  password = var.db_password
  
  vpc_security_group_ids = [aws_security_group.rds.id]
  db_subnet_group_name   = aws_db_subnet_group.main.name
  
  backup_retention_period = 7
  backup_window          = "03:00-04:00"
  maintenance_window     = "sun:04:00-sun:05:00"
  
  skip_final_snapshot = false
  final_snapshot_identifier = "location-auth-final-snapshot"
  
  tags = {
    Name = "LocationAuth Database"
  }
}

# 2. تنظیمات ElastiCache (Redis)
resource "aws_elasticache_subnet_group" "main" {
  name       = "location-auth-cache-subnet"
  subnet_ids = var.private_subnet_ids
}

resource "aws_elasticache_cluster" "redis" {
  cluster_id           = "location-auth-redis"
  engine               = "redis"
  node_type            = "cache.t3.micro"
  num_cache_nodes      = 1
  parameter_group_name = "default.redis7"
  port                 = 6379
  subnet_group_name    = aws_elasticache_subnet_group.main.name
  security_group_ids   = [aws_security_group.redis.id]
}

# 3. ECS Service
resource "aws_ecs_service" "location_auth" {
  name            = "location-auth-service"
  cluster         = aws_ecs_cluster.main.id
  task_definition = aws_ecs_task_definition.location_auth.arn
  desired_count   = 2
  
  load_balancer {
    target_group_arn = aws_lb_target_group.location_auth.arn
    container_name   = "location-auth"
    container_port   = 8000
  }
  
  network_configuration {
    subnets         = var.private_subnet_ids
    security_groups = [aws_security_group.ecs_tasks.id]
  }
}
                    </div>
                </div>

                <div class="example-section">
                    <div class="example-title">🔄 CI/CD Pipeline</div>
                    <div class="code-block">
# .github/workflows/deploy.yml
name: Deploy Location Auth System

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgis/postgis:14-3.2
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gdal-bin libgdal-dev libgeos-dev libproj-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/testing.txt
    
    - name: Run tests
      env:
        DATABASE_URL: postgis://postgres:postgres@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        python manage.py migrate
        python manage.py test
    
    - name: Run security checks
      run: |
        bandit -r . -f json -o bandit-report.json
        safety check --json --output safety-report.json
    
    - name: Code quality check
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        black --check .
        isort --check-only .

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: location-auth-system
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to ECS
      run: |
        aws ecs update-service \
          --cluster location-auth-cluster \
          --service location-auth-service \
          --force-new-deployment
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Summary -->
        <div class="final-summary">
            <h2>🎯 نتیجه‌گیری نهایی</h2>
            <p>سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی که در این مستند ارائه شد، یک راه‌حل کامل و قابل اعتماد برای مدیریت امنیت و دسترسی در سازمان‌های مختلف است.</p>
            
            <div class="final-features">
                <div class="final-feature">
                    <div class="final-icon">🏗️</div>
                    <h3>معماری مقیاس‌پذیر</h3>
                    <p>طراحی شده برای رشد و توسعه آینده</p>
                </div>
                <div class="final-feature">
                    <div class="final-icon">🔐</div>
                    <h3>امنیت چندلایه</h3>
                    <p>حفاظت جامع از داده‌ها و دسترسی‌ها</p>
                </div>
                <div class="final-feature">
                    <div class="final-icon">🌍</div>
                    <h3>کنترل جغرافیایی</h3>
                    <p>مدیریت دقیق بر اساس موقعیت</p>
                </div>
                <div class="final-feature">
                    <div class="final-icon">📊</div>
                    <h3>نظارت هوشمند</h3>
        <p>مانیتورینگ و گزارش‌گیری پیشرفته</p>
                </div>
            </div>

            <div class="success-box">
                <h3>✨ ویژگی‌های کلیدی سیستم:</h3>
                <div class="features-summary">
                    <div class="feature-summary-item">
                        <span class="feature-number">7</span>
                        <span class="feature-desc">مدل داده‌ای اصلی</span>
                    </div>
                    <div class="feature-summary-item">
                        <span class="feature-number">50+</span>
                        <span class="feature-desc">فیلد و ویژگی</span>
                    </div>
                    <div class="feature-summary-item">
                        <span class="feature-number">∞</span>
                        <span class="feature-desc">قابلیت تطبیق</span>
                    </div>
                    <div class="feature-summary-item">
                        <span class="feature-number">100%</span>
                        <span class="feature-desc">پوشش امنیتی</span>
                    </div>
                </div>
            </div>

            <div class="implementation-roadmap">
                <h3>🗺️ نقشه راه پیاده‌سازی:</h3>
                <div class="roadmap-steps">
                    <div class="roadmap-step completed">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>طراحی مدل‌های داده</h4>
                            <p>تعریف ساختار دیتابیس و روابط</p>
                        </div>
                    </div>
                    <div class="roadmap-step completed">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>پیاده‌سازی احراز هویت</h4>
                            <p>سیستم ورود و مدیریت جلسات</p>
                        </div>
                    </div>
                    <div class="roadmap-step completed">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>موتور مجوزها</h4>
                            <p>کنترل دسترسی و بررسی مجوزها</p>
                        </div>
                    </div>
                    <div class="roadmap-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>تست و بهینه‌سازی</h4>
                            <p>آزمون عملکرد و امنیت</p>
                        </div>
                    </div>
                    <div class="roadmap-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <h4>استقرار و راه‌اندازی</h4>
                            <p>انتقال به محیط تولید</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="contact-section">
                <h3>📞 پشتیبانی و مشاوره</h3>
                <p>برای دریافت مشاوره تخصصی، پیاده‌سازی سفارشی یا پشتیبانی فنی، با تیم توسعه در ارتباط باشید.</p>
                
                <div class="contact-grid">
                    <div class="contact-item">
                        <div class="contact-icon">💬</div>
                        <h4>مشاوره فنی</h4>
                        <p>راهنمایی در انتخاب بهترین راه‌حل</p>
                    </div>
                    <div class="contact-item">
                        <div class="contact-icon">🛠️</div>
                        <h4>پیاده‌سازی سفارشی</h4>
                        <p>توسعه بر اساس نیازهای خاص</p>
                    </div>
                    <div class="contact-item">
                        <div class="contact-icon">🔧</div>
                        <h4>پشتیبانی فنی</h4>
                        <p>حل مشکلات و بروزرسانی‌ها</p>
                    </div>
                    <div class="contact-item">
                        <div class="contact-icon">📚</div>
                        <h4>آموزش</h4>
                        <p>دوره‌های آموزشی تخصصی</p>
                    </div>
                </div>
            </div>

            <div class="thanks-section">
                <h3>🙏 تشکر و قدردانی</h3>
                <p>
                    از شما که وقت خود را برای مطالعه این مستند اختصاص دادید، صمیمانه تشکر می‌کنیم. 
                    امیدواریم این راه‌حل بتواند نیازهای امنیتی و مدیریتی سازمان شما را به بهترین شکل پاسخ دهد.
                </p>
                
                <div class="final-quote">
                    <blockquote>
                        "امنیت واقعی زمانی حاصل می‌شود که تکنولوژی، فرآیند و انسان در هماهنگی کامل با یکدیگر عمل کنند."
                    </blockquote>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>🔗 منابع مفید</h4>
                    <ul>
                        <li><a href="https://docs.djangoproject.com/" target="_blank">Django Documentation</a></li>
                        <li><a href="https://www.django-rest-framework.org/" target="_blank">Django REST Framework</a></li>
                        <li><a href="https://postgis.net/" target="_blank">PostGIS</a></li>
                        <li><a href="https://redis.io/documentation" target="_blank">Redis Documentation</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>🛠️ تکنولوژی‌ها</h4>
                    <ul>
                        <li>Django 4.2+</li>
                        <li>PostgreSQL + PostGIS</li>
                        <li>Redis Cache</li>
                        <li>Celery</li>
                        <li>Docker</li>
                        <li>AWS/Cloud Services</li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>📊 آمار مستند</h4>
                    <ul>
                        <li>7 مدل داده‌ای اصلی</li>
                        <li>15+ سناریو کاربردی</li>
                        <li>50+ کد نمونه</li>
                        <li>100+ نکته تخصصی</li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>🌟 ویژگی‌های کلیدی</h4>
                    <ul>
                        <li>کنترل دسترسی مبتنی بر موقعیت</li>
                        <li>مدیریت نقش‌های پیچیده</li>
                        <li>امنیت چندلایه</li>
                        <li>مقیاس‌پذیری بالا</li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-divider"></div>
            
            <div class="footer-bottom">
                <div class="footer-logo">
                    <span class="logo-icon">🌍</span>
                    <span class="logo-text">سیستم کنترل دسترسی مبتنی بر موقعیت</span>
                </div>
                
                <div class="footer-meta">
                    <p>
                        © 2024 - طراحی و توسعه با ❤️ برای جامعه Django ایران
                        <br>
                        آخرین بروزرسانی: <span id="lastUpdate">29 سپتامبر 2025</span>
                    </p>
                </div>
                
                <div class="footer-badges">
                    <span class="badge-item">Django 4.2+</span>
                    <span class="badge-item">PostGIS</span>
                    <span class="badge-item">Redis</span>
                    <span class="badge-item">Docker Ready</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()" title="بازگشت به بالا">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- Floating Action Menu -->
    <div class="floating-menu">
        <button class="fab-main" onclick="toggleFabMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="1" fill="currentColor"/>
                <circle cx="19" cy="12" r="1" fill="currentColor"/>
                <circle cx="5" cy="12" r="1" fill="currentColor"/>
            </svg>
        </button>
        
        <div class="fab-menu" id="fabMenu">
            <button class="fab-item" onclick="printDocument()" title="چاپ مستند">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="6,9 6,2 18,2 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M6,18H4a2,2 0,0 1,-2-2V11a2,2 0,0 1,2-2H20a2,2 0,0 1,2,2v5a2,2 0,0 1,-2,2H18" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="6" y="14" width="12" height="8" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </button>
            
            <button class="fab-item" onclick="shareDocument()" title="اشتراک‌گذاری">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" stroke="currentColor" stroke-width="2"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" stroke="currentColor" stroke-width="2"/>
                </svg>
            </button>
            
            <button class="fab-item" onclick="downloadPDF()" title="دانلود PDF">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <button class="fab-item" onclick="toggleDarkMode()" title="حالت تاریک/روشن">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Back to top button functionality
        window.onscroll = function() {
            const backToTopButton = document.getElementById('backToTop');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.style.display = 'flex';
            } else {
                backToTopButton.style.display = 'none';
            }
        };

        function scrollToTop() {
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }

        // Progress bar
        window.addEventListener('scroll', function() {
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const progress = (scrollTop / scrollHeight) * 100;
            
            let progressBar = document.getElementById('progressBar');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.id = 'progressBar';
                progressBar.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: ${progress}%;
                    height: 4px;
                    background: linear-gradient(90deg, #4CAF50, #2196F3);
                    z-index: 9999;
                    transition: width 0.3s ease;
                `;
                document.body.appendChild(progressBar);
            } else {
                progressBar.style.width = progress + '%';
            }
        });

        // Code block copy functionality
        document.querySelectorAll('.code-block').forEach(block => {
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerHTML = '📋';
            copyButton.title = 'کپی کد';
            copyButton.onclick = function() {
                navigator.clipboard.writeText(block.textContent).then(() => {
                    copyButton.innerHTML = '✅';
                    copyButton.style.background = '#4CAF50';
                    setTimeout(() => {
                        copyButton.innerHTML = '📋';
                        copyButton.style.background = '#2196F3';
                    }, 2000);
                });
            };
            block.style.position = 'relative';
            block.appendChild(copyButton);
        });

        // Floating Action Button Menu
        function toggleFabMenu() {
            const fabMenu = document.getElementById('fabMenu');
            fabMenu.classList.toggle('active');
        }

        // Close FAB menu when clicking outside
        document.addEventListener('click', function(event) {
            const fabMenu = document.getElementById('fabMenu');
            const fabMain = document.querySelector('.fab-main');
            
            if (!fabMenu.contains(event.target) && !fabMain.contains(event.target)) {
                fabMenu.classList.remove('active');
            }
        });

        // Print functionality
        function printDocument() {
            window.print();
        }

        // Share functionality
        function shareDocument() {
            if (navigator.share) {
                navigator.share({
                    title: 'سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی',
                    text: 'مستند کامل پیاده‌سازی سیستم کنترل دسترسی با Django',
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('لینک در کلیپ‌بورد کپی شد!');
                });
            }
        }

        // Download PDF functionality
        function downloadPDF() {
            // This would typically integrate with a PDF generation service
            alert('قابلیت دانلود PDF به زودی اضافه خواهد شد!');
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // Search functionality
        function initializeSearch() {
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'جستجو در مستند...';
            searchInput.className = 'search-input';
            searchInput.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                width: 250px;
                padding: 10px;
                border: 2px solid #4CAF50;
                border-radius: 25px;
                font-family: 'Vazir', sans-serif;
                z-index: 1000;
                display: none;
            `;

            document.body.appendChild(searchInput);

            // Add search button to FAB menu
            const searchButton = document.createElement('button');
            searchButton.className = 'fab-item';
            searchButton.title = 'جستجو';
            searchButton.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/><path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2"/></svg>';
            searchButton.onclick = function() {
                searchInput.style.display = searchInput.style.display === 'none' ? 'block' : 'none';
                if (searchInput.style.display === 'block') {
                    searchInput.focus();
                }
            };

            document.getElementById('fabMenu').appendChild(searchButton);

            // Search functionality
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const sections = document.querySelectorAll('.model-section, .example-section');
                
                sections.forEach(section => {
                    const text = section.textContent.toLowerCase();
                    if (text.includes(searchTerm) || searchTerm === '') {
                        section.style.display = 'block';
                        section.style.opacity = '1';
                    } else {
                        section.style.opacity = '0.3';
                    }
                });
            });
        }

        // Initialize search when page loads
        document.addEventListener('DOMContentLoaded', initializeSearch);

        // Table of Contents generator
        function generateTOC() {
            const toc = document.createElement('div');
            toc.className = 'table-of-contents';
            toc.innerHTML = '<h3>فهرست مطالب</h3>';
            
            const headers = document.querySelectorAll('h2, h3');
            const tocList = document.createElement('ul');
            
            headers.forEach((header, index) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                
                // Create unique ID if doesn't exist
                if (!header.id) {
                    header.id = `section-${index}`;
                }
                
                a.href = `#${header.id}`;
                a.textContent = header.textContent;
                a.className = header.tagName.toLowerCase();
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
            
            toc.appendChild(tocList);
            
            // Insert TOC after header
            const header = document.querySelector('.header');
            header.insertAdjacentElement('afterend', toc);
        }

        // Initialize TOC
        document.addEventListener('DOMContentLoaded', generateTOC);

        // Lazy loading for code blocks
        function initializeLazyLoading() {
            const codeBlocks = document.querySelectorAll('.code-block');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('loaded');
                    }
                });
            });
            
            codeBlocks.forEach(block => {
                observer.observe(block);
            });
        }

        // Initialize lazy loading
        document.addEventListener('DOMContentLoaded', initializeLazyLoading);

        // Analytics (placeholder)
        function trackEvent(action, category, label) {
            // Integration with analytics service would go here
            console.log(`Event: ${action}, Category: ${category}, Label: ${label}`);
        }

        // Track user interactions
        document.addEventListener('click', function(e) {
            if (e.target.matches('a[href^="#"]')) {
                trackEvent('navigation', 'internal_link', e.target.getAttribute('href'));
            }
            
            if (e.target.matches('.copy-button')) {
                trackEvent('interaction', 'code_copy', 'code_block');
            }
        });

        // Performance monitoring
        window.addEventListener('load', function() {
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            console.log(`Page load time: ${loadTime}ms`);
            
            // Report performance metrics
            trackEvent('performance', 'page_load_time', Math.round(loadTime / 1000));
        });

        // Update last modified date
        document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('fa-IR');

        console.log('🌍 سیستم کنترل دسترسی مبتنی بر موقعیت جغرافیایی - آماده به کار!');
        console.log('📚 مستند کامل با ' + document.querySelectorAll('.model-section').length + ' بخش اصلی');
        console.log('🔧 ' + document.querySelectorAll('.code-block').length + ' نمونه کد ارائه شده');
    </script>

    <!-- Additional CSS for new features -->
    <style>
        /* Dark mode styles */
        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --accent-color: #4CAF50;
        }

        .dark-mode body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .dark-mode .model-section {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .code-block {
            background: #1e1e1e;
            border-color: var(--border-color);
        }

        /* Floating Action Button styles */
        .floating-menu {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-main:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .fab-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .fab-item {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-item:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        /* Table of Contents styles */
        .table-of-contents {
            background: #f8f9fa;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 300px;
            position: sticky;
            top: 20px;
            float: right;
            margin-left: 20px;
        }

        .table-of-contents h3 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .table-of-contents ul {
            list-style: none;
            padding: 0;
        }

        .table-of-contents li {
            margin: 8px 0;
        }

        .table-of-contents a {
            text-decoration: none;
            color: #333;
            padding: 5px 0;
            display: block;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .table-of-contents a:hover {
            background: #e8f5e8;
            padding-right: 10px;
        }

        .table-of-contents a.h3 {
            padding-right: 15px;
            font-size: 0.9em;
            color: #666;
        }

        /* Search input styles */
        .search-input {
            font-family: 'Vazir', sans-serif !important;
            direction: rtl;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        /* Lazy loading animation */
        .code-block {
            opacity: 0.7;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .code-block.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Print styles */
        @media print {
            .floating-menu,
            .back-to-top,
            .copy-button,
            #progressBar,
            .search-input,
            .table-of-contents {
                display: none !important;
            }
            
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .model-section {
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .code-block {
                background: #f5f5f5 !important;
                border: 1px solid #ddd !important;
                font-size: 10px !important;
                line-height: 1.2 !important;
            }
            
            .header {
                background: #4CAF50 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .table-of-contents {
                position: static;
                float: none;
                max-width: 100%;
                margin: 20px 0;
            }
            
            .floating-menu {
                bottom: 20px;
                left: 20px;
            }
            
            .fab-main {
                width: 48px;
                height: 48px;
            }
            
            .fab-item {
                width: 40px;
                height: 40px;
            }
            
            .search-input {
                width: calc(100% - 40px);
                right: 20px;
            }
        }
    </style>
</body>
</html>
