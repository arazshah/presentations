<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ - Django & DRF</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .section {
            background: white;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 5px solid #43a047;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header h2 {
            color: #2e7d32;
            font-size: 1.8em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .section-header .icon {
            background: #43a047;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 1.2em;
        }

        .section-content {
            padding: 30px;
        }

        .code-container {
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .code-header {
            background: #2d3748;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-header .file-name {
            font-family: 'Courier New', monospace;
            color: #68d391;
        }

        .code-header .copy-btn {
            background: #43a047;
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .code-header .copy-btn:hover {
            background: #2e7d32;
        }

        pre {
            margin: 0;
            background: #1a202c !important;
            padding: 20px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .explanation {
            background: #f8f9fa;
            border-right: 4px solid #43a047;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }

        .explanation h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .file-structure {
            background: #263238;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            line-height: 1.8;
        }

        .file-structure .folder {
            color: #ffd54f;
        }

        .file-structure .file {
            color: #81c784;
        }

        .file-structure .comment {
            color: #90a4ae;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: #43a047;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(67, 160, 71, 0.2);
        }

        .feature-card h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .feature-card .feature-icon {
            background: #43a047;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .steps {
            counter-reset: step-counter;
        }

        .step {
            counter-increment: step-counter;
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-right: 5px solid #43a047;
            position: relative;
        }

        .step::before {
            content: counter(step-counter);
            position: absolute;
            right: -15px;
            top: 20px;
            background: #43a047;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            margin-right: 20px;
        }

        .warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #e65100;
        }

        .success {
            background: #e8f5e9;
            border: 2px solid #43a047;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #1b5e20;
        }

        .info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #0d47a1;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        th {
            background: #43a047;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .navigation-menu {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 1000;
        }

        .nav-item {
            display: block;
            padding: 10px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px 0;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #43a047;
            color: white;
        }

        @media (max-width: 768px) {
            .navigation-menu {
                display: none;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            pre {
                font-size: 12px;
            }
        }

        .highlight {
            background: #fff59d;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <nav class="navigation-menu">
        <a href="#structure" class="nav-item">Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡</a>
        <a href="#models" class="nav-item">Ù…Ø¯Ù„â€ŒÙ‡Ø§</a>
        <a href="#serializers" class="nav-item">Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø±Ù‡Ø§</a>
        <a href="#views" class="nav-item">ÙˆÛŒÙˆÙ‡Ø§</a>
        <a href="#permissions" class="nav-item">Ù…Ø¬ÙˆØ²Ù‡Ø§</a>
        <a href="#urls" class="nav-item">URLÙ‡Ø§</a>
        <a href="#settings" class="nav-item">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a>
        <a href="#deployment" class="nav-item">Ø§Ø³ØªÙ‚Ø±Ø§Ø±</a>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ</h1>
            <p>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªÙˆØ³Ø¹Ù‡ Ø¨Ø§ Django & Django REST Framework</p>
        </div>

        <!-- Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡ -->
        <div class="section" id="structure">
            <div class="section-header">
                <h2><span class="icon">ğŸ“</span>Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Django</h4>
                    <p>Ø§ÛŒÙ† Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ù‡ØªØ±ÛŒÙ† Ø´ÛŒÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Django Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ùˆ Ø§Ù…Ú©Ø§Ù† Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø¨Ø§Ù„Ø§ Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
                </div>

                <div class="file-structure">
location_auth_system/
â”œâ”€â”€ manage.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env                          <span class="comment"># Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ</span>
â”œâ”€â”€ location_auth_system/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py              <span class="comment"># ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡</span>
â”‚   â”‚   â”œâ”€â”€ development.py       <span class="comment"># ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙˆØ³Ø¹Ù‡</span>
â”‚   â”‚   â””â”€â”€ production.py        <span class="comment"># ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙˆÙ„ÛŒØ¯</span>
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ wsgi.py
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ authentication/          <span class="comment"># Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</span>
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ permissions.py
â”‚   â”‚   â””â”€â”€ urls.py
â”‚   â”œâ”€â”€ locations/               <span class="comment"># Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§</span>
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ permissions.py
â”‚   â”‚   â””â”€â”€ urls.py
â”‚   â””â”€â”€ audit/                   <span class="comment"># Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ</span>
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ models.py
â”‚       â”œâ”€â”€ serializers.py
â”‚       â”œâ”€â”€ views.py
â”‚       â””â”€â”€ urls.py
â”œâ”€â”€ static/
â”œâ”€â”€ media/
â””â”€â”€ templates/
                </div>

                <div class="steps">
                    <div class="step">
                        <h3>Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Django</h3>
                        <div class="code-container">
                            <div class="code-header">
                                <span class="file-name">Terminal Commands</span>
                                <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                            </div>
                            <pre><code class="language-bash"># Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ
python -m venv location_auth_env
source location_auth_env/bin/activate  # Linux/Mac
# location_auth_env\Scripts\activate  # Windows

# Ù†ØµØ¨ Django Ùˆ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
pip install django djangorestframework
pip install django-cors-headers
pip install djangorestframework-simplejwt
pip install psycopg2-binary  # Ø¨Ø±Ø§ÛŒ PostgreSQL
pip install redis
pip install celery

# Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡
django-admin startproject location_auth_system
cd location_auth_system

# Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§
python manage.py startapp authentication
python manage.py startapp locations
python manage.py startapp audit</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¯Ù„â€ŒÙ‡Ø§ -->
        <div class="section" id="models">
            <div class="section-header">
                <h2><span class="icon">ğŸ—ƒï¸</span>Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Django</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡</h4>
                    <p>Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.</p>
                </div>

                <!-- Ù…Ø¯Ù„ Ú©Ø§Ø±Ø¨Ø± -->
                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/authentication/models.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from django.contrib.auth.models import AbstractUser
from django.contrib.gis.db import models
from django.core.validators import RegexValidator
import uuid


class CustomUser(AbstractUser):
    """Ù…Ø¯Ù„ Ú©Ø§Ø±Ø¨Ø± Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ
    national_code = models.CharField(
        max_length=10,
        unique=True,
        validators=[RegexValidator(r'^\d{10}$', 'Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯')]
    )
    phone_number = models.CharField(
        max_length=11,
        validators=[RegexValidator(r'^09\d{9}$', 'Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯')]
    )
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ
    employee_id = models.CharField(max_length=20, unique=True, null=True, blank=True)
    department = models.CharField(max_length=100, blank=True)
    position = models.CharField(max_length=100, blank=True)
    
    # ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨
    is_verified = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    last_login_ip = models.GenericIPAddressField(null=True, blank=True)
    
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
    failed_login_attempts = models.PositiveIntegerField(default=0)
    account_locked_until = models.DateTimeField(null=True, blank=True)
    password_changed_at = models.DateTimeField(auto_now_add=True)
    
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['username', 'national_code']
    
    class Meta:
        db_table = 'auth_users'
        verbose_name = 'Ú©Ø§Ø±Ø¨Ø±'
        verbose_name_plural = 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'
    
    def __str__(self):
        return f"{self.get_full_name()} ({self.email})"
    
    @property
    def is_account_locked(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù‚ÙÙ„ Ø¨ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨"""
        if self.account_locked_until:
            from django.utils import timezone
            return timezone.now() < self.account_locked_until
        return False


class Role(models.Model):
    """Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ"""
    
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    permissions = models.JSONField(default=dict)  # Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø®Ø§Øµ Ù†Ù‚Ø´
    
    # Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    default_read_access = models.BooleanField(default=True)
    default_write_access = models.BooleanField(default=False)
    default_delete_access = models.BooleanField(default=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'auth_roles'
        verbose_name = 'Ù†Ù‚Ø´'
        verbose_name_plural = 'Ù†Ù‚Ø´â€ŒÙ‡Ø§'
    
    def __str__(self):
        return self.name


class UserRole(models.Model):
    """Ø§Ø±ØªØ¨Ø§Ø· Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù†Ù‚Ø´"""
    
    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='user_roles')
    role = models.ForeignKey(Role, on_delete=models.CASCADE, related_name='role_users')
    
    # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ
    valid_from = models.DateTimeField()
    valid_until = models.DateTimeField(null=True, blank=True)
    
    # ÙˆØ¶Ø¹ÛŒØª
    is_active = models.BooleanField(default=True)
    assigned_by = models.ForeignKey(
        CustomUser, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='assigned_roles'
    )
    assigned_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'auth_user_roles'
        unique_together = ['user', 'role']
        verbose_name = 'Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±'
        verbose_name_plural = 'Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.role.name}"</code></pre>
                </div>

                <!-- Ù…Ø¯Ù„ Ù…Ú©Ø§Ù† -->
                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/locations/models.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from django.contrib.gis.db import models
from django.contrib.gis.geos import Point, Polygon
from django.core.exceptions import ValidationError
from apps.authentication.models import CustomUser
import uuid


class LocationHierarchy(models.Model):
    """Ø³Ù„Ø³Ù„Ù‡â€ŒÙ…Ø±Ø§ØªØ¨ Ù…Ú©Ø§Ù†ÛŒ"""
    
    LOCATION_TYPES = [
        ('city', 'Ø´Ù‡Ø±'),
        ('district', 'Ù…Ù†Ø·Ù‚Ù‡'),
        ('neighborhood', 'Ù…Ø­Ù„Ù‡'),
        ('street', 'Ø®ÛŒØ§Ø¨Ø§Ù†'),
        ('building', 'Ø³Ø§Ø®ØªÙ…Ø§Ù†'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=200)
    code = models.CharField(max_length=50, unique=True)
    type = models.CharField(max_length=20, choices=LOCATION_TYPES)
    
    # Ø³Ù„Ø³Ù„Ù‡â€ŒÙ…Ø±Ø§ØªØ¨
    parent = models.ForeignKey(
        'self', 
        on_delete=models.CASCADE, 
        null=True, 
        blank=True, 
        related_name='children'
    )
    level = models.PositiveIntegerField()  # Ø³Ø·Ø­ Ø¯Ø± Ø¯Ø±Ø®Øª
    path = models.CharField(max_length=500)  # Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
    geometry = models.GeometryField(null=True, blank=True)
    center_point = models.PointField(null=True, blank=True)
    area = models.FloatField(null=True, blank=True)  # Ù…Ø³Ø§Ø­Øª Ø¨Ù‡ Ù…ØªØ± Ù…Ø±Ø¨Ø¹
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ
    description = models.TextField(blank=True)
    metadata = models.JSONField(default=dict)
    
    # ÙˆØ¶Ø¹ÛŒØª
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_by = models.ForeignKey(
        CustomUser, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='created_locations'
    )
    
    class Meta:
        db_table = 'locations_hierarchy'
        verbose_name = 'Ù…Ú©Ø§Ù†'
        verbose_name_plural = 'Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§'
        indexes = [
            models.Index(fields=['parent', 'level']),
            models.Index(fields=['type', 'is_active']),
        ]
    
    def __str__(self):
        return f"{self.name} ({self.get_type_display()})"
    
    def save(self, *args, **kwargs):
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ùˆ Ù…Ø³ÛŒØ±
        if self.parent:
            self.level = self.parent.level + 1
            self.path = f"{self.parent.path}/{self.code}"
        else:
            self.level = 0
            self.path = self.code
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ Ù…Ø±Ú©Ø²ÛŒ Ø§Ø² geometry
        if self.geometry and not self.center_point:
            self.center_point = self.geometry.centroid
        
        super().save(*args, **kwargs)
    
    def get_ancestors(self):
        """Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… ÙˆØ§Ù„Ø¯ÛŒÙ†"""
        ancestors = []
        current = self.parent
        while current:
            ancestors.append(current)
            current = current.parent
        return ancestors
    
    def get_descendants(self):
        """Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… ÙØ±Ø²Ù†Ø¯Ø§Ù†"""
        return LocationHierarchy.objects.filter(
            path__startswith=f"{self.path}/",
            is_active=True
        )
    
    def is_within(self, other_location):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ù…Ú©Ø§Ù† Ø¯Ø±ÙˆÙ† Ù…Ú©Ø§Ù† Ø¯ÛŒÚ¯Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯"""
        if not self.geometry or not other_location.geometry:
            return False
        return other_location.geometry.contains(self.geometry)


class UserLocationAccess(models.Model):
    """Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù‡ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
    
    ACCESS_TYPES = [
        ('read', 'Ø®ÙˆØ§Ù†Ø¯Ù†'),
        ('write', 'Ù†ÙˆØ´ØªÙ†'),
        ('delete', 'Ø­Ø°Ù'),
        ('admin', 'Ù…Ø¯ÛŒØ±ÛŒØª'),
    ]
    
    user = models.ForeignKey(
        CustomUser, 
        on_delete=models.CASCADE, 
        related_name='location_accesses'
    )
    location = models.ForeignKey(
        LocationHierarchy, 
        on_delete=models.CASCADE, 
        related_name='user_accesses'
    )
    
    # Ø§Ù†ÙˆØ§Ø¹ Ø¯Ø³ØªØ±Ø³ÛŒ
    can_read = models.BooleanField(default=True)
    can_write = models.BooleanField(default=False)
    can_delete = models.BooleanField(default=False)
    can_admin = models.BooleanField(default=False)
    
    # Ø¯Ø³ØªØ±Ø³ÛŒ ÙÛŒÙ„Ø¯ÛŒ
    accessible_fields = models.JSONField(default=list)  # ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ
    restricted_fields = models.JSONField(default=list)  # ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯
    
    # Ø§Ø±Ø«â€ŒØ¨Ø±ÛŒ Ø¨Ù‡ ÙØ±Ø²Ù†Ø¯Ø§Ù†
    inherit_to_children = models.BooleanField(default=True)
    
    # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ
    valid_from = models.DateTimeField()
    valid_until = models.DateTimeField(null=True, blank=True)
    
    # ÙˆØ¶Ø¹ÛŒØª
    is_active = models.BooleanField(default=True)
    granted_by = models.ForeignKey(
        CustomUser, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='granted_accesses'
    )
    granted_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'location_user_accesses'
        unique_together = ['user', 'location']
        verbose_name = 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ'
        verbose_name_plural = 'Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ'
        indexes = [
            models.Index(fields=['user', 'is_active']),
            models.Index(fields=['location', 'inherit_to_children']),
        ]
    
    def __str__(self):
        return f"{self.user.get_full_name()} -> {self.location.name}"
    
    def clean(self):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        if self.valid_until and self.valid_from >= self.valid_until:
            raise ValidationError('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø¨Ø§Ø´Ø¯')
    
    @property
    def is_valid(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ"""
        from django.utils import timezone
        now = timezone.now()
        
        if not self.is_active:
            return False
        
        if self.valid_from > now:
            return False
        
        if self.valid_until and self.valid_until < now:
            return False
        
        return True</code></pre>
                </div>

                <!-- Ù…Ø¯Ù„ Audit -->
                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/audit/models.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from django.contrib.gis.db import models
from django.contrib.contenttypes.models import ContentType
from django.contrib.contenttypes.fields import GenericForeignKey
from apps.authentication.models import CustomUser
import uuid


class AuditLog(models.Model):
    """Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§"""
    
    ACTION_TYPES = [
        ('login', 'ÙˆØ±ÙˆØ¯'),
        ('logout', 'Ø®Ø±ÙˆØ¬'),
        ('create', 'Ø§ÛŒØ¬Ø§Ø¯'),
        ('read', 'Ø®ÙˆØ§Ù†Ø¯Ù†'),
        ('update', 'ÙˆÛŒØ±Ø§ÛŒØ´'),
        ('delete', 'Ø­Ø°Ù'),
        ('access_denied', 'Ø±Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ'),
        ('permission_changed', 'ØªØºÛŒÛŒØ± Ù…Ø¬ÙˆØ²'),
    ]
    
    RISK_LEVELS = [
        ('low', 'Ú©Ù…'),
        ('medium', 'Ù…ØªÙˆØ³Ø·'),
        ('high',
        ('high', 'Ø¨Ø§Ù„Ø§'),
        ('critical', 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
    user = models.ForeignKey(
        CustomUser, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='audit_logs'
    )
    user_email = models.EmailField()  # Ø°Ø®ÛŒØ±Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ÛŒØ§Øª
    action = models.CharField(max_length=50, choices=ACTION_TYPES)
    resource_type = models.CharField(max_length=100)  # Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹
    resource_id = models.CharField(max_length=100, blank=True)  # Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø¨Ø¹
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Generic Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡Ø± Ù…Ø¯Ù„
    content_type = models.ForeignKey(ContentType, on_delete=models.SET_NULL, null=True, blank=True)
    object_id = models.CharField(max_length=100, blank=True)
    content_object = GenericForeignKey('content_type', 'object_id')
    
    # Ø¬Ø²Ø¦ÛŒØ§Øª
    description = models.TextField()
    old_values = models.JSONField(default=dict, blank=True)  # Ù…Ù‚Ø§Ø¯ÛŒØ± Ù‚Ø¨Ù„ÛŒ
    new_values = models.JSONField(default=dict, blank=True)  # Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¬Ø¯ÛŒØ¯
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField(blank=True)
    request_path = models.CharField(max_length=500)
    request_method = models.CharField(max_length=10)
    
    # Ø³Ø·Ø­ Ø±ÛŒØ³Ú©
    risk_level = models.CharField(max_length=20, choices=RISK_LEVELS, default='low')
    
    # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'audit_logs'
        verbose_name = 'Ù„Ø§Ú¯ Ø§Ù…Ù†ÛŒØªÛŒ'
        verbose_name_plural = 'Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ'
        indexes = [
            models.Index(fields=['user', 'timestamp']),
            models.Index(fields=['action', 'timestamp']),
            models.Index(fields=['risk_level', 'timestamp']),
            models.Index(fields=['ip_address', 'timestamp']),
        ]
        ordering = ['-timestamp']
    
    def __str__(self):
        return f"{self.user_email} - {self.get_action_display()} - {self.timestamp}"


class SecurityAlert(models.Model):
    """Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ"""
    
    ALERT_TYPES = [
        ('suspicious_login', 'ÙˆØ±ÙˆØ¯ Ù…Ø´Ú©ÙˆÚ©'),
        ('multiple_failed_login', 'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ØªØ¹Ø¯Ø¯'),
        ('unauthorized_access', 'Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²'),
        ('data_breach_attempt', 'ØªÙ„Ø§Ø´ Ù†ÙÙˆØ° Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡'),
        ('unusual_activity', 'ÙØ¹Ø§Ù„ÛŒØª ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ'),
    ]
    
    SEVERITY_LEVELS = [
        ('info', 'Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ'),
        ('warning', 'Ù‡Ø´Ø¯Ø§Ø±'),
        ('error', 'Ø®Ø·Ø§'),
        ('critical', 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    alert_type = models.CharField(max_length=50, choices=ALERT_TYPES)
    severity = models.CharField(max_length=20, choices=SEVERITY_LEVELS)
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±ØªØ¨Ø·
    user = models.ForeignKey(CustomUser, on_delete=models.SET_NULL, null=True, blank=True)
    ip_address = models.GenericIPAddressField()
    
    # Ù¾ÛŒØ§Ù… Ùˆ Ø¬Ø²Ø¦ÛŒØ§Øª
    title = models.CharField(max_length=200)
    message = models.TextField()
    details = models.JSONField(default=dict)
    
    # ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´
    is_resolved = models.BooleanField(default=False)
    resolved_by = models.ForeignKey(
        CustomUser, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='resolved_alerts'
    )
    resolved_at = models.DateTimeField(null=True, blank=True)
    resolution_notes = models.TextField(blank=True)
    
    # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'security_alerts'
        verbose_name = 'Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ'
        verbose_name_plural = 'Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.title} - {self.get_severity_display()}"</code></pre>
                </div>

                <div class="explanation">
                    <h4>ğŸ’¡ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¯Ø± Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§:</h4>
                    <ul>
                        <li><span class="highlight">UUID</span> Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ±</li>
                        <li><span class="highlight">JSONField</span> Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±</li>
                        <li><span class="highlight">GeometryField</span> Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ GIS</li>
                        <li><span class="highlight">Index</span> Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§</li>
                        <li><span class="highlight">Soft Delete</span> Ø¨Ø§ ÙÛŒÙ„Ø¯ is_active</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø±Ù‡Ø§ -->
        <div class="section" id="serializers">
            <div class="section-header">
                <h2><span class="icon">ğŸ”„</span>Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø±Ù‡Ø§ÛŒ DRF</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ API</h4>
                    <p>Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø±Ù‡Ø§ Ù…Ø³Ø¦ÙˆÙ„ ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨ÛŒÙ† JSON Ùˆ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Django Ù‡Ø³ØªÙ†Ø¯.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/authentication/serializers.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from rest_framework import serializers
from django.contrib.auth import authenticate
from django.contrib.auth.password_validation import validate_password
from django.core.exceptions import ValidationError
from .models import CustomUser, Role, UserRole


class UserRegistrationSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±"""
    
    password = serializers.CharField(write_only=True, validators=[validate_password])
    password_confirm = serializers.CharField(write_only=True)
    
    class Meta:
        model = CustomUser
        fields = [
            'email', 'username', 'first_name', 'last_name',
            'national_code', 'phone_number', 'employee_id',
            'department', 'position', 'password', 'password_confirm'
        ]
        extra_kwargs = {
            'email': {'required': True},
            'first_name': {'required': True},
            'last_name': {'required': True},
        }
    
    def validate(self, attrs):
        if attrs['password'] != attrs['password_confirm']:
            raise serializers.ValidationError("Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯")
        return attrs
    
    def create(self, validated_data):
        validated_data.pop('password_confirm')
        password = validated_data.pop('password')
        
        user = CustomUser.objects.create_user(
            password=password,
            **validated_data
        )
        return user


class UserLoginSerializer(serializers.Serializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±"""
    
    email = serializers.EmailField()
    password = serializers.CharField(write_only=True)
    
    def validate(self, attrs):
        email = attrs.get('email')
        password = attrs.get('password')
        
        if email and password:
            user = authenticate(
                request=self.context.get('request'),
                username=email,
                password=password
            )
            
            if not user:
                raise serializers.ValidationError('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª')
            
            if not user.is_active:
                raise serializers.ValidationError('Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª')
            
            if user.is_account_locked:
                raise serializers.ValidationError('Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª')
            
            attrs['user'] = user
            return attrs
        
        raise serializers.ValidationError('Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª')


class UserProfileSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±"""
    
    full_name = serializers.SerializerMethodField()
    roles = serializers.SerializerMethodField()
    
    class Meta:
        model = CustomUser
        fields = [
            'id', 'email', 'username', 'first_name', 'last_name', 'full_name',
            'national_code', 'phone_number', 'employee_id', 'department', 
            'position', 'is_verified', 'last_login', 'roles'
        ]
        read_only_fields = ['id', 'email', 'is_verified', 'last_login']
    
    def get_full_name(self, obj):
        return obj.get_full_name()
    
    def get_roles(self, obj):
        active_roles = obj.user_roles.filter(
            is_active=True,
            valid_from__lte=timezone.now()
        ).filter(
            models.Q(valid_until__isnull=True) | 
            models.Q(valid_until__gte=timezone.now())
        )
        return [role.role.name for role in active_roles]


class RoleSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ù†Ù‚Ø´â€ŒÙ‡Ø§"""
    
    users_count = serializers.SerializerMethodField()
    
    class Meta:
        model = Role
        fields = [
            'id', 'name', 'description', 'permissions',
            'default_read_access', 'default_write_access', 
            'default_delete_access', 'users_count', 'created_at'
        ]
    
    def get_users_count(self, obj):
        return obj.role_users.filter(is_active=True).count()


class UserRoleSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± ØªØ®ØµÛŒØµ Ù†Ù‚Ø´ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±"""
    
    user_email = serializers.EmailField(source='user.email', read_only=True)
    user_name = serializers.CharField(source='user.get_full_name', read_only=True)
    role_name = serializers.CharField(source='role.name', read_only=True)
    assigned_by_name = serializers.CharField(source='assigned_by.get_full_name', read_only=True)
    
    class Meta:
        model = UserRole
        fields = [
            'id', 'user', 'user_email', 'user_name', 'role', 'role_name',
            'valid_from', 'valid_until', 'is_active', 'assigned_by', 
            'assigned_by_name', 'assigned_at'
        ]
        read_only_fields = ['assigned_by', 'assigned_at']
    
    def validate(self, attrs):
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¯Ø§Ø®Ù„ Ù†Ù‚Ø´â€ŒÙ‡Ø§
        user = attrs.get('user')
        role = attrs.get('role')
        valid_from = attrs.get('valid_from')
        valid_until = attrs.get('valid_until')
        
        if valid_until and valid_from >= valid_until:
            raise serializers.ValidationError('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø¨Ø§Ø´Ø¯')
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ù†Ù‚Ø´ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        existing_role = UserRole.objects.filter(
            user=user,
            role=role,
            is_active=True
        ).exclude(id=self.instance.id if self.instance else None)
        
        if existing_role.exists():
            raise serializers.ValidationError('Ø§ÛŒÙ† Ù†Ù‚Ø´ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª')
        
        return attrs</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/locations/serializers.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from rest_framework import serializers
from rest_framework_gis.serializers import GeoFeatureModelSerializer
from django.contrib.gis.geos import Point, Polygon
from .models import LocationHierarchy, UserLocationAccess


class LocationHierarchySerializer(GeoFeatureModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª GIS"""
    
    parent_name = serializers.CharField(source='parent.name', read_only=True)
    children_count = serializers.SerializerMethodField()
    full_path = serializers.SerializerMethodField()
    
    class Meta:
        model = LocationHierarchy
        geo_field = 'geometry'
        fields = [
            'id', 'name', 'code', 'type', 'parent', 'parent_name',
            'level', 'path', 'description', 'metadata', 'area',
            'children_count', 'full_path', 'is_active', 'created_at'
        ]
        read_only_fields = ['level', 'path', 'created_at']
    
    def get_children_count(self, obj):
        return obj.children.filter(is_active=True).count()
    
    def get_full_path(self, obj):
        """Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ Ù†Ø§Ù…â€ŒÙ‡Ø§"""
        path_names = []
        current = obj
        while current:
            path_names.append(current.name)
            current = current.parent
        return ' / '.join(reversed(path_names))
    
    def validate_geometry(self, value):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‡Ù†Ø¯Ø³Ù‡"""
        if value and not value.valid:
            raise serializers.ValidationError('Ù‡Ù†Ø¯Ø³Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª')
        return value
    
    def validate(self, attrs):
        parent = attrs.get('parent')
        location_type = attrs.get('type')
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø³Ù„Ù‡â€ŒÙ…Ø±Ø§ØªØ¨ ØµØ­ÛŒØ­
        type_hierarchy = {
            'city': None,
            'district': 'city',
            'neighborhood': 'district',
            'street': 'neighborhood',
            'building': 'street'
        }
        
        expected_parent_type = type_hierarchy.get(location_type)
        
        if expected_parent_type and (not parent or parent.type != expected_parent_type):
            raise serializers.ValidationError(
                f'Ù†ÙˆØ¹ ÙˆØ§Ù„Ø¯ Ø¨Ø±Ø§ÛŒ {location_type} Ø¨Ø§ÛŒØ¯ {expected_parent_type} Ø¨Ø§Ø´Ø¯'
            )
        
        if not expected_parent_type and parent:
            raise serializers.ValidationError(f'{location_type} Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙˆØ§Ù„Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯')
        
        return attrs


class LocationTreeSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ø¯Ø±Ø®ØªÛŒ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
    
    children = serializers.SerializerMethodField()
    
    class Meta:
        model = LocationHierarchy
        fields = ['id', 'name', 'code', 'type', 'level', 'children']
    
    def get_children(self, obj):
        if hasattr(obj, 'prefetched_children'):
            children = obj.prefetched_children
        else:
            children = obj.children.filter(is_active=True)
        
        return LocationTreeSerializer(children, many=True, context=self.context).data


class UserLocationAccessSerializer(serializers.ModelSerializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"""
    
    user_email = serializers.EmailField(source='user.email', read_only=True)
    user_name = serializers.CharField(source='user.get_full_name', read_only=True)
    location_name = serializers.CharField(source='location.name', read_only=True)
    location_path = serializers.CharField(source='location.path', read_only=True)
    granted_by_name = serializers.CharField(source='granted_by.get_full_name', read_only=True)
    
    access_summary = serializers.SerializerMethodField()
    
    class Meta:
        model = UserLocationAccess
        fields = [
            'id', 'user', 'user_email', 'user_name', 'location', 
            'location_name', 'location_path', 'can_read', 'can_write', 
            'can_delete', 'can_admin', 'accessible_fields', 'restricted_fields',
            'inherit_to_children', 'valid_from', 'valid_until', 'is_active',
            'granted_by', 'granted_by_name', 'granted_at', 'access_summary'
        ]
        read_only_fields = ['granted_by', 'granted_at']
    
    def get_access_summary(self, obj):
        """Ø®Ù„Ø§ØµÙ‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
        accesses = []
        if obj.can_read:
            accesses.append('Ø®ÙˆØ§Ù†Ø¯Ù†')
        if obj.can_write:
            accesses.append('Ù†ÙˆØ´ØªÙ†')
        if obj.can_delete:
            accesses.append('Ø­Ø°Ù')
        if obj.can_admin:
            accesses.append('Ù…Ø¯ÛŒØ±ÛŒØª')
        return ', '.join(accesses) if accesses else 'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªØ±Ø³ÛŒ'
    
    def validate(self, attrs):
        user = attrs.get('user')
        location = attrs.get('location')
        valid_from = attrs.get('valid_from')
        valid_until = attrs.get('valid_until')
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
        if valid_until and valid_from >= valid_until:
            raise serializers.ValidationError('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø¨Ø§Ø´Ø¯')
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ
        existing_access = UserLocationAccess.objects.filter(
            user=user,
            location=location,
            is_active=True
        ).exclude(id=self.instance.id if self.instance else None)
        
        if existing_access.exists():
            raise serializers.ValidationError('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ú©Ø§Ù† Ù‚Ø¨Ù„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª')
        
        return attrs


class LocationSearchSerializer(serializers.Serializer):
    """Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ²Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†ÛŒ"""
    
    query = serializers.CharField(max_length=200)
    location_type = serializers.ChoiceField(
        choices=LocationHierarchy.LOCATION_TYPES,
        required=False
    )
    parent_id = serializers.UUIDField(required=False)
    
    # Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
    latitude = serializers.FloatField(required=False)
    longitude = serializers.FloatField(required=False)
    radius = serializers.FloatField(required=False, min_value=0.1, max_value=50)  # Ú©ÛŒÙ„ÙˆÙ…ØªØ±
    
    def validate(self, attrs):
        # Ø§Ú¯Ø± Ù…Ø®ØªØµØ§Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ø´Ø¹Ø§Ø¹ Ù‡Ù… Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯
        if any([attrs.get('latitude'), attrs.get('longitude')]) and not attrs.get('radius'):
            raise serializers.ValidationError('Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†ÛŒØŒ Ø´Ø¹Ø§Ø¹ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª')
        
        if attrs.get('radius') and not all([attrs.get('latitude'), attrs.get('longitude')]):
            raise serializers.ValidationError('Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†ÛŒØŒ Ù…Ø®ØªØµØ§Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª')
        
        return attrs</code></pre>
                </div>
            </div>
        </div>

        <!-- ÙˆÛŒÙˆÙ‡Ø§ -->
        <div class="section" id="views">
            <div class="section-header">
                <h2><span class="icon">ğŸ‘ï¸</span>ÙˆÛŒÙˆÙ‡Ø§ÛŒ API</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>ÙˆÛŒÙˆÙ‡Ø§ÛŒ Django REST Framework</h4>
                    <p>ÙˆÛŒÙˆÙ‡Ø§ Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ API Ø±Ø§ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ùˆ Ø´Ø§Ù…Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ø³ØªÙ†Ø¯.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/authentication/views.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework_simplejwt.tokens import RefreshToken
from django.contrib.auth import login, logout
from django.utils import timezone
from django.db import transaction
from django.core.cache import cache
import logging

from .models import CustomUser, Role, UserRole
from .serializers import (
    UserRegistrationSerializer, UserLoginSerializer, 
    UserProfileSerializer, RoleSerializer, UserRoleSerializer
)
from apps.audit.models import AuditLog, SecurityAlert
from .utils import get_client_ip, detect_suspicious_activity

logger = logging.getLogger(__name__)


class UserRegistrationView(generics.CreateAPIView):
    """Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯"""
    
    queryset = CustomUser.objects.all()
    serializer_class = UserRegistrationSerializer
    permission_classes = [permissions.AllowAny]
    
    def perform_create(self, serializer):
        with transaction.atomic():
            user = serializer.save()
            
            # Ø«Ø¨Øª Ù„Ø§Ú¯
            AuditLog.objects.create(
                user=user,
                user_email=user.email,
                action='create',
                resource_type='User',
                resource_id=str(user.id),
                description=f'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯: {user.email}',
                ip_address=get_client_ip(self.request),
                user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
                request_path=self.request.path,
                request_method=self.request.method,
                risk_level='low'
            )
            
            logger.info(f'New user registered: {user.email}')


class UserLoginView(APIView):
    """ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¯Ø±ÛŒØ§ÙØª JWT Token"""
    
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = UserLoginSerializer(
            data=request.data, 
            context={'request': request}
        )
        
        if serializer.is_valid():
            user = serializer.validated_data['user']
            ip_address = get_client_ip(request)
            
            # Ø¨Ø±Ø±Ø³ÛŒ ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©
            if detect_suspicious_activity(user, ip_address):
                SecurityAlert.objects.create(
                    alert_type='suspicious_login',
                    severity='warning',
                    user=user,
                    ip_address=ip_address,
                    title='ÙˆØ±ÙˆØ¯ Ù…Ø´Ú©ÙˆÚ©',
                    message=f'ÙˆØ±ÙˆØ¯ Ø§Ø² IP Ø¬Ø¯ÛŒØ¯: {ip_address}',
                    details={'previous_ips': user.last_login_ip}
                )
            
            # ØªÙˆÙ„ÛŒØ¯ JWT Token
            refresh = RefreshToken.for_user(user)
            access_token = refresh.access_token
            
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            user.last_login_ip = ip_address
            user.failed_login_attempts = 0
            user.save(update_fields=['last_login_ip', 'failed_login_attempts'])
            
            # Ø«Ø¨Øª Ù„Ø§Ú¯ Ù…ÙˆÙÙ‚
            AuditLog.objects.create(
                user=user,
                user_email=user.email,
                action='login',
                resource_type='Authentication',
                description='ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚',
                ip_address=ip_address,
                user_agent=request.META.get('HTTP_USER_AGENT', ''),
                request_path=request.path,
                request_method=request.method,
                risk_level='low'
            )
            
            return Response({
                'access': str(access_token),
                'refresh': str(refresh),
                'user': UserProfileSerializer(user).data
            }, status=status.HTTP_200_OK)
        
        # ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚
        email = request.data.get('email')
        if email:
            try:
                user = CustomUser.objects.get(email=email)
                user.failed_login_attempts += 1
                
                # Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯ Ø§Ø² 5 ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚
                if user.failed_login_attempts >= 5:
                    user.account_locked_until = timezone.now() + timezone.timedelta(minutes=30)
                    
                    SecurityAlert.objects.create(
                        alert_type='multiple_failed_login',
                        severity='error',
                        user=user,
                        ip_address=get_client_ip(request),
                        title='Ø­Ø³Ø§Ø¨ Ù‚ÙÙ„ Ø´Ø¯',
                        message=f'Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ØªØ¹Ø¯Ø¯ Ù‚ÙÙ„ Ø´Ø¯',
                        details={'failed_attempts': user.failed_login_attempts}
                    )
                
                user.save(update_fields=['failed_login_attempts', 'account_locked_until'])
                
            except CustomUser.DoesNotExist:
                pass
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ Ù†Ø§Ù…ÙˆÙÙ‚
        AuditLog.objects.create(
            user_email=email or 'Ù†Ø§Ù…Ø´Ø®Øµ',
            action='login',
            resource_type='Authentication',
            description='ØªÙ„Ø§Ø´ ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚',
            ip_address=get_client_ip(request),
            user_agent=request.META.get('HTTP_USER_AGENT', ''),
            request_path=request.path,
            request_method=request.method,
            risk_level='medium'
        )
        
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


class UserLogoutView(APIView):
    """Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±"""
    
    permission_classes = [permissions.IsAuthenticated]
    
    def post(self, request):
        try:
            refresh_token = request.data.get('refresh')
            if refresh_token:
                token = RefreshToken(refresh_token)
                token.blacklist()
            
            # Ø«Ø¨Øª Ù„Ø§Ú¯ Ø®Ø±ÙˆØ¬
            AuditLog.objects.create(
                user=request.user,
                user_email=request.user.email,
                action='logout',
                resource_type='Authentication',
                description='Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚',
                ip_address=get_client_ip(request),
                user_agent=request.META.get('HTTP_USER_AGENT', ''),
                request_path=request.path,
                request_method=request.method,
                risk_level='low'
            )
            
            return Response({'message': 'Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚'}, status=status.HTTP_200_OK)
            
        except Exception as e:
            return Response({'error': 'Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬'}, status=status.HTTP_400_BAD_REQUEST)


class UserProfileView(generics.RetrieveUpdateAPIView):
    """Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±"""
    
    serializer_class = UserProfileSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_object(self):
        return self.request.user
    
    def perform_update(self, serializer):
        old_values = {}
        new_values = {}
        
        # Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ audit
        for field in serializer.validated_data:
            old_values[field] = getattr(self.request.user, field)
            new_values[field] = serializer.validated_data[field]
        
        user = serializer.save()
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ ØªØºÛŒÛŒØ±Ø§Øª
        AuditLog.objects.create(
            user=user,
            user_email=user.email,
            action='update',
            resource_type='User',
            resource_id=str(user.id),
            description='ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„',
            old_values=old_values,
            new_values=new_values,
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='low'
        )


class RoleListCreateView(generics.ListCreateAPIView):
    """Ù„ÛŒØ³Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´â€ŒÙ‡Ø§"""
    
    queryset = Role.objects.all()
    serializer_class = RoleSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        # ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¯ÛŒØ± Ù…ÛŒ
                      ØªÙˆØ§Ù†Ù†Ø¯ Ù†Ù‚Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ù†Ø¯
        if self.request.user.is_superuser:
            return Role.objects.all()
        return Role.objects.none()
    
    def perform_create(self, serializer):
        role = serializer.save()
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='create',
            resource_type='Role',
            resource_id=str(role.id),
            description=f'Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {role.name}',
            new_values=serializer.validated_data,
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='medium'
        )


class UserRoleAssignView(generics.CreateAPIView):
    """ØªØ®ØµÛŒØµ Ù†Ù‚Ø´ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±"""
    
    serializer_class = UserRoleSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def perform_create(self, serializer):
        user_role = serializer.save(assigned_by=self.request.user)
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ ØªØ®ØµÛŒØµ Ù†Ù‚Ø´
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='permission_changed',
            resource_type='UserRole',
            resource_id=str(user_role.id),
            description=f'Ù†Ù‚Ø´ {user_role.role.name} Ø¨Ù‡ {user_role.user.email} ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯',
            new_values={
                'user': user_role.user.email,
                'role': user_role.role.name,
                'valid_from': str(user_role.valid_from),
                'valid_until': str(user_role.valid_until) if user_role.valid_until else None
            },
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='high'
        )


@api_view(['GET'])
@permission_classes([permissions.IsAuthenticated])
def user_permissions_view(request):
    """Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ"""
    
    user = request.user
    permissions_data = {
        'user_id': str(user.id),
        'roles': [],
        'location_accesses': [],
        'system_permissions': {
            'is_superuser': user.is_superuser,
            'is_staff': user.is_staff,
            'is_verified': user.is_verified
        }
    }
    
    # Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
    active_roles = user.user_roles.filter(
        is_active=True,
        valid_from__lte=timezone.now()
    ).filter(
        models.Q(valid_until__isnull=True) | 
        models.Q(valid_until__gte=timezone.now())
    ).select_related('role')
    
    for user_role in active_roles:
        permissions_data['roles'].append({
            'name': user_role.role.name,
            'permissions': user_role.role.permissions,
            'valid_until': user_role.valid_until
        })
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ
    location_accesses = user.location_accesses.filter(
        is_active=True,
        valid_from__lte=timezone.now()
    ).filter(
        models.Q(valid_until__isnull=True) | 
        models.Q(valid_until__gte=timezone.now())
    ).select_related('location')
    
    for access in location_accesses:
        permissions_data['location_accesses'].append({
            'location_id': str(access.location.id),
            'location_name': access.location.name,
            'location_path': access.location.path,
            'can_read': access.can_read,
            'can_write': access.can_write,
            'can_delete': access.can_delete,
            'can_admin': access.can_admin,
            'accessible_fields': access.accessible_fields,
            'restricted_fields': access.restricted_fields
        })
    
    return Response(permissions_data)
</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/locations/views.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.contrib.gis.geos import Point
from django.contrib.gis.measure import Distance
from django.db.models import Q, Prefetch
from django.core.cache import cache
import logging

from .models import LocationHierarchy, UserLocationAccess
from .serializers import (
    LocationHierarchySerializer, LocationTreeSerializer,
    UserLocationAccessSerializer, LocationSearchSerializer
)
from .permissions import LocationPermission
from apps.audit.models import AuditLog
from apps.authentication.utils import get_client_ip

logger = logging.getLogger(__name__)


class LocationListCreateView(generics.ListCreateAPIView):
    """Ù„ÛŒØ³Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
    
    serializer_class = LocationHierarchySerializer
    permission_classes = [permissions.IsAuthenticated, LocationPermission]
    
    def get_queryset(self):
        queryset = LocationHierarchy.objects.filter(is_active=True)
        
        # ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        if not self.request.user.is_superuser:
            user_locations = UserLocationAccess.objects.filter(
                user=self.request.user,
                is_active=True,
                can_read=True
            ).values_list('location_id', flat=True)
            
            queryset = queryset.filter(id__in=user_locations)
        
        # ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ
        parent_id = self.request.query_params.get('parent')
        if parent_id:
            queryset = queryset.filter(parent_id=parent_id)
        
        location_type = self.request.query_params.get('type')
        if location_type:
            queryset = queryset.filter(type=location_type)
        
        return queryset.select_related('parent').order_by('level', 'name')
    
    def perform_create(self, serializer):
        location = serializer.save(created_by=self.request.user)
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ú©Ø§Ù†
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='create',
            resource_type='Location',
            resource_id=str(location.id),
            description=f'Ù…Ú©Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {location.name}',
            new_values={
                'name': location.name,
                'code': location.code,
                'type': location.type,
                'parent': str(location.parent.id) if location.parent else None
            },
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='medium'
        )


class LocationDetailView(generics.RetrieveUpdateDestroyAPIView):
    """Ø¬Ø²Ø¦ÛŒØ§ØªØŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù Ù…Ú©Ø§Ù†"""
    
    serializer_class = LocationHierarchySerializer
    permission_classes = [permissions.IsAuthenticated, LocationPermission]
    
    def get_queryset(self):
        return LocationHierarchy.objects.filter(is_active=True)
    
    def perform_update(self, serializer):
        old_values = {}
        new_values = {}
        
        # Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù‚Ø¨Ù„ÛŒ
        instance = self.get_object()
        for field in serializer.validated_data:
            old_values[field] = getattr(instance, field)
            new_values[field] = serializer.validated_data[field]
        
        location = serializer.save()
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ ÙˆÛŒØ±Ø§ÛŒØ´
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='update',
            resource_type='Location',
            resource_id=str(location.id),
            description=f'Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯: {location.name}',
            old_values=old_values,
            new_values=new_values,
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='medium'
        )
    
    def perform_destroy(self, instance):
        # Soft delete
        instance.is_active = False
        instance.save()
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ Ø­Ø°Ù
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='delete',
            resource_type='Location',
            resource_id=str(instance.id),
            description=f'Ù…Ú©Ø§Ù† Ø­Ø°Ù Ø´Ø¯: {instance.name}',
            old_values={'is_active': True},
            new_values={'is_active': False},
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='high'
        )


class LocationTreeView(APIView):
    """Ø¯Ø±Ø®Øª Ø³Ù„Ø³Ù„Ù‡â€ŒÙ…Ø±Ø§ØªØ¨ÛŒ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
    
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯
        cache_key = f"location_tree_{request.user.id}"
        cached_data = cache.get(cache_key)
        
        if cached_data:
            return Response(cached_data)
        
        # Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ´Ù‡
        root_locations = LocationHierarchy.objects.filter(
            parent__isnull=True,
            is_active=True
        ).prefetch_related(
            Prefetch(
                'children',
                queryset=LocationHierarchy.objects.filter(is_active=True),
                to_attr='prefetched_children'
            )
        )
        
        # ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        if not request.user.is_superuser:
            user_locations = UserLocationAccess.objects.filter(
                user=request.user,
                is_active=True,
                can_read=True
            ).values_list('location_id', flat=True)
            
            root_locations = root_locations.filter(id__in=user_locations)
        
        serializer = LocationTreeSerializer(root_locations, many=True)
        data = serializer.data
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´ Ø¨Ø±Ø§ÛŒ 15 Ø¯Ù‚ÛŒÙ‚Ù‡
        cache.set(cache_key, data, 900)
        
        return Response(data)


class LocationSearchView(APIView):
    """Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
    
    permission_classes = [permissions.IsAuthenticated]
    
    def post(self, request):
        serializer = LocationSearchSerializer(data=request.data)
        
        if serializer.is_valid():
            query = serializer.validated_data['query']
            location_type = serializer.validated_data.get('location_type')
            parent_id = serializer.validated_data.get('parent_id')
            latitude = serializer.validated_data.get('latitude')
            longitude = serializer.validated_data.get('longitude')
            radius = serializer.validated_data.get('radius')
            
            # Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø§ÛŒÙ‡
            queryset = LocationHierarchy.objects.filter(
                is_active=True,
                name__icontains=query
            )
            
            # ÙÛŒÙ„ØªØ± Ù†ÙˆØ¹ Ù…Ú©Ø§Ù†
            if location_type:
                queryset = queryset.filter(type=location_type)
            
            # ÙÛŒÙ„ØªØ± ÙˆØ§Ù„Ø¯
            if parent_id:
                queryset = queryset.filter(parent_id=parent_id)
            
            # Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
            if latitude and longitude and radius:
                point = Point(longitude, latitude)
                queryset = queryset.filter(
                    center_point__distance_lte=(point, Distance(km=radius))
                )
            
            # ÙÛŒÙ„ØªØ± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
            if not request.user.is_superuser:
                user_locations = UserLocationAccess.objects.filter(
                    user=request.user,
                    is_active=True,
                    can_read=True
                ).values_list('location_id', flat=True)
                
                queryset = queryset.filter(id__in=user_locations)
            
            # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬
            queryset = queryset[:50]
            
            serializer = LocationHierarchySerializer(queryset, many=True)
            return Response(serializer.data)
        
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


class UserLocationAccessListCreateView(generics.ListCreateAPIView):
    """Ù„ÛŒØ³Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ"""
    
    serializer_class = UserLocationAccessSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = UserLocationAccess.objects.filter(is_active=True)
        
        # ÙÙ‚Ø· Ù…Ø¯ÛŒØ±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù‡Ù…Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ù†Ø¯
        if not self.request.user.is_superuser:
            queryset = queryset.filter(user=self.request.user)
        
        # ÙÛŒÙ„ØªØ± Ú©Ø§Ø±Ø¨Ø±
        user_id = self.request.query_params.get('user')
        if user_id:
            queryset = queryset.filter(user_id=user_id)
        
        # ÙÛŒÙ„ØªØ± Ù…Ú©Ø§Ù†
        location_id = self.request.query_params.get('location')
        if location_id:
            queryset = queryset.filter(location_id=location_id)
        
        return queryset.select_related('user', 'location', 'granted_by')
    
    def perform_create(self, serializer):
        access = serializer.save(granted_by=self.request.user)
        
        # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡
        cache_key = f"location_tree_{access.user.id}"
        cache.delete(cache_key)
        
        # Ø«Ø¨Øª Ù„Ø§Ú¯ ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ
        AuditLog.objects.create(
            user=self.request.user,
            user_email=self.request.user.email,
            action='permission_changed',
            resource_type='LocationAccess',
            resource_id=str(access.id),
            description=f'Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ Ø¨Ù‡ {access.user.email} Ø¯Ø§Ø¯Ù‡ Ø´Ø¯',
            new_values={
                'user': access.user.email,
                'location': access.location.name,
                'can_read': access.can_read,
                'can_write': access.can_write,
                'can_delete': access.can_delete,
                'can_admin': access.can_admin
            },
            ip_address=get_client_ip(self.request),
            user_agent=self.request.META.get('HTTP_USER_AGENT', ''),
            request_path=self.request.path,
            request_method=self.request.method,
            risk_level='high'
        )


@api_view(['GET'])
@permission_classes([permissions.IsAuthenticated])
def user_accessible_locations(request):
    """Ø¯Ø±ÛŒØ§ÙØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±"""
    
    user = request.user
    
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø´
    cache_key = f"user_locations_{user.id}"
    cached_data = cache.get(cache_key)
    
    if cached_data:
        return Response(cached_data)
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
    direct_accesses = UserLocationAccess.objects.filter(
        user=user,
        is_active=True
    ).select_related('location')
    
    accessible_locations = []
    
    for access in direct_accesses:
        location_data = {
            'id': str(access.location.id),
            'name': access.location.name,
            'path': access.location.path,
            'type': access.location.type,
            'permissions': {
                'can_read': access.can_read,
                'can_write': access.can_write,
                'can_delete': access.can_delete,
                'can_admin': access.can_admin
            },
            'accessible_fields': access.accessible_fields,
            'restricted_fields': access.restricted_fields
        }
        
        accessible_locations.append(location_data)
        
        # Ø§Ú¯Ø± Ø§Ø±Ø«â€ŒØ¨Ø±ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ ÙØ±Ø²Ù†Ø¯Ø§Ù† Ø±Ø§ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if access.inherit_to_children:
            children = access.location.get_descendants()
            for child in children:
                child_data = {
                    'id': str(child.id),
                    'name': child.name,
                    'path': child.path,
                    'type': child.type,
                    'permissions': {
                        'can_read': access.can_read,
                        'can_write': access.can_write,
                        'can_delete': access.can_delete,
                        'can_admin': access.can_admin
                    },
                    'accessible_fields': access.accessible_fields,
                    'restricted_fields': access.restricted_fields,
                    'inherited_from': str(access.location.id)
                }
                accessible_locations.append(child_data)
    
    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´ Ø¨Ø±Ø§ÛŒ 10 Ø¯Ù‚ÛŒÙ‚Ù‡
    cache.set(cache_key, accessible_locations, 600)
    
    return Response(accessible_locations)
</code></pre>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¬ÙˆØ²Ù‡Ø§ -->
        <div class="section" id="permissions">
            <div class="section-header">
                <h2><span class="icon">ğŸ”</span>Ø³ÛŒØ³ØªÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h4>
                    <p>Ø³ÛŒØ³ØªÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ú©Ø§Ù† Ùˆ ÙÛŒÙ„Ø¯Ù‡Ø§.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/locations/permissions.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from rest_framework import permissions
from django.utils import timezone
from django.db.models import Q
from .models import UserLocationAccess
from apps.audit.models import AuditLog, SecurityAlert
from apps.authentication.utils import get_client_ip


class LocationPermission(permissions.BasePermission):
    """Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ"""
    
    def has_permission(self, request, view):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ú©Ù„ÛŒ"""
        if not request.user.is_authenticated:
            return False
        
        # Ø³ÙˆÙ¾Ø± ÛŒÙˆØ²Ø± Ù‡Ù…Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ø±Ø¯
        if request.user.is_superuser:
            return True
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        if request.method in permissions.SAFE_METHODS:
            return True  # Ø®ÙˆØ§Ù†Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø´Ø¯Ù‡
        
        # Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª ØªØºÛŒÛŒØ±ØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±
        return True
    
    def has_object_permission(self, request, view, obj):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ø±ÙˆÛŒ Ø´ÛŒØ¡ Ø®Ø§Øµ"""
        if request.user.is_superuser:
            return True
        
        # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ú©Ø§Ù†
        access = self._get_user_access(request.user, obj)
        
        if not access:
            # Ø«Ø¨Øª ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²
            self._log_unauthorized_access(request, obj)
            return False
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª
        if request.method in permissions.SAFE_METHODS:
            return access.can_read
        elif request.method in ['POST', 'PUT', 'PATCH']:
            return access.can_write
        elif request.method == 'DELETE':
            return access.can_delete
        
        return False
    
    def _get_user_access(self, user, location):
        """Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù…Ú©Ø§Ù†"""
        try:
            # Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
            access = UserLocationAccess.objects.get(
                user=user,
                location=location,
                is_active=True,
                valid_from__lte=timezone.now()
            )
            
            # Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§
            if access.valid_until and access.valid_until < timezone.now():
                return None
            
            return access
            
        except UserLocationAccess.DoesNotExist:
            # Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø±Ø«ÛŒ Ø§Ø² ÙˆØ§Ù„Ø¯ÛŒÙ†
            ancestors = location.get_ancestors()
            
            for ancestor in ancestors:
                try:
                    access = UserLocationAccess.objects.get(
                        user=user,
                        location=ancestor,
                        is_active=True,
                        inherit_to_children=True,
                        valid_from__lte=timezone.now()
                    )
                    
                    if not access.valid_until or access.valid_until >= timezone.now():
                        return access
                        
                except UserLocationAccess.DoesNotExist:
                    continue
            
            return None
    
    def _log_unauthorized_access(self, request, obj):
        """Ø«Ø¨Øª ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²"""
        AuditLog.objects.create(
            user=request.user,
            user_email=request.user.email,
            action='access_denied',
            resource_type='Location',
            resource_id=str(obj.id),
            description=f'ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ù…Ú©Ø§Ù†: {obj.name}',
            ip_address=get_client_ip(request),
            user_agent=request.META.get('HTTP_USER_AGENT', ''),
            request_path=request.path,
            request_method=request.method,
            risk_level='high'
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ
        SecurityAlert.objects.create(
            alert_type='unauthorized_access',
            severity='warning',
            user=request.user,
            ip_address=get_client_ip(request),
            title='ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²',
            message=f'Ú©Ø§Ø±Ø¨Ø± {request.user.email} ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ú©Ø§Ù† {obj.name} Ø±Ø§ Ø¯Ø§Ø´Øª',
            details={
                'location_id': str(obj.id),
                'location_name': obj.name,
                'method': request.method,
                'path': request.path
            }
        )


class FieldLevelPermission:
    """Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø± Ø³Ø·Ø­ ÙÛŒÙ„Ø¯"""
    
    def __init__(self, user, location):
        self.user = user
        self.location = location
        self.access = self._get_access()
    
    def _get_access(self):
        """Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±"""
        if self.user.is_superuser:
            return None  # Ø³ÙˆÙ¾Ø± ÛŒÙˆØ²Ø± Ù‡Ù…Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ø±Ø¯
        
        try:
            return UserLocationAccess.objects.get(
                user=self.user,
                location=self.location,
                is_active=True,
                valid_from__lte=timezone.now()
            )
        except UserLocationAccess.DoesNotExist:
            return None
    
    def can_access_field(self, field_name):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙÛŒÙ„Ø¯ Ø®Ø§Øµ"""
        if not self.access:
            return False
        
        # Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ø´Ø¯
        if field_name in self.access.restricted_fields:
            return False
        
        # Ø§Ú¯Ø± Ù„ÛŒØ³Øª ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if self.access.accessible_fields:
            return field_name in self.access.accessible_fields
        
        # Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¢Ø²Ø§Ø¯
        return True
    
    def filter_fields(self, data):
        """ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        if self.user.is_superuser:
            return data
        
        if not self.access:
            return {}
        
        filtered_data = {}
        
        for field_name, value in data.items():
            if self.can_access_field(field_name):
                filtered_data[field_name] = value
        
        return filtered_data


class RoleBasedPermission(permissions.BasePermission):
    """Ù…Ø¬ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù‚Ø´"""
    
    def has_permission(self, request, view):
        if not request.user.is_authenticated:
            return False
        
        if request.user.is_superuser:
            return True
        
        # Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø§Ø±Ø¨Ø±
        active_roles = request.user.user_roles.filter(
            is_active=True,
            valid_from__lte=timezone.now()
        ).filter(
            Q(valid_until__isnull=True) | 
            Q(valid_until__gte=timezone.now())
        )
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§
        for user_role in active_roles:
            role_permissions = user_role.role.permissions
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
            if request.method in permissions.SAFE_METHODS:
                if role_permissions.get('can_read', user_role.role.default_read_access):
                    return True
            elif request.method in ['POST', 'PUT', 'PATCH']:
                if role_permissions.get('can_write', user_role.role.default_write_access):
                    return True
            elif request.method == 'DELETE':
                if role_permissions.get('can_delete', user_role.role.default_delete_access):
                    return True
        
        return False


class IPWhitelistPermission(permissions.BasePermission):
    """Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ IP"""
    
    ALLOWED_IPS = [
        '127.0.0.1',
        '192.168.1.0/24',  # Ø´Ø¨Ú©Ù‡ Ø¯Ø§Ø®Ù„ÛŒ
        # IP Ù‡Ø§ÛŒ Ù…Ø¬Ø§Ø² Ø´Ù‡Ø±Ø¯Ø§Ø±ÛŒ
    ]
    
    def has_permission(self, request, view):
        client_ip = get_client_ip(request)
        
        # Ø¨Ø±Ø±Ø³ÛŒ IP Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø¬Ø§Ø²
        for allowed_ip in self.ALLOWED_IPS:
            if '/' in allowed_ip:  # CIDR notation
                from ipaddress import ip_network, ip_address
                if ip_address(client_ip) in ip_network(allowed_ip):
                    return True
            else:
                if client_ip == allowed_ip:
                    return True
        
        # Ø«Ø¨Øª ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² IP ØºÛŒØ±Ù…Ø¬Ø§Ø²
        SecurityAlert.objects.create(
            alert_type='unauthorized_access',
            severity='error',
            user=request.user if request.user.is_authenticated else None,
            ip_address=client_ip,
            title='Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² IP ØºÛŒØ±Ù…Ø¬Ø§Ø²',
            message=f'ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² IP ØºÛŒØ±Ù…Ø¬Ø§Ø²: {client_ip}',
            details={
                'path': request.path,
                'method': request.method,
                'user_agent': request.META.get('HTTP_USER_AGENT', '')
            }
        )
        
        return False


class TimeBasedPermission(permissions.BasePermission):
    """Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†"""
    
    ALLOWED_HOURS = range(8, 18)  # 8 ØµØ¨Ø­ ØªØ§ 6 Ø¹ØµØ±
    ALLOWED_DAYS = [0, 1, 2, 3, 4]  # Ø¯ÙˆØ´Ù†Ø¨Ù‡ ØªØ§ Ø¬Ù…Ø¹Ù‡
    
    def has_permission(self, request, view):
        from datetime import datetime
        import pytz
        
        # ØªÙ†Ø¸ÛŒÙ… Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§ÛŒØ±Ø§Ù†
        iran_tz = pytz.timezone('Asia/Tehran')
        now = datetime.now(iran_tz)
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ
        if now.hour not in self.ALLOWED_HOURS:
            return False
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ
        if now.weekday() not in self.ALLOWED_DAYS:
            return False
        
        return True
</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                 <span class="file-name">apps/authentication/utils.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">import re
import hashlib
from datetime import datetime, timedelta
from django.core.cache import cache
from django.conf import settings
from django.contrib.gis.geoip2 import GeoIP2
from django.core.exceptions import ValidationError
from user_agents import parse
import logging

logger = logging.getLogger(__name__)


def get_client_ip(request):
    """Ø¯Ø±ÛŒØ§ÙØª IP ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª"""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0].strip()
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip


def get_client_location(ip_address):
    """Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ IP"""
    try:
        g = GeoIP2()
        location = g.city(ip_address)
        return {
            'country': location.get('country_name'),
            'city': location.get('city'),
            'latitude': location.get('latitude'),
            'longitude': location.get('longitude')
        }
    except Exception as e:
        logger.warning(f"Could not get location for IP {ip_address}: {e}")
        return None


def parse_user_agent(user_agent_string):
    """ØªØ¬Ø²ÛŒÙ‡ User Agent"""
    try:
        user_agent = parse(user_agent_string)
        return {
            'browser': f"{user_agent.browser.family} {user_agent.browser.version_string}",
            'os': f"{user_agent.os.family} {user_agent.os.version_string}",
            'device': user_agent.device.family,
            'is_mobile': user_agent.is_mobile,
            'is_tablet': user_agent.is_tablet,
            'is_bot': user_agent.is_bot
        }
    except Exception as e:
        logger.warning(f"Could not parse user agent: {e}")
        return {}


def detect_suspicious_activity(user, ip_address):
    """ØªØ´Ø®ÛŒØµ ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©"""
    suspicious_indicators = []
    
    # Ø¨Ø±Ø±Ø³ÛŒ IP Ø¬Ø¯ÛŒØ¯
    if user.last_login_ip and user.last_login_ip != ip_address:
        suspicious_indicators.append('new_ip')
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
        current_location = get_client_location(ip_address)
        last_location = get_client_location(user.last_login_ip)
        
        if current_location and last_location:
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ (Ø³Ø§Ø¯Ù‡)
            if (current_location['country'] != last_location['country'] or 
                current_location['city'] != last_location['city']):
                suspicious_indicators.append('location_change')
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ
    now = datetime.now()
    if now.hour < 6 or now.hour > 22:  # Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø§Ø¹Ø§Øª Ø¹Ø§Ø¯ÛŒ
        suspicious_indicators.append('unusual_time')
    
    # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
    cache_key = f"login_attempts_{ip_address}"
    recent_attempts = cache.get(cache_key, 0)
    if recent_attempts > 3:
        suspicious_indicators.append('multiple_attempts')
    
    return len(suspicious_indicators) > 0


def validate_iranian_national_code(national_code):
    """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ"""
    if not national_code or len(national_code) != 10:
        raise ValidationError('Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯')
    
    if not national_code.isdigit():
        raise ValidationError('Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯')
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ø¹ØªØ¨Ø±
    invalid_codes = [
        '0000000000', '1111111111', '2222222222', '3333333333',
        '4444444444', '5555555555', '6666666666', '7777777777',
        '8888888888', '9999999999'
    ]
    
    if national_code in invalid_codes:
        raise ValidationError('Ú©Ø¯ Ù…Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª')
    
    # Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    check = 0
    for i in range(9):
        check += int(national_code[i]) * (10 - i)
    
    check = check % 11
    
    if check < 2:
        if int(national_code[9]) != check:
            raise ValidationError('Ú©Ø¯ Ù…Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª')
    else:
        if int(national_code[9]) != 11 - check:
            raise ValidationError('Ú©Ø¯ Ù…Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª')
    
    return national_code


def validate_iranian_phone_number(phone_number):
    """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø§ÛŒØ±Ø§Ù†ÛŒ"""
    # Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ
    phone_number = re.sub(r'[^\d+]', '', phone_number)
    
    # Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
    patterns = [
        r'^09\d{9}$',  # 09xxxxxxxxx
        r'^\+989\d{9}$',  # +989xxxxxxxxx
        r'^00989\d{9}$',  # 00989xxxxxxxxx
    ]
    
    for pattern in patterns:
        if re.match(pattern, phone_number):
            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙØ±Ù…Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
            if phone_number.startswith('+98'):
                return '0' + phone_number[3:]
            elif phone_number.startswith('0098'):
                return '0' + phone_number[4:]
            else:
                return phone_number
    
    raise ValidationError('Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª')


def generate_secure_token(length=32):
    """ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø§Ù…Ù†"""
    import secrets
    return secrets.token_urlsafe(length)


def hash_sensitive_data(data):
    """Ù‡Ø´ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³"""
    return hashlib.sha256(data.encode()).hexdigest()


def rate_limit_check(identifier, limit=5, window=300):
    """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
    cache_key = f"rate_limit_{identifier}"
    current_requests = cache.get(cache_key, 0)
    
    if current_requests >= limit:
        return False
    
    # Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    cache.set(cache_key, current_requests + 1, window)
    return True


def log_security_event(event_type, user, ip_address, details=None):
    """Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ"""
    from apps.audit.models import SecurityAlert
    
    SecurityAlert.objects.create(
        alert_type=event_type,
        severity='warning',
        user=user,
        ip_address=ip_address,
        title=f'Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ: {event_type}',
        message=f'Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user.email if user else "Ù†Ø§Ø´Ù†Ø§Ø³"}',
        details=details or {}
    )


class PasswordStrengthValidator:
    """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ Ù‚Ø¯Ø±Øª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"""
    
    def __init__(self, min_length=8):
        self.min_length = min_length
    
    def validate(self, password, user=None):
        errors = []
        
        # Ø·ÙˆÙ„ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
        if len(password) < self.min_length:
            errors.append(f'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ {self.min_length} Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯')
        
        # ÙˆØ¬ÙˆØ¯ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯
        if not re.search(r'[A-Z]', password):
            errors.append('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø­Ø±Ù Ø¨Ø²Ø±Ú¯ Ø¨Ø§Ø´Ø¯')
        
        # ÙˆØ¬ÙˆØ¯ Ø­Ø±ÙˆÙ Ú©ÙˆÚ†Ú©
        if not re.search(r'[a-z]', password):
            errors.append('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø­Ø±Ù Ú©ÙˆÚ†Ú© Ø¨Ø§Ø´Ø¯')
        
        # ÙˆØ¬ÙˆØ¯ Ø¹Ø¯Ø¯
        if not re.search(r'\d', password):
            errors.append('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯')
        
        # ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø§Øµ
        if not re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
            errors.append('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø§Øµ Ø¨Ø§Ø´Ø¯')
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¯Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
        if user:
            user_info = [
                user.email.split('@')[0].lower(),
                user.first_name.lower(),
                user.last_name.lower(),
                user.username.lower() if user.username else ''
            ]
            
            for info in user_info:
                if info and info in password.lower():
                    errors.append('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø¨Ø§Ø´Ø¯')
                    break
        
        if errors:
            raise ValidationError(errors)
    
    def get_help_text(self):
        return (
            f'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ {self.min_length} Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø´Ø§Ù…Ù„ '
            'Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ØŒ Ú©ÙˆÚ†Ú©ØŒ Ø¹Ø¯Ø¯ Ùˆ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø§Øµ Ø¨Ø§Ø´Ø¯'
        )


def check_password_breach(password):
    """Ø¨Ø±Ø±Ø³ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Øªâ€ŒÙ‡Ø§"""
    import hashlib
    import requests
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ SHA-1 hash
    sha1_hash = hashlib.sha1(password.encode()).hexdigest().upper()
    prefix = sha1_hash[:5]
    suffix = sha1_hash[5:]
    
    try:
        # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ø² Have I Been Pwned API
        response = requests.get(
            f'https://api.pwnedpasswords.com/range/{prefix}',
            timeout=5
        )
        
        if response.status_code == 200:
            hashes = response.text.split('\n')
            for hash_line in hashes:
                if ':' in hash_line:
                    hash_suffix, count = hash_line.split(':')
                    if hash_suffix == suffix:
                        return int(count)
        
        return 0
        
    except Exception as e:
        logger.warning(f"Could not check password breach: {e}")
        return 0


def generate_otp(length=6):
    """ØªÙˆÙ„ÛŒØ¯ Ø±Ù…Ø² ÛŒÚ©Ø¨Ø§Ø± Ù…ØµØ±Ù"""
    import random
    return ''.join([str(random.randint(0, 9)) for _ in range(length)])


def send_sms(phone_number, message):
    """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú©"""
    # Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
    # Ù…Ø«Ø§Ù„: Ú©Ø§ÙˆÙ‡ Ù†Ú¯Ø§Ø±ØŒ Ù…Ù„ÛŒ Ù¾ÛŒØ§Ù…Ú© Ùˆ ...
    
    try:
        # Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú©
        logger.info(f"SMS sent to {phone_number}: {message}")
        return True
    except Exception as e:
        logger.error(f"Failed to send SMS: {e}")
        return False


def send_email_notification(email, subject, message):
    """Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ"""
    from django.core.mail import send_mail
    from django.conf import settings
    
    try:
        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[email],
            fail_silently=False
        )
        return True
    except Exception as e:
        logger.error(f"Failed to send email: {e}")
        return False


class SessionManager:
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ"""
    
    @staticmethod
    def get_active_sessions(user):
        """Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø§Ø±Ø¨Ø±"""
        from django.contrib.sessions.models import Session
        from django.utils import timezone
        
        sessions = Session.objects.filter(expire_date__gte=timezone.now())
        user_sessions = []
        
        for session in sessions:
            data = session.get_decoded()
            if data.get('_auth_user_id') == str(user.id):
                user_sessions.append({
                    'session_key': session.session_key,
                    'expire_date': session.expire_date,
                    'ip_address': data.get('ip_address'),
                    'user_agent': data.get('user_agent')
                })
        
        return user_sessions
    
    @staticmethod
    def terminate_session(session_key):
        """Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù†Ø´Ø³Øª"""
        from django.contrib.sessions.models import Session
        
        try:
            session = Session.objects.get(session_key=session_key)
            session.delete()
            return True
        except Session.DoesNotExist:
            return False
    
    @staticmethod
    def terminate_all_sessions(user):
        """Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù‡Ù…Ù‡ Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±"""
        sessions = SessionManager.get_active_sessions(user)
        for session in sessions:
            SessionManager.terminate_session(session['session_key'])
        return len(sessions)
</code></pre>
                </div>
            </div>
        </div>

        <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
        <div class="section" id="settings">
            <div class="section-header">
                <h2><span class="icon">âš™ï¸</span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Django</h4>
                    <p>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø´Ø§Ù…Ù„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ØŒ Ú©Ø´ØŒ Ø§Ù…Ù†ÛŒØª Ùˆ JWT.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">config/settings/base.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">import os
from pathlib import Path
from datetime import timedelta

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY', 'your-secret-key-here')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'

ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')

# Application definition
DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.gis',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'rest_framework_gis',
    'rest_framework_simplejwt',
    'corsheaders',
    'django_filters',
    'drf_spectacular',
    'django_extensions',
]

LOCAL_APPS = [
    'apps.authentication',
    'apps.locations',
    'apps.audit',
    'apps.core',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'apps.core.middleware.AuditMiddleware',
    'apps.core.middleware.SecurityMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# Database
DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis',
        'NAME': os.environ.get('DB_NAME', 'location_auth_db'),
        'USER': os.environ.get('DB_USER', 'postgres'),
        'PASSWORD': os.environ.get('DB_PASSWORD', 'password'),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '5432'),
        'OPTIONS': {
            'sslmode': 'require' if not DEBUG else 'prefer',
        }
    }
}

# Cache Configuration
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.environ.get('REDIS_URL', 'redis://localhost:6379/1'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 20,
                'retry_on_timeout': True,
            }
        },
        'KEY_PREFIX': 'location_auth',
        'TIMEOUT': 300,  # 5 minutes default
    }
}

# Custom User Model
AUTH_USER_MODEL = 'authentication.CustomUser'

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
    {
        'NAME': 'apps.authentication.utils.PasswordStrengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
]

# Internationalization
LANGUAGE_CODE = 'fa-ir'
TIME_ZONE = 'Asia/Tehran'
USE_I18N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_DIRS = [
    BASE_DIR / 'static',
]

# Media files
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# Default primary key field type
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# REST Framework Configuration
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.MultiPartParser',
        'rest_framework.parsers.FormParser',
    ],
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
    'EXCEPTION_HANDLER': 'apps.core.exceptions.custom_exception_handler',
}

# JWT Configuration
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,
    
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'VERIFYING_KEY': None,
    'AUDIENCE': None,
    'ISSUER': None,
    
    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
    'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',
    
    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
    'TOKEN_TYPE_CLAIM': 'token_type',
    
    'JTI_CLAIM': 'jti',
    'SLIDING_TOKEN_REFRESH_EXP_CLAIM': 'refresh_exp',
    'SLIDING_TOKEN_LIFETIME': timedelta(minutes=60),
    'SLIDING_TOKEN_REFRESH_LIFETIME': timedelta(days=1),
}

# CORS Configuration
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",  # React development server
    "http://127.0.0.1:3000",
    "https://your-frontend-domain.com",
]

CORS_ALLOW_CREDENTIALS = True

# Security Settings
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_HSTS_SECONDS = 31536000 if not DEBUG else 0
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Session Configuration
SESSION_COOKIE_SECURE = not DEBUG
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_AGE = 3600  # 1 hour

CSRF_COOKIE_SECURE = not DEBUG
CSRF_COOKIE_HTTPONLY = True
CSRF_COOKIE_SAMESITE = 'Lax'

# Email Configuration
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = os.environ.get('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.environ.get('EMAIL_PORT', '587'))
EMAIL_USE_TLS = True
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', 'noreply@municipality.ir')

# Logging Configuration
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': BASE_DIR / 'logs' / 'django.log',
            'maxBytes': 1024*1024*15,  # 15MB
            'backupCount': 10,
            'formatter': 'verbose',
        },
        'security_file': {
            'level': 'WARNING',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': BASE_DIR / 'logs' / 'security.log',
            'maxBytes': 1024*1024*15,  # 15MB
            'backupCount': 10,
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'INFO',
            'propagate': True,
        },
        'apps.authentication': {
            'handlers': ['file', 'security_file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
        'apps.audit': {
            'handlers': ['security_file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}

# API Documentation
SPECTACULAR_SETTINGS = {
    'TITLE': 'Location-Based Authentication API',
    'DESCRIPTION': 'Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
    'COMPONENT_SPLIT_REQUEST': True,
    'SCHEMA_PATH_PREFIX': '/api/v1/',
}

# Custom Settings
MUNICIPALITY_SETTINGS = {
    'MAX_LOGIN_ATTEMPTS': 5,
    'ACCOUNT_LOCKOUT_DURATION': 30,  # minutes
    'PASSWORD_RESET_TIMEOUT': 3600,  # seconds
    'OTP_EXPIRY': 300,  # 5 minutes
    'SESSION_TIMEOUT': 3600,  # 1 hour
    'MAX_CONCURRENT_SESSIONS': 3,
    'ENABLE_GIS_FEATURES': True,
    'DEFAULT_LOCATION_RADIUS': 1000,  # meters
    'AUDIT_LOG_RETENTION_DAYS': 365,
    'SECURITY_ALERT_RETENTION_DAYS': 90,
}

# File Upload Settings
FILE_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB
FILE_UPLOAD_PERMISSIONS = 0o644

# GIS Settings
GDAL_LIBRARY_PATH = os.environ.get('GDAL_LIBRARY_PATH')
GEOS_LIBRARY_PATH = os.environ.get('GEOS_LIBRARY_PATH')

# Rate Limiting
RATELIMIT_ENABLE = True
RATELIMIT_USE_CACHE = 'default'
</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">config/settings/production.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from .base import *
import os

# Security Settings for Production
DEBUG = False

ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', '').split(',')

# Database with SSL
DATABASES['default'].update({
    'OPTIONS': {
        'sslmode': 'require',
        'sslcert': os.environ.get('DB_SSL_CERT'),
        'sslkey': os.environ.get('DB_SSL_KEY'),
        'sslrootcert': os.environ.get('DB_SSL_ROOT_CERT'),
    }
})

# Redis with SSL
CACHES['default']['LOCATION'] = os.environ.get('REDIS_URL')
CACHES['default']['OPTIONS'].update({
    'CONNECTION_POOL_KWARGS': {
        'ssl_cert_reqs': 'required',
        'ssl_ca_certs': os.environ.get('REDIS_SSL_CA_CERTS'),
    }
})

# Security Headers
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Session Security
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# CORS for Production
CORS_ALLOWED_ORIGINS = [
    "https://municipality-frontend.ir",
    "https://admin.municipality.ir",
]

# Logging for Production
LOGGING['handlers']['file']['filename'] = '/var/log/municipality/django.log'
LOGGING['handlers']['security_file']['filename'] = '/var/log/municipality/security.log'

# Remove console handler in production
LOGGING['loggers']['django']['handlers'] = ['file']
LOGGING['loggers']['apps.authentication']['handlers'] = ['file', 'security_file']
LOGGING['loggers']['apps.audit']['handlers'] = ['security_file']

# Static Files with CDN
STATIC_URL = 'https://cdn.municipality.ir/static/'
MEDIA_URL = 'https://cdn.municipality.ir/media/'

# Email with Production SMTP
EMAIL_HOST = os.environ.get('EMAIL_HOST')
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD')

# Performance Optimizations
CONN_MAX_AGE = 60

# Performance Optimizations
CONN_MAX_AGE = 60

# Sentry for Error Tracking
if os.environ.get('SENTRY_DSN'):
    import sentry_sdk
    from sentry_sdk.integrations.django import DjangoIntegration
    from sentry_sdk.integrations.redis import RedisIntegration
    
    sentry_sdk.init(
        dsn=os.environ.get('SENTRY_DSN'),
        integrations=[
            DjangoIntegration(auto_enabling=True),
            RedisIntegration(),
        ],
        traces_sample_rate=0.1,
        send_default_pii=True,
        environment='production'
    )

# File Storage with S3/MinIO
DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
STATICFILES_STORAGE = 'storages.backends.s3boto3.StaticS3Boto3Storage'

AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')
AWS_S3_ENDPOINT_URL = os.environ.get('AWS_S3_ENDPOINT_URL')  # For MinIO
AWS_S3_CUSTOM_DOMAIN = os.environ.get('AWS_S3_CUSTOM_DOMAIN')
AWS_DEFAULT_ACL = 'private'
AWS_S3_FILE_OVERWRITE = False
</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">config/urls.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

urlpatterns = [
    # Admin
    path('admin/', admin.site.urls),
    
    # API Documentation
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
    
    # API Routes
    path('api/v1/auth/', include('apps.authentication.urls')),
    path('api/v1/locations/', include('apps.locations.urls')),
    path('api/v1/audit/', include('apps.audit.urls')),
    
    # Health Check
    path('health/', include('apps.core.urls')),
]

# Serve media files in development
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

# Custom error handlers
handler400 = 'apps.core.views.bad_request'
handler403 = 'apps.core.views.permission_denied'
handler404 = 'apps.core.views.page_not_found'
handler500 = 'apps.core.views.server_error'
</code></pre>
                </div>
            </div>
        </div>

        <!-- Ù…ÛŒØ¯Ù„â€ŒÙˆØ± -->
        <div class="section" id="middleware">
            <div class="section-header">
                <h2><span class="icon">ğŸ”—</span>Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ø§Ù…Ù†ÛŒØªÛŒ</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ù…ÛŒØ§Ù†ÛŒ</h4>
                    <p>Ù…ÛŒØ¯Ù„â€ŒÙˆØ±Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø§Ù…Ù†ÛŒØªØŒ Ø«Ø¨Øª Ù„Ø§Ú¯ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øª.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">apps/core/middleware.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">import time
import json
import logging
from django.utils.deprecation import MiddlewareMixin
from django.core.cache import cache
from django.http import JsonResponse
from django.conf import settings
from django.utils import timezone
from apps.authentication.utils import get_client_ip, parse_user_agent
from apps.audit.models import AuditLog, SecurityAlert

logger = logging.getLogger(__name__)


class AuditMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ø«Ø¨Øª Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§"""
    
    def process_request(self, request):
        request.start_time = time.time()
        request.client_ip = get_client_ip(request)
        request.user_agent_info = parse_user_agent(
            request.META.get('HTTP_USER_AGENT', '')
        )
    
    def process_response(self, request, response):
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´
        if hasattr(request, 'start_time'):
            processing_time = time.time() - request.start_time
        else:
            processing_time = 0
        
        # Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…
        if self._should_log_request(request, response):
            self._log_request(request, response, processing_time)
        
        return response
    
    def _should_log_request(self, request, response):
        """ØªØ¹ÛŒÛŒÙ† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯ Ø´ÙˆØ¯ ÛŒØ§ Ù†Ù‡"""
        # Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚
        if response.status_code >= 400:
            return True
        
        # Ù„Ø§Ú¯ Ø¹Ù…Ù„ÛŒØ§Øª ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡
        if request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:
            return True
        
        # Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
        if '/auth/' in request.path:
            return True
        
        return False
    
    def _log_request(self, request, response, processing_time):
        """Ø«Ø¨Øª Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
        try:
            # ØªØ¹ÛŒÛŒÙ† Ø³Ø·Ø­ Ø±ÛŒØ³Ú©
            risk_level = 'low'
            if response.status_code >= 500:
                risk_level = 'high'
            elif response.status_code >= 400:
                risk_level = 'medium'
            elif request.method in ['POST', 'PUT', 'PATCH', 'DELETE']:
                risk_level = 'medium'
            
            # Ø«Ø¨Øª Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
            AuditLog.objects.create(
                user=request.user if request.user.is_authenticated else None,
                user_email=request.user.email if request.user.is_authenticated else None,
                action='http_request',
                resource_type='HTTP',
                description=f'{request.method} {request.path}',
                ip_address=request.client_ip,
                user_agent=request.META.get('HTTP_USER_AGENT', ''),
                request_path=request.path,
                request_method=request.method,
                response_status=response.status_code,
                processing_time=processing_time,
                risk_level=risk_level,
                details={
                    'query_params': dict(request.GET),
                    'content_type': request.content_type,
                    'response_size': len(response.content) if hasattr(response, 'content') else 0,
                    'user_agent_info': request.user_agent_info
                }
            )
            
        except Exception as e:
            logger.error(f"Failed to log request: {e}")


class SecurityMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ø§Ù…Ù†ÛŒØªÛŒ"""
    
    def process_request(self, request):
        client_ip = get_client_ip(request)
        
        # Ø¨Ø±Ø±Ø³ÛŒ IP Ø¯Ø± Ù„ÛŒØ³Øª Ø³ÛŒØ§Ù‡
        if self._is_blacklisted_ip(client_ip):
            return JsonResponse({
                'error': 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø§ÛŒÙ† IP Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª'
            }, status=403)
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        if not self._check_rate_limit(request):
            return JsonResponse({
                'error': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø¨ÛŒØ´ØªØ± Ø§Ø³Øª'
            }, status=429)
        
        # Ø¨Ø±Ø±Ø³ÛŒ User Agent Ù…Ø´Ú©ÙˆÚ©
        if self._is_suspicious_user_agent(request):
            self._log_suspicious_activity(request, 'suspicious_user_agent')
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©
        if self._is_suspicious_request(request):
            self._log_suspicious_activity(request, 'suspicious_request')
        
        return None
    
    def _is_blacklisted_ip(self, ip):
        """Ø¨Ø±Ø±Ø³ÛŒ IP Ø¯Ø± Ù„ÛŒØ³Øª Ø³ÛŒØ§Ù‡"""
        blacklist_key = f"blacklist_ip_{ip}"
        return cache.get(blacklist_key, False)
    
    def _check_rate_limit(self, request):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
        client_ip = get_client_ip(request)
        
        # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ú©Ù„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ IP
        ip_key = f"rate_limit_ip_{client_ip}"
        ip_requests = cache.get(ip_key, 0)
        
        if ip_requests >= 100:  # 100 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
            return False
        
        cache.set(ip_key, ip_requests + 1, 60)  # 1 Ø¯Ù‚ÛŒÙ‚Ù‡
        
        # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø´Ø¯Ù‡
        if request.user.is_authenticated:
            user_key = f"rate_limit_user_{request.user.id}"
            user_requests = cache.get(user_key, 0)
            
            if user_requests >= 200:  # 200 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
                return False
            
            cache.set(user_key, user_requests + 1, 60)
        
        return True
    
    def _is_suspicious_user_agent(self, request):
        """ØªØ´Ø®ÛŒØµ User Agent Ù…Ø´Ú©ÙˆÚ©"""
        user_agent = request.META.get('HTTP_USER_AGENT', '').lower()
        
        suspicious_patterns = [
            'bot', 'crawler', 'spider', 'scraper',
            'curl', 'wget', 'python-requests',
            'sqlmap', 'nikto', 'nmap'
        ]
        
        for pattern in suspicious_patterns:
            if pattern in user_agent:
                return True
        
        return False
    
    def _is_suspicious_request(self, request):
        """ØªØ´Ø®ÛŒØµ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø´Ú©ÙˆÚ©"""
        # Ø¨Ø±Ø±Ø³ÛŒ SQL Injection
        sql_patterns = [
            'union select', 'drop table', 'insert into',
            'update set', 'delete from', 'exec(',
            'script>', '<iframe', 'javascript:'
        ]
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± query parameters
        for key, value in request.GET.items():
            for pattern in sql_patterns:
                if pattern in str(value).lower():
                    return True
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± POST data
        if request.method == 'POST' and hasattr(request, 'body'):
            try:
                body = request.body.decode('utf-8').lower()
                for pattern in sql_patterns:
                    if pattern in body:
                        return True
            except:
                pass
        
        return False
    
    def _log_suspicious_activity(self, request, activity_type):
        """Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©"""
        SecurityAlert.objects.create(
            alert_type=activity_type,
            severity='warning',
            user=request.user if request.user.is_authenticated else None,
            ip_address=get_client_ip(request),
            title=f'ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©: {activity_type}',
            message=f'ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ© Ø§Ø² IP {get_client_ip(request)} Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯',
            details={
                'path': request.path,
                'method': request.method,
                'user_agent': request.META.get('HTTP_USER_AGENT', ''),
                'query_params': dict(request.GET),
                'referer': request.META.get('HTTP_REFERER', '')
            }
        )


class SessionSecurityMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ø§Ù…Ù†ÛŒØª Ù†Ø´Ø³Øª"""
    
    def process_request(self, request):
        if request.user.is_authenticated:
            # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ± IP
            session_ip = request.session.get('ip_address')
            current_ip = get_client_ip(request)
            
            if session_ip and session_ip != current_ip:
                # IP ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø¬Ø¯Ø¯
                self._log_ip_change(request, session_ip, current_ip)
                
                # Ø¯Ø± ØµÙˆØ±Øª ØªÙ†Ø¸ÛŒÙ… Ø³Ø®ØªÚ¯ÛŒØ±Ø§Ù†Ù‡ØŒ Ù†Ø´Ø³Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
                if getattr(settings, 'STRICT_IP_CHECK', False):
                    request.session.flush()
                    return JsonResponse({
                        'error': 'Ù†Ø´Ø³Øª Ø´Ù…Ø§ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØªØºÛŒÛŒØ± IP Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯'
                    }, status=401)
            
            # Ø°Ø®ÛŒØ±Ù‡ IP ÙØ¹Ù„ÛŒ
            request.session['ip_address'] = current_ip
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù†Ø´Ø³Øª
            last_activity = request.session.get('last_activity')
            if last_activity:
                from datetime import datetime
                last_time = datetime.fromisoformat(last_activity)
                timeout = getattr(settings, 'SESSION_TIMEOUT', 3600)
                
                if (timezone.now() - last_time).seconds > timeout:
                    request.session.flush()
                    return JsonResponse({
                        'error': 'Ù†Ø´Ø³Øª Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª'
                    }, status=401)
            
            # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª
            request.session['last_activity'] = timezone.now().isoformat()
    
    def _log_ip_change(self, request, old_ip, new_ip):
        """Ø«Ø¨Øª Ù„Ø§Ú¯ ØªØºÛŒÛŒØ± IP"""
        AuditLog.objects.create(
            user=request.user,
            user_email=request.user.email,
            action='ip_changed',
            resource_type='Session',
            description=f'IP Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ø§Ø² {old_ip} Ø¨Ù‡ {new_ip}',
            ip_address=new_ip,
            user_agent=request.META.get('HTTP_USER_AGENT', ''),
            request_path=request.path,
            request_method=request.method,
            risk_level='medium',
            old_values={'ip_address': old_ip},
            new_values={'ip_address': new_ip}
        )


class CORSSecurityMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ø§Ù…Ù†ÛŒØª CORS"""
    
    def process_response(self, request, response):
        # ØªÙ†Ø¸ÛŒÙ… Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'
        
        # Content Security Policy
        csp = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self'; "
            "connect-src 'self'; "
            "frame-ancestors 'none';"
        )
        response['Content-Security-Policy'] = csp
        
        return response


class RequestSizeMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
    
    MAX_REQUEST_SIZE = 10 * 1024 * 1024  # 10MB
    
    def process_request(self, request):
        if hasattr(request, 'META'):
            content_length = request.META.get('CONTENT_LENGTH')
            
            if content_length and int(content_length) > self.MAX_REQUEST_SIZE:
                return JsonResponse({
                    'error': 'Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª'
                }, status=413)
        
        return None


class GeoLocationMiddleware(MiddlewareMixin):
    """Ù…ÛŒØ¯Ù„â€ŒÙˆØ± Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ"""
    
    def process_request(self, request):
        if request.user.is_authenticated:
            client_ip = get_client_ip(request)
            
            # Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø§Ø² IP
            try:
                from apps.authentication.utils import get_client_location
                location = get_client_location(client_ip)
                
                if location:
                    request.geo_location = location
                    
                    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù†Ø´Ø³Øª
                    request.session['geo_location'] = location
                    
                    # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
                    if hasattr(request.user, 'allowed_countries'):
                        allowed_countries = request.user.allowed_countries or []
                        if (allowed_countries and 
                            location.get('country') not in allowed_countries):
                            
                            return JsonResponse({
                                'error': 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø§ÛŒÙ† Ú©Ø´ÙˆØ± Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª'
                            }, status=403)
            
            except Exception as e:
                logger.warning(f"Could not get geo location: {e}")
        
        return None
</code></pre>
                </div>
            </div>
        </div>

        <!-- ØªØ³Øªâ€ŒÙ‡Ø§ -->
        <div class="section" id="tests">
            <div class="section-header">
                <h2><span class="icon">ğŸ§ª</span>ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹</h4>
                    <p>Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ù…Ù„ÛŒ Ø§Ø² ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ØŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ùˆ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©ÛŒÙÛŒØª Ø³ÛŒØ³ØªÙ….</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">tests/test_authentication.py</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-python">import pytest
from django.test import TestCase, TransactionTestCase
from django.contrib.auth import get_user_model
from django.urls import reverse
from rest_framework.test import APITestCase, APIClient
from rest_framework import status
from unittest.mock import patch, Mock
from datetime import datetime, timedelta
from django.utils import timezone

from apps.authentication.models import CustomUser, Role, UserRole
from apps.locations.models import LocationHierarchy, UserLocationAccess
from apps.audit.models import AuditLog, SecurityAlert

User = get_user_model()


class UserModelTest(TestCase):
    """ØªØ³Øª Ù…Ø¯Ù„ Ú©Ø§Ø±Ø¨Ø±"""
    
    def setUp(self):
        self.user_data = {
            'email': 'test@municipality.ir',
            'password': 'TestPass123!',
            'first_name': 'Ø¹Ù„ÛŒ',
            'last_name': 'Ø§Ø­Ù…Ø¯ÛŒ',
            'national_code': '1234567890',
            'phone_number': '09123456789',
            'employee_id': 'EMP001'
        }
    
    def test_create_user(self):
        """ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±"""
        user = User.objects.create_user(**self.user_data)
        
        self.assertEqual(user.email, self.user_data['email'])
        self.assertTrue(user.check_password(self.user_data['password']))
        self.assertFalse(user.is_superuser)
        self.assertFalse(user.is_staff)
        self.assertTrue(user.is_active)
    
    def test_create_superuser(self):
        """ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙˆÙ¾Ø± ÛŒÙˆØ²Ø±"""
        user = User.objects.create_superuser(
            email='admin@municipality.ir',
            password='AdminPass123!'
        )
        
        self.assertTrue(user.is_superuser)
        self.assertTrue(user.is_staff)
    
    def test_email_normalization(self):
        """ØªØ³Øª Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§ÛŒÙ…ÛŒÙ„"""
        user = User.objects.create_user(
            email='Test@Municipality.IR',
            password='TestPass123!'
        )
        
        self.assertEqual(user.email, 'test@municipality.ir')
    
    def test_national_code_validation(self):
        """ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ù…Ù„ÛŒ"""
        # Ú©Ø¯ Ù…Ù„ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
        invalid_data = self.user_data.copy()
        invalid_data['national_code'] = '1234567891'
        
        with self.assertRaises(Exception):
            User.objects.create_user(**invalid_data)
    
    def test_phone_number_validation(self):
        """ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†"""
        # Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
        invalid_data = self.user_data.copy()
        invalid_data['phone_number'] = '123456789'
        
        with self.assertRaises(Exception):
            User.objects.create_user(**invalid_data)


class AuthenticationAPITest(APITestCase):
    """ØªØ³Øª API Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª"""
    
    def setUp(self):
        self.client = APIClient()
        self.register_url = reverse('authentication:register')
        self.login_url = reverse('authentication:login')
        self.refresh_url = reverse('authentication:token_refresh')
        
        self.user_data = {
            'email': 'test@municipality.ir',
            'password': 'TestPass123!',
            'first_name': 'Ø¹Ù„ÛŒ',
            'last_name': 'Ø§Ø­Ù…Ø¯ÛŒ',
            'national_code': '0123456789',
            'phone_number': '09123456789'
        }
    
    def test_user_registration(self):
        """ØªØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±"""
        response = self.client.post(self.register_url, self.user_data)
        
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertTrue(User.objects.filter(email=self.user_data['email']).exists())
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª Ù„Ø§Ú¯
        self.assertTrue(
            AuditLog.objects.filter(
                action='create',
                resource_type='User'
            ).exists()
        )
    
    def test_user_login(self):
        """ØªØ³Øª ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±"""
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
        user = User.objects.create_user(**self.user_data)
        user.is_verified = True
        user.save()
        
        # ØªØ³Øª ÙˆØ±ÙˆØ¯
        login_data = {
            'email': self.user_data['email'],
            'password': self.user_data['password']
        }
        
        response = self.client.post(self.login_url, login_data)
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('access', response.data)
        self.assertIn('refresh', response.data)
    
    def test_login_with_invalid_credentials(self):
        """ØªØ³Øª ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±"""
        login_data = {
            'email': 'wrong@email.com',
            'password': 'wrongpassword'
        }
        
        response = self.client.post(self.login_url, login_data)
        
        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)
    
    def test_token_refresh(self):
        """ØªØ³Øª ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÙˆÚ©Ù†"""
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ ÙˆØ±ÙˆØ¯
        user = User.objects.create_user(**self.user_data)
        user.is_verified = True
        user.save()
        
        login_response = self.client.post(self.login_url, {
            'email': self.user_data['email'],
            'password': self.user_data['password']
        })
        
        refresh_token = login_response.data['refresh']
        
        # ØªØ³Øª ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ
        refresh_response = self.client.post(self.refresh_url, {
            'refresh': refresh_token
        })
        
        self.assertEqual(refresh_response.status_code, status.HTTP_200_OK)
        self.assertIn('access', refresh_response.data)
    
    @patch('apps.authentication.utils.send_sms')
    def test_otp_verification(self, mock_send_sms):
        """ØªØ³Øª ØªØ§ÛŒÛŒØ¯ OTP"""
        mock_send_sms.return_value = True
        
        # Ø¯Ø±Ø®ÙˆØ§Ø³Øª OTP
        otp_request_url = reverse('authentication:request_otp')
        response = self.client.post(otp_request_url, {
            'phone_number': '09123456789'
        })
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        mock_send_sms.assert_called_once()
    
    def test_rate_limiting(self):
        """ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
        # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯
        for _ in range(6):  # Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø²
            response = self.client.post(self.login_url, {
                'email': 'test@test.com',
                'password': 'wrongpass'
            })
        
        # Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ Ù…Ø­Ø¯ÙˆØ¯ Ø´ÙˆØ¯
        self.assertEqual(response.status_code, status.HTTP_429_TOO_MANY_REQUESTS)


class LocationPermissionTest(APITestCase):
    """ØªØ³Øª Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ"""
    
    def setUp(self):
        self.client = APIClient()
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        self.admin_user = User.objects.create_user(
            email='admin@municipality.ir',
            password='AdminPass123!',
            is_superuser=True
        )
        
        self.regular_user = User.objects.create_user(
            email='user@municipality.ir',
            password='UserPass123!'
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§
        self.city = LocationHierarchy.objects.create(
            name='ØªÙ‡Ø±Ø§Ù†',
            code='THR',
            type='city',
            level=1
        )
        
        self.district = LocationHierarchy.objects.create(
            name='Ù…Ù†Ø·Ù‚Ù‡ Û±',
            code='D01',
            type='district',
            level=2,
            parent=self.city
        )
        
        # ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ
        UserLocationAccess.objects.create(
            user=self.regular_user,
            location=self.district,
            can_read=True,
            can_write=False,
            granted_by=self.admin_user
        )
    
    def test_admin_access_all_locations(self):
        """ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡ Ù‡Ù…Ù‡ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
        self.client.force_authenticate(user=self.admin_user)
        
        url = reverse('locations:location-list')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data['results']), 2)
    
    def test_user_access_permitted_locations_only(self):
        """ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· Ø¨Ù‡ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²"""
        self.client.force_authenticate(user=self.regular_user)
        
        url = reverse('locations:location-list')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data['results']), 1)
        self.assertEqual(response.data['results'][0]['name'], 'Ù…Ù†Ø·Ù‚Ù‡ Û±')
    
    def test_user_cannot_write_without_permission(self):
        """ØªØ³Øª Ø¹Ø¯Ù… Ø§Ù…Ú©Ø§Ù† Ù†ÙˆØ´ØªÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø¬ÙˆØ²"""
        self.client.force_authenticate(user=self.regular_user)
        
        url = reverse('locations:location-detail', kwargs={'pk': self.district.id})
        response = self.client.patch(url, {'name': 'Ù…Ù†Ø·Ù‚Ù‡ Ø¬Ø¯ÛŒØ¯'})
        
        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)
    
    def test_inherited_permissions(self):
        """ØªØ³Øª Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø§Ø±Ø«ÛŒ"""
        # ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø´Ù‡Ø± Ø¨Ø§ Ø§Ø±Ø«â€ŒØ¨Ø±ÛŒ
        UserLocationAccess.objects.create(
            user=self.regular_user,
            location=self.city,
            can_read=True,
            can_write=True,
            inherit_to_children=True,
            granted_by=self.admin_user
        )
        
        self.client.force_authenticate(user=self.regular_user)
        
        # Ø¨Ø§ÛŒØ¯ Ø¨ØªÙˆØ§Ù†Ø¯ Ù…Ù†Ø·Ù‚Ù‡ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ø¯
        url = reverse('locations:location-detail', kwargs={'pk': self.district.id})
        response = self.client.patch(url, {'name': 'Ù…Ù†Ø·Ù‚Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡'})
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)


class SecurityTest(TransactionTestCase):
    """ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ"""
    
    def setUp(self):
        self.client = APIClient()
       self.user = User.objects.create_user(
            email='test@municipality.ir',
            password='TestPass123!',
            is_verified=True
        )
    
    def test_sql_injection_protection(self):
        """ØªØ³Øª Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± SQL Injection"""
        self.client.force_authenticate(user=self.user)
        
        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ SQL Injection
        malicious_data = {
            'name': "'; DROP TABLE auth_user; --",
            'code': 'TEST'
        }
        
        url = reverse('locations:location-list')
        response = self.client.post(url, malicious_data)
        
        # Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø¯ØŒ Ù†Ù‡ Ø®Ø·Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
        self.assertIn(response.status_code, [400, 403])
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø¬Ø¯ÙˆÙ„ Ù‡Ù†ÙˆØ² Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
        self.assertTrue(User.objects.filter(id=self.user.id).exists())
    
    def test_xss_protection(self):
        """ØªØ³Øª Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± XSS"""
        self.client.force_authenticate(user=self.user)
        
        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ XSS
        malicious_data = {
            'name': '<script>alert("XSS")</script>',
            'code': 'TEST'
        }
        
        url = reverse('locations:location-list')
        response = self.client.post(url, malicious_data)
        
        if response.status_code == 201:
            # Ø§Ú¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù…Ø­ØªÙˆØ§ escape Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            location_id = response.data['id']
            location_url = reverse('locations:location-detail', kwargs={'pk': location_id})
            get_response = self.client.get(location_url)
            
            self.assertNotIn('<script>', str(get_response.data))
    
    def test_csrf_protection(self):
        """ØªØ³Øª Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± CSRF"""
        # Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø¯ÙˆÙ† CSRF token
        client = APIClient(enforce_csrf_checks=True)
        
        response = client.post('/api/v1/auth/login/', {
            'email': 'test@test.com',
            'password': '[REDACTED]'
        })
        
        # Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ CSRF Ø¨Ø±Ú¯Ø±Ø¯Ø¯ (Ø¯Ø± ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†)
        self.assertIn(response.status_code, [403, 401])
    
    def test_brute_force_protection(self):
        """ØªØ³Øª Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø­Ù…Ù„Ù‡ Brute Force"""
        # ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡
        for i in range(6):
            response = self.client.post('/api/v1/auth/login/', {
                'email': self.user.email,
                'password': f'wrongpass{i}'
            })
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø­Ø³Ø§Ø¨ Ù‚ÙÙ„ Ø´Ø¯Ù‡ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡
        self.assertIn(response.status_code, [429, 423])
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ
        self.assertTrue(
            SecurityAlert.objects.filter(
                alert_type='multiple_failed_logins'
            ).exists()
        )
    
    @patch('apps.authentication.utils.get_client_location')
    def test_geo_location_restriction(self, mock_geo):
        """ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ"""
        # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª ØºÛŒØ±Ù…Ø¬Ø§Ø²
        mock_geo.return_value = {
            'country': 'China',
            'city': 'Beijing'
        }
        
        # ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        self.user.allowed_countries = ['Iran']
        self.user.save()
        
        self.client.force_authenticate(user=self.user)
        
        response = self.client.get('/api/v1/locations/')
        
        # Ø¨Ø§ÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø´ÙˆØ¯
        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)
    
    def test_sensitive_data_masking(self):
        """ØªØ³Øª Ù¾ÙˆØ´Ø§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³ Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§"""
        # ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
        response = self.client.post('/api/v1/auth/login/', {
            'email': self.user.email,
            'password': 'TestPass123!'
        })
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡
        audit_logs = AuditLog.objects.filter(
            user=self.user,
            action='login'
        )
        
        for log in audit_logs:
            self.assertNotIn('TestPass123!', str(log.details))
            self.assertNotIn('password', str(log.details))


class PerformanceTest(APITestCase):
    """ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯"""
    
    def setUp(self):
        self.client = APIClient()
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª
        self.user = User.objects.create_user(
            email='perf@municipality.ir',
            password='[REDACTED]',
            is_verified=True
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
        self.create_test_data()
    
    def create_test_data(self):
        """Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯"""
        # Ø§ÛŒØ¬Ø§Ø¯ 1000 Ù…Ú©Ø§Ù†
        locations = []
        for i in range(1000):
            locations.append(LocationHierarchy(
                name=f'Ù…Ú©Ø§Ù† {i}',
                code=f'LOC{i:04d}',
                type='building',
                level=3
            ))
        
        LocationHierarchy.objects.bulk_create(locations)
        
        # Ø§ÛŒØ¬Ø§Ø¯ 100 Ú©Ø§Ø±Ø¨Ø±
        users = []
        for i in range(100):
            users.append(User(
                email=f'user{i}@municipality.ir',
                first_name=f'Ú©Ø§Ø±Ø¨Ø±{i}',
                last_name='ØªØ³Øª'
            ))
        
        User.objects.bulk_create(users)
    
    def test_location_list_performance(self):
        """ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"""
        self.client.force_authenticate(user=self.user)
        
        import time
        start_time = time.time()
        
        response = self.client.get('/api/v1/locations/')
        
        end_time = time.time()
        response_time = end_time - start_time
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertLess(response_time, 1.0)  # Ú©Ù…ØªØ± Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡
    
    def test_pagination_performance(self):
        """ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ"""
        self.client.force_authenticate(user=self.user)
        
        # ØªØ³Øª ØµÙØ­Ø§Øª Ù…Ø®ØªÙ„Ù
        for page in [1, 5, 10]:
            start_time = time.time()
            
            response = self.client.get(f'/api/v1/locations/?page={page}')
            
            end_time = time.time()
            response_time = end_time - start_time
            
            self.assertEqual(response.status_code, status.HTTP_200_OK)
            self.assertLess(response_time, 0.5)  # Ú©Ù…ØªØ± Ø§Ø² Ù†ÛŒÙ… Ø«Ø§Ù†ÛŒÙ‡
    
    def test_search_performance(self):
        """ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¬Ø³ØªØ¬Ùˆ"""
        self.client.force_authenticate(user=self.user)
        
        search_terms = ['Ù…Ú©Ø§Ù†', 'LOC0001', 'ØªØ³Øª']
        
        for term in search_terms:
            start_time = time.time()
            
            response = self.client.get(f'/api/v1/locations/?search={term}')
            
            end_time = time.time()
            response_time = end_time - start_time
            
            self.assertEqual(response.status_code, status.HTTP_200_OK)
            self.assertLess(response_time, 0.8)  # Ú©Ù…ØªØ± Ø§Ø² 0.8 Ø«Ø§Ù†ÛŒÙ‡
    
    def test_concurrent_requests(self):
        """ØªØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†"""
        import threading
        import time
        
        results = []
        
        def make_request():
            client = APIClient()
            client.force_authenticate(user=self.user)
            
            start_time = time.time()
            response = client.get('/api/v1/locations/')
            end_time = time.time()
            
            results.append({
                'status': response.status_code,
                'time': end_time - start_time
            })
        
        # Ø§ÛŒØ¬Ø§Ø¯ 10 thread Ù‡Ù…Ø²Ù…Ø§Ù†
        threads = []
        for _ in range(10):
            thread = threading.Thread(target=make_request)
            threads.append(thread)
        
        # Ø´Ø±ÙˆØ¹ Ù‡Ù…Ù‡ thread Ù‡Ø§
        start_time = time.time()
        for thread in threads:
            thread.start()
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù† Ù‡Ù…Ù‡ thread Ù‡Ø§
        for thread in threads:
            thread.join()
        
        total_time = time.time() - start_time
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬
        self.assertEqual(len(results), 10)
        for result in results:
            self.assertEqual(result['status'], 200)
            self.assertLess(result['time'], 2.0)
        
        self.assertLess(total_time, 5.0)  # Ú©Ù„ ÙØ±Ø¢ÛŒÙ†Ø¯ Ú©Ù…ØªØ± Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡


class IntegrationTest(TransactionTestCase):
    """ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ"""
    
    def setUp(self):
        self.client = APIClient()
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø¯Ù…ÛŒÙ†
        self.admin = User.objects.create_user(
            email='admin@municipality.ir',
            password='AdminPass123!',
            is_superuser=True,
            is_verified=True
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ
        self.user = User.objects.create_user(
            email='user@municipality.ir',
            password='[REDACTED]',
            is_verified=True
        )
    
    def test_complete_user_workflow(self):
        """ØªØ³Øª Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±"""
        # 1. Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
        register_data = {
            'email': 'newuser@municipality.ir',
            'password': 'NewPass123!',
            'first_name': 'Ú©Ø§Ø±Ø¨Ø±',
            'last_name': 'Ø¬Ø¯ÛŒØ¯',
            'national_code': '0123456789',
            'phone_number': '09123456789'
        }
        
        response = self.client.post('/api/v1/auth/register/', register_data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        
        # 2. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø³Ø§Ø¨ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
        new_user = User.objects.get(email=register_data['email'])
        new_user.is_verified = True
        new_user.save()
        
        # 3. ÙˆØ±ÙˆØ¯
        login_response = self.client.post('/api/v1/auth/login/', {
            'email': register_data['email'],
            'password': register_data['password']
        })
        self.assertEqual(login_response.status_code, status.HTTP_200_OK)
        
        # 4. Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ API Ø¨Ø§ ØªÙˆÚ©Ù†
        access_token = login_response.data['access']
        self.client.credentials(HTTP_AUTHORIZATION=f'Bearer {access_token}')
        
        profile_response = self.client.get('/api/v1/auth/profile/')
        self.assertEqual(profile_response.status_code, status.HTTP_200_OK)
        
        # 5. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
        update_response = self.client.patch('/api/v1/auth/profile/', {
            'first_name': 'Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡'
        })
        self.assertEqual(update_response.status_code, status.HTTP_200_OK)
        
        # 6. Ø®Ø±ÙˆØ¬
        logout_response = self.client.post('/api/v1/auth/logout/', {
            'refresh': login_response.data['refresh']
        })
        self.assertEqual(logout_response.status_code, status.HTTP_200_OK)
    
    def test_location_permission_workflow(self):
        """ØªØ³Øª Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒ"""
        self.client.force_authenticate(user=self.admin)
        
        # 1. Ø§ÛŒØ¬Ø§Ø¯ Ù…Ú©Ø§Ù† ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
        location_data = {
            'name': 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÛŒ Ù…Ù†Ø·Ù‚Ù‡ Û±',
            'code': 'MUN01',
            'type': 'municipality',
            'level': 1
        }
        
        location_response = self.client.post('/api/v1/locations/', location_data)
        self.assertEqual(location_response.status_code, status.HTTP_201_CREATED)
        location_id = location_response.data['id']
        
        # 2. ØªØ®ØµÛŒØµ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        access_data = {
            'user': self.user.id,
            'location': location_id,
            'can_read': True,
            'can_write': False,
            'can_delete': False
        }
        
        access_response = self.client.post('/api/v1/locations/access/', access_data)
        self.assertEqual(access_response.status_code, status.HTTP_201_CREATED)
        
        # 3. ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        self.client.force_authenticate(user=self.user)
        
        # Ø®ÙˆØ§Ù†Ø¯Ù† - Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
        read_response = self.client.get(f'/api/v1/locations/{location_id}/')
        self.assertEqual(read_response.status_code, status.HTTP_200_OK)
        
        # Ù†ÙˆØ´ØªÙ† - Ø¨Ø§ÛŒØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
        write_response = self.client.patch(f'/api/v1/locations/{location_id}/', {
            'name': 'Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯'
        })
        self.assertEqual(write_response.status_code, status.HTTP_403_FORBIDDEN)
        
        # 4. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬ÙˆØ² ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
        self.client.force_authenticate(user=self.admin)
        
        access_id = access_response.data['id']
        update_access_response = self.client.patch(f'/api/v1/locations/access/{access_id}/', {
            'can_write': True
        })
        self.assertEqual(update_access_response.status_code, status.HTTP_200_OK)
        
        # 5. ØªØ³Øª Ù…Ø¬Ø¯Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
        self.client.force_authenticate(user=self.user)
        
        # Ù†ÙˆØ´ØªÙ† - Ø­Ø§Ù„Ø§ Ø¨Ø§ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
        write_response2 = self.client.patch(f'/api/v1/locations/{location_id}/', {
            'name': 'Ù†Ø§Ù… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡'
        })
        self.assertEqual(write_response2.status_code, status.HTTP_200_OK)
    
    def test_audit_logging_integration(self):
        """ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯"""
        self.client.force_authenticate(user=self.user)
        
        # Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø®ØªÙ„Ù
        operations = [
            ('GET', '/api/v1/auth/profile/'),
            ('PATCH', '/api/v1/auth/profile/', {'first_name': 'Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯'}),
            ('GET', '/api/v1/locations/'),
        ]
        
        for method, url, data in operations:
            if method == 'GET':
                response = self.client.get(url)
            elif method == 'PATCH':
                response = self.client.patch(url, data or {})
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯Ù‡
            audit_log = AuditLog.objects.filter(
                user=self.user,
                request_path=url,
                request_method=method
            ).first()
            
            self.assertIsNotNone(audit_log)
            self.assertEqual(audit_log.response_status, response.status_code)


@pytest.mark.django_db
class APIDocumentationTest:
    """ØªØ³Øª Ù…Ø³ØªÙ†Ø¯Ø§Øª API"""
    
    def test_schema_generation(self, client):
        """ØªØ³Øª ØªÙˆÙ„ÛŒØ¯ schema"""
        response = client.get('/api/schema/')
        assert response.status_code == 200
        
        schema = response.json()
        assert 'openapi' in schema
        assert 'paths' in schema
        assert 'components' in schema
    
    def test_swagger_ui_accessible(self, client):
        """ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Swagger UI"""
        response = client.get('/api/docs/')
        assert response.status_code == 200
        assert 'swagger' in response.content.decode().lower()
    
    def test_api_endpoints_documented(self, client):
        """ØªØ³Øª Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ endpoint Ù‡Ø§"""
        response = client.get('/api/schema/')
        schema = response.json()
        
        required_endpoints = [
            '/api/v1/auth/login/',
            '/api/v1/auth/register/',
            '/api/v1/auth/profile/',
            '/api/v1/locations/',
            '/api/v1/audit/logs/'
        ]
        
        for endpoint in required_endpoints:
            assert endpoint in schema['paths']


class LoadTest(APITestCase):
    """ØªØ³Øª Ø¨Ø§Ø±"""
    
    def setUp(self):
        self.client = APIClient()
        self.user = User.objects.create_user(
            email='load@municipality.ir',
            password='[REDACTED]',
            is_verified=True
        )
    
    @pytest.mark.slow
    def test_high_load_authentication(self):
        """ØªØ³Øª Ø¨Ø§Ø± Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª"""
        import time
        import statistics
        
        response_times = []
        
        for i in range(100):  # 100 Ø¯Ø±Ø®ÙˆØ§Ø³Øª
            start_time = time.time()
            
            response = self.client.post('/api/v1/auth/login/', {
                'email': self.user.email,
                'password': '[REDACTED]'
            })
            
            end_time = time.time()
            response_times.append(end_time - start_time)
            
            self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        # ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯
        avg_time = statistics.mean(response_times)
        max_time = max(response_times)
        min_time = min(response_times)
        
        print(f"Authentication Load Test Results:")
        print(f"Average response time: {avg_time:.3f}s")
        print(f"Max response time: {max_time:.3f}s")
        print(f"Min response time: {min_time:.3f}s")
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø¨Ø§Ø´Ø¯
        self.assertLess(avg_time, 0.5)  # Ú©Ù…ØªØ± Ø§Ø² Ù†ÛŒÙ… Ø«Ø§Ù†ÛŒÙ‡
        self.assertLess(max_time, 2.0)   # Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ø«Ø§Ù†ÛŒÙ‡
    
    @pytest.mark.slow
    def test_memory_usage_under_load(self):
        """ØªØ³Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ ØªØ­Øª Ø¨Ø§Ø±"""
        import psutil
        import os
        
        process = psutil.Process(os.getpid())
        initial_memory = process.memory_info().rss
        
        # Ø§Ù†Ø¬Ø§Ù… 500 Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        self.client.force_authenticate(user=self.user)
        
        for i in range(500):
            response = self.client.get('/api/v1/locations/')
            self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        final_memory = process.memory_info().rss
        memory_increase = final_memory - initial_memory
        
        print(f"Memory usage increase: {memory_increase / 1024 / 1024:.2f} MB")
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø§ÙØ²Ø§ÛŒØ´ Ø­Ø§ÙØ¸Ù‡ Ù…Ø¹Ù‚ÙˆÙ„ Ø¨Ø§Ø´Ø¯ (Ú©Ù…ØªØ± Ø§Ø² 100 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)
        self.assertLess(memory_increase, 100 * 1024 * 1024)


# ØªÙ†Ø¸ÛŒÙ…Ø§Øª pytest
pytest_plugins = ['pytest_django']

def pytest_configure(config):
    """ØªÙ†Ø¸ÛŒÙ…Ø§Øª pytest"""
    import django
    from django.conf import settings
    
    if not settings.configured:
        settings.configure(
            DEBUG=True,
            DATABASES={
                'default': {
                    'ENGINE': 'django.contrib.gis.db.backends.postgis',
                    'NAME': ':memory:',
                }
            },
            INSTALLED_APPS=[
                'django.contrib.auth',
                'django.contrib.contenttypes',
                'django.contrib.gis',
                'rest_framework',
                'apps.authentication',
                'apps.locations',
                'apps.audit',
            ],
            SECRET_KEY='test-secret-key',
            USE_TZ=True,
        )
    
    django.setup()
</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">pytest.ini</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-ini">[tool:pytest]
DJANGO_SETTINGS_MODULE = config.settings.test
python_files = tests.py test_*.py *_tests.py
python_classes = Test* *Test *Tests
python_functions = test_*
addopts = 
    --verbose
    --tb=short
    --strict-markers
    --disable-warnings
    --cov=apps
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=80
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    security: marks tests as security tests
    performance: marks tests as performance tests
testpaths = tests
filterwarnings =
    ignore::django.utils.deprecation.RemovedInDjango40Warning
    ignore::django.utils.deprecation.RemovedInDjango41Warning
</code></pre>
                </div>
            </div>
        </div>

        <!-- Ù…Ø³ØªÙ†Ø¯Ø§Øª -->
        <div class="section" id="documentation">
            <div class="section-header">
                <h2><span class="icon">ğŸ“š</span>Ù…Ø³ØªÙ†Ø¯Ø§Øª Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
            </div>
            <div class="section-content">
                <div class="explanation">
                    <h4>Ù…Ø³ØªÙ†Ø¯Ø§Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</h4>
                    <p>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ù†ØµØ¨ØŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ú©Ø§Ù†ÛŒ.</p>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="file-name">README.md</span>
                        <button class="copy-btn" onclick="copyCode(this)">Ú©Ù¾ÛŒ</button>
                    </div>
                    <pre><code class="language-markdown"># Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ

## ğŸ›ï¸ Ù…Ø¹Ø±ÙÛŒ Ù¾Ø±ÙˆÚ˜Ù‡

Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ ÛŒÚ© Ø±Ø§Ù‡â€ŒØ­Ù„ Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ùˆ Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø§Ø³Øª. Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ù…Ø§Ù†Ù†Ø¯ Ø´Ù‡Ø±Ø¯Ø§Ø±ÛŒâ€ŒÙ‡Ø§ØŒ Ø¨Ø§Ù†Ú©â€ŒÙ‡Ø§ Ùˆ Ù…Ø±Ø§Ú©Ø² Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.

## âœ¨ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

### ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡
- Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú†Ù†Ø¯Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ (MFA)
- ØªØ§ÛŒÛŒØ¯ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø§ SMS/Email
- Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†
- Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² JWT Token

### ğŸ—ºï¸ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒ
- Ø³Ù„Ø³Ù„Ù‡ Ù…Ø±Ø§ØªØ¨ Ù…Ú©Ø§Ù†ÛŒ Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…
- Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø§Ø±Ø«ÛŒ
- Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø± Ø³Ø·Ø­ ÙÛŒÙ„Ø¯
- Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ IP

### ğŸ›¡ï¸ Ø§Ù…Ù†ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡
- Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø­Ù…Ù„Ø§Øª Ø±Ø§ÛŒØ¬ (SQL Injection, XSS, CSRF)
- Ø³ÛŒØ³ØªÙ… ØªØ´Ø®ÛŒØµ Ù†ÙÙˆØ°
- Rate Limiting Ù‡ÙˆØ´Ù…Ù†Ø¯
- Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³

### ğŸ“Š Ù†Ø¸Ø§Ø±Øª Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
- Ø«Ø¨Øª Ú©Ø§Ù…Ù„ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
- Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
- Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯

## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…
              
                          â€Œ
